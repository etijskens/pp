

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>et_micc.project &mdash; et_micc 1.1.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> et_micc
          

          
          </a>

          
            
            
              <div class="version">
                1.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Micc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apps.html">Applications (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devenv.html">Development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../links.html">Interesting links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">et_micc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>et_micc.project</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for et_micc.project</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module et_micc.project</span>
<span class="sd">======================</span>

<span class="sd">An OO interface to *micc* projects.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">xor</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">semantic_version</span>

<span class="kn">import</span> <span class="nn">et_micc.utils</span>
<span class="kn">import</span> <span class="nn">et_micc.expand</span>
<span class="kn">import</span> <span class="nn">et_micc.logger</span>
<span class="kn">from</span> <span class="nn">et_micc</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="c1"># from et_micc.db import Database</span>

<span class="n">CURRENT_ET_MICC_BUILD_VERSION</span> <span class="o">=</span> <span class="n">__version__</span>


<span class="k">def</span> <span class="nf">micc_version</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">__version__</span>


<div class="viewcode-block" id="Project"><a class="viewcode-back" href="../../api.html#et_micc.project.Project">[docs]</a><span class="k">class</span> <span class="nc">Project</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An OO interface to *micc* projects.</span>

<span class="sd">    :param types.SimpleNameSpace options: all options from the ``micc`` CLI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">project_path</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;template_parameters&#39;</span><span class="p">):</span>
            <span class="c1"># only needed for expanding templates.</span>
            <span class="c1"># Pick up the default parameters</span>
            <span class="n">default_parameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">template_parameters_json</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;micc.json&#39;</span>
            <span class="k">if</span> <span class="n">template_parameters_json</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">default_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">get_template_parameters</span><span class="p">(</span><span class="n">template_parameters_json</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">preferences</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">get_preferences</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">preferences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Micc has not been set up yet: the preferences file &#39;~/.et_micc/micc.json&#39; was not found).</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Run &#39;micc setup&#39; to create it.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;If you do not have a github account yet, you might want to create one first at:</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;    https://github.com/join&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">default_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">get_template_parameters</span><span class="p">(</span><span class="n">preferences</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># Add options.template_parameters to the default parameters</span>
            <span class="c1"># (options.template_parameters takes precedence, so they must be added last)</span>
            <span class="n">default_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">)</span>
            <span class="c1"># Store all the parameters in options.template_parameters.</span>
            <span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span> <span class="o">=</span> <span class="n">default_parameters</span>

        <span class="k">if</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">is_project_directory</span><span class="p">(</span><span class="n">project_path</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="c1"># existing project</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;poetry&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not a project directory or not a directory at all</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">project_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">project_path</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot create project in (</span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;  Directory must be empty.&quot;</span>
                               <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># all other micc commands require a project directory.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a project directory (</span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">project_path</span>

<div class="viewcode-block" id="Project.error"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print an error message :py:obj:`msg` and set the project&#39;s :py:obj:`exit_code`.&quot;&quot;&quot;</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;[ERROR]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;bright_red&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Project.warning"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.warning">[docs]</a>    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print an warning message :py:obj:`msg` and set the project&#39;s :py:obj:`exit_code`.&quot;&quot;&quot;</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;[WARNING]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.create"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new project skeleton.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">allow_nesting</span><span class="p">:</span>
            <span class="c1"># Prevent the creation of a project inside another project</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">is_project_directory</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot create project in (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;  Specify &#39;--allow-nesting&#39; to create a et_micc project inside another et_micc project (</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">).&quot;</span>
                               <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span>

        <span class="n">project_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">module_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">verify_project_name</span><span class="p">(</span><span class="n">project_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The project name (</span><span class="si">{</span><span class="n">project_name</span><span class="si">}</span><span class="s2">) does not yield a PEP8 compliant module name:</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;  The project name must start with char, and contain only chars, digits, hyphens and underscores.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;  Alternatively, provide an explicit module name with the --module-name=&lt;name&gt;.&quot;</span>
                           <span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pep8_module_name</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">module_name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">relative_project_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># project_path was specified relative to cwd using ../</span>
            <span class="c1"># use full path instead of relative path</span>
            <span class="n">relative_project_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">publish</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">existsOnPyPI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># the name is not yet in use</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    The name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; is already in use on PyPI.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;    The project is not created.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;    You must choose another name if you want to publish your code on PyPI.&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ConnectionError: Check your internect connection.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;    The availability of name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; on PyPI could not be verified. </span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;    The project is not created.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># unknown error</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;    The availability of name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; on PyPI could not be verified. </span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;    The project is not created.&quot;</span>
                               <span class="p">)</span>
                <span class="k">return</span>

        <span class="n">structure</span><span class="p">,</span> <span class="n">source_file</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;package&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">relative_project_path</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">__init__.py)&#39;</span><span class="p">)</span> \
                                 <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">package</span> <span class="k">else</span> \
                                 <span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">relative_project_path</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s1">.py)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">logtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span>
                    <span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Creating project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">):&quot;</span>
                                    <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Python </span><span class="si">{</span><span class="n">structure</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">): structure = </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">template_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span>
                    <span class="p">,</span> <span class="s1">&#39;package_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span>
                                       <span class="p">}</span>
                <span class="n">template_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span> <span class="o">=</span> <span class="n">template_parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">expand_templates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exiting (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">) ...&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="n">my_micc_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;micc.json&#39;</span>
                <span class="k">with</span> <span class="n">my_micc_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">template_parameters</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; . Wrote project template parameters to </span><span class="si">{</span><span class="n">my_micc_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s2">&quot;Creating git repository&quot;</span><span class="p">):</span>
                    <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">):</span>
                        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">]</span>
                            <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">]</span>
                            <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;.gitignore&#39;</span><span class="p">]</span>
                            <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;commit&#39;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;And so this begun...&quot;&#39;</span><span class="p">]</span>
                        <span class="p">]</span>
                        <span class="n">github_username</span> <span class="o">=</span> <span class="n">template_parameters</span><span class="p">[</span><span class="s1">&#39;github_username&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">github_username</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">remote</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">pat_file</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;.pat.txt&#39;</span>
                            <span class="k">if</span> <span class="n">pat_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;gh&#39;</span><span class="p">,</span> <span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;--with-token&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pat_file</span><span class="p">)])</span>
                                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;gh&#39;</span><span class="p">,</span> <span class="s1">&#39;repo&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;--</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">remote</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-y&#39;</span><span class="p">])</span>
                                <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to access your GitHub account: file &#39;~/.pat.txt&#39; not found.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                                  <span class="s2">&quot;Remote repository not created.&quot;</span>
                                                 <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not creating remote GitHub repository &quot;</span><span class="p">)</span>
                        <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">stop_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Run &#39;poetry install&#39; in the project directory to create a virtual &quot;</span>
                    <span class="s2">&quot;environment and install its dependencies.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">publish</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The name &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; is still available on PyPI.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;To claim the name, it is best to publish your project now</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;by running &#39;poetry publish&#39;.&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Project.module_to_package_cmd"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.module_to_package_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">module_to_package_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a module project (:file:`module.py`) to a package project (:file:`package/__init__.py`).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;package&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">) is already a package (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Converting Python module project </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2"> to Python package project.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># add documentation files for general Python project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="s2">&quot;package-general-docs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;project_short_description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;poetry&#39;</span><span class="p">][</span><span class="s1">&#39;description&#39;</span><span class="p">]}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">expand_templates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expand failed during Project.module_to_package_cmd for project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># move &lt;package_name&gt;.py to &lt;package_name&gt;/__init__.py</span>
        <span class="n">package_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span>
        <span class="n">package_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span></div>


<div class="viewcode-block" id="Project.info_cmd"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.info_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">info_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output info on the project.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Project &quot;</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">),</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot; located at &quot;</span>
                       <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">),</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  package: &quot;</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">),</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  version: &quot;</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
                       <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  structure: &quot;</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_file</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; (Python </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;package&#39;</span><span class="p">:</span>
            <span class="n">package_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">package_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/*.py&#39;</span><span class="p">))</span>
            <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">package_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/cpp_*/&#39;</span><span class="p">))</span>
            <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">package_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/f90_*&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># __init__.py is always there.</span>
                <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;  contents:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="c1"># filters</span>
                    <span class="k">if</span> <span class="s1">&#39;{&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="s1">&#39;package-&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>  <span class="c1"># very ad hoc solution, only relevant to the et_micc project itself</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">package_path</span><span class="p">):</span>  <span class="c1"># ignore the top-level __init__.py</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="s1">&#39;build_&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="n">fg</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
                    <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cli&#39;</span><span class="p">):</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;application &quot;</span>
                        <span class="n">fg</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cpp_&#39;</span><span class="p">):</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;C++ module  &quot;</span>
                        <span class="n">extra</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.cpp&quot;</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f90_&#39;</span><span class="p">):</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;f90 module &quot;</span>
                        <span class="n">extra</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.f90&quot;</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">:</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;package     &quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;module      &quot;</span>
                    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">kind</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">package_path</span><span class="p">))</span> <span class="o">+</span> <span class="n">extra</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="n">fg</span><span class="p">))</span></div>


<div class="viewcode-block" id="Project.version_cmd"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.version_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">version_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bump the version according to :py:obj:`self.options.rule` or show the</span>
<span class="sd">        current version if no rule is specified.</span>

<span class="sd">        The version is stored in pyproject.toml in the project directory, and in</span>
<span class="sd">        :py:obj:`__version__` variable of the top-level package, which is either</span>
<span class="sd">        in :file:`&lt;package_name&gt;.py`, :file:`&lt;package_name&gt;/__init__.py`, or in</span>
<span class="sd">        :file:`&lt;package_name&gt;/__version__.py`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">short</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Project &quot;</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">) &quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;version &quot;</span> <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">) &quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
                           <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">current_semver</span> <span class="o">=</span> <span class="n">semantic_version</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;patch&#39;</span><span class="p">:</span>
                <span class="n">new_semver</span> <span class="o">=</span> <span class="n">current_semver</span><span class="o">.</span><span class="n">next_patch</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;minor&#39;</span><span class="p">:</span>
                <span class="n">new_semver</span> <span class="o">=</span> <span class="n">current_semver</span><span class="o">.</span><span class="n">next_minor</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span> <span class="o">==</span> <span class="s1">&#39;major&#39;</span><span class="p">:</span>
                <span class="n">new_semver</span> <span class="o">=</span> <span class="n">current_semver</span><span class="o">.</span><span class="n">next_major</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--rule </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">new_semver</span> <span class="o">=</span> <span class="n">semantic_version</span><span class="o">.</span><span class="n">Version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>

            <span class="c1"># update pyproject.toml</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;poetry&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_semver</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="c1"># update __version__</span>
                <span class="n">look_for</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;__version__ = &quot;</span><span class="si">{</span><span class="n">current_semver</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="n">replace_with</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;__version__ = &quot;</span><span class="si">{</span><span class="n">new_semver</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;module&#39;</span><span class="p">:</span>
                    <span class="c1"># update in &lt;package_name&gt;.py</span>
                    <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_file</span><span class="p">,</span> <span class="n">look_for</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># update in &lt;package_name&gt;/__init__.py</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="s2">&quot;__version__.py&quot;</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">look_for</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span>
                        <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">look_for</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">)&gt; micc version (</span><span class="si">{</span><span class="n">current_semver</span><span class="si">}</span><span class="s2">) -&gt; (</span><span class="si">{</span><span class="n">new_semver</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">)&gt; micc version </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> --dry-run : &quot;</span>
                           <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">current_semver</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&gt; &quot;</span>
                           <span class="o">+</span> <span class="n">click</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">new_semver</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
                           <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_semver</span><span class="p">)</span>  <span class="c1"># even if dry run!</span></div>

<div class="viewcode-block" id="Project.tag_cmd"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.tag_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">tag_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create and push a version tag ``v&lt;Major&gt;.&lt;minor&gt;.&lt;patch&gt;`` for the current version.&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;v</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating git tag </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> for project </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">,</span> <span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;&quot;tag version </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running &#39;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">completed_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">completed_process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">completed_process</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">completed_process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pushing tag </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> for project </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running &#39;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">completed_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">completed_process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">completed_process</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">completed_process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">completed_process</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">completed_process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">completed_process</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">completed_process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed &#39;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">Rerun the command later (you must be online).&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Project.add_cmd"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">add_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add some source file to the project.</span>

<span class="sd">        This method dispatches to</span>

<span class="sd">        * :py:meth:`add_app`,</span>
<span class="sd">        * :py:meth:`add_python_module`,</span>
<span class="sd">        * :py:meth:`add_f90_module`,</span>
<span class="sd">        * :py:meth:`add_cpp_module`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="s1">&#39;module&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot add to a module project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">).</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;  Use `micc convert-to-package&#39; on this project to convert it to a package project.&quot;</span>
                       <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># set implied flags:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
            <span class="n">app_implied</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [implied by --group   (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">group</span><span class="p">)</span><span class="si">}</span><span class="s2">)]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app_implied</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
            <span class="n">py_implied</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [implied by --package (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">package</span><span class="p">)</span><span class="si">}</span><span class="s2">)]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">py</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">py_implied</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Verify that one and only one of app/py/f90/cpp flags has been selected:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">app</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">py</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">f90</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cpp</span><span class="p">)</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">xor</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">py</span><span class="p">),</span> <span class="n">xor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">f90</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cpp</span><span class="p">))):</span>
            <span class="c1"># Do not log, as the state of the project is not changed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specify one and only one of </span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;  --app (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">app</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">app_implied</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;  --py  (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">py</span> <span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">py_implied</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;  --f90 (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">f90</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;  --cpp (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cpp</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">db_entry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">app</span><span class="p">:</span>
            <span class="c1"># Prepare for adding an app</span>
            <span class="n">app_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_exists</span><span class="p">(</span><span class="n">app_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2"> has already an app named </span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">verify_project_name</span><span class="p">(</span><span class="n">app_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Not a valid app name (</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">_. Valid names:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  * start with a letter [a-zA-Z]</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  * contain only [a-zA-Z], digits, hyphens, and underscores</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">group</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="s1">&#39;app-sub-commands&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="s1">&#39;app-simple&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_app</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Prepare for adding a sub-module</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>

            <span class="c1"># Verify that the name is not already used:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_exists</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2"> has already a module named </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Verify that the name is valid:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">verify_project_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pep8_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Not a valid module name (</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">). Valid names:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  * start with a letter [a-zA-Z]</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;  * contain only [a-zA-Z], digits, and underscores</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">py</span><span class="p">:</span>
                <span class="c1"># prepare for adding a Python sub-module:</span>
                <span class="c1"># self.options.structure = &#39;package&#39; if self.options.package else &#39;module&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="s1">&#39;module-py&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_python_module</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">f90</span><span class="p">:</span>
                <span class="c1"># prepare for adding a Fortran sub-module:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="s1">&#39;module-f90&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_f90_module</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span>
                <span class="c1"># prepare for adding a C++ sub-module:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="s1">&#39;module-cpp&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_cpp_module</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialize_db</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Project.add_app"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_app">[docs]</a>    <span class="k">def</span> <span class="nf">add_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a console script (app, aka CLI) to the package.&quot;&quot;&quot;</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>
        <span class="n">cli_app_name</span> <span class="o">=</span> <span class="s1">&#39;cli_&#39;</span> <span class="o">+</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pep8_module_name</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="s1">&#39;with&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">group</span> <span class="k">else</span> <span class="s1">&#39;without&#39;</span>

        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Adding CLI </span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2"> sub-commands to project </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="n">app_name</span><span class="p">,</span> <span class="s1">&#39;cli_app_name&#39;</span><span class="p">:</span> <span class="n">cli_app_name</span><span class="p">}</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">expand_templates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expand failed during Project.add_app for project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">[</span><span class="s1">&#39;package_name&#39;</span><span class="p">]</span>
            <span class="n">src_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cli_</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">)</span>
            <span class="n">tst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;test_cli_</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Python source file </span><span class="si">{</span><span class="n">src_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Python test code   </span><span class="si">{</span><span class="n">tst_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
                <span class="c1"># docs</span>
                <span class="c1"># Look if this package has already an &#39;apps&#39; entry in docs/index.rst</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;docs/index.rst&#39;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">has_already_apps</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">api_line</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="n">has_already_apps</span> <span class="o">=</span> <span class="n">has_already_apps</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;   apps&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;   api&#39;</span><span class="p">):</span>
                        <span class="n">api_line</span> <span class="o">=</span> <span class="n">l</span>

                <span class="c1"># if not, create it:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_already_apps</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">api_line</span><span class="p">,</span> <span class="s1">&#39;   apps</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;docs/index.rst&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="c1"># Create &#39;APPS.rst&#39; if it does not exist:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;APPS.rst&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="c1"># create a title</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Command Line Interfaces (apps)&quot;</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">line</span>
                            <span class="o">+</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="o">+</span> <span class="n">line</span>
                            <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="p">)</span>
                <span class="c1"># create entry for this apps documentation</span>
                <span class="n">txt2</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.. click:: </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">cli_app_name</span><span class="si">}</span><span class="s2">:main</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;   :prog: </span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;   :show-nested:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;APPS.rst&#39;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span> <span class="o">+</span> <span class="n">txt2</span><span class="p">)</span>
                <span class="n">db_entry</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">txt2</span>

                <span class="c1"># pyproject.toml</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">({</span><span class="s1">&#39;click&#39;</span><span class="p">:</span> <span class="s1">&#39;^7.0.0&#39;</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;poetry&#39;</span><span class="p">][</span><span class="s1">&#39;scripts&#39;</span><span class="p">][</span><span class="n">app_name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">cli_app_name</span><span class="si">}</span><span class="s2">.main&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="n">db_entry</span><span class="p">[</span><span class="s1">&#39;pyproject.toml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s1"> = &quot;refactoring_dev:cli_</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s1">.main&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>

                <span class="c1"># add &#39;import &lt;package_name&gt;.cli_&lt;app_name&gt; to __init__.py</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;import </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">.cli_</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span>
                <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">insert_in_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">[</span><span class="n">line</span><span class="p">],</span> <span class="n">before</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">startswith</span><span class="o">=</span><span class="s2">&quot;__version__&quot;</span><span class="p">)</span>
                <span class="n">db_entry</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">line</span></div>

<div class="viewcode-block" id="Project.add_python_module"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_python_module">[docs]</a>    <span class="k">def</span> <span class="nf">add_python_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a python sub-module or sub-package to this project.&quot;&quot;&quot;</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_name</span> <span class="o">==</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pep8_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a valid module_name: </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">source_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s2">__init__.py&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">package</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.py&quot;</span>
        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Adding python module </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s2"> to project </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                                <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="n">module_name</span><span class="p">})</span>

            <span class="c1"># Create the needed folders and files by expanding the templates:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">expand_templates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expand failed during Project.add_python_module for project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">[</span><span class="s1">&#39;package_name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">module_to_package</span><span class="p">(</span><span class="n">project_path</span> <span class="o">/</span> <span class="n">package_name</span> <span class="o">/</span> <span class="p">(</span><span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">))</span>

            <span class="n">src_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">package_name</span><span class="p">,</span> <span class="n">source_file</span><span class="p">)</span>
            <span class="n">tst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="s1">&#39;test_&#39;</span> <span class="o">+</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- python source in    </span><span class="si">{</span><span class="n">src_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Python test code in </span><span class="si">{</span><span class="n">tst_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
                <span class="c1"># docs</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;API.rst&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">.. automodule:: </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span> \
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   :members:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">db_entry</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span></div>

<div class="viewcode-block" id="Project.add_f90_module"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_f90_module">[docs]</a>    <span class="k">def</span> <span class="nf">add_f90_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a f90 module to this project.&quot;&quot;&quot;</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>

        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Adding f90 module </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> to project </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                                <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="n">module_name</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">expand_templates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expand failed during Project.add_f90_module for project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>

            <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">[</span><span class="s1">&#39;package_name&#39;</span><span class="p">]</span>
            <span class="n">src_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="n">package_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;f90_&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
                                    <span class="p">,</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.f90&#39;</span>
                                    <span class="p">)</span>
            <span class="n">cmk_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="n">package_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;f90_&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;CMakeLists.txt&#39;</span>
                                    <span class="p">)</span>
            <span class="n">tst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="s1">&#39;tests&#39;</span>
                                    <span class="p">,</span> <span class="s1">&#39;test_f90_&#39;</span> <span class="o">+</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span>
                                    <span class="p">)</span>

            <span class="n">rst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="n">package_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;f90_&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
                                    <span class="p">,</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.rst&#39;</span>
                                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Fortran source in       </span><span class="si">{</span><span class="n">src_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- build settings in       </span><span class="si">{</span><span class="n">cmk_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Python test code in     </span><span class="si">{</span><span class="n">tst_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- module documentation in </span><span class="si">{</span><span class="n">rst_file</span><span class="si">}</span><span class="s2"> (restructuredText format).&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">({</span><span class="s1">&#39;et-micc-build&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">CURRENT_ET_MICC_BUILD_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="c1"># docs</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;API.rst&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">.. include:: ../</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">/f90_</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.rst</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="n">db_entry</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_auto_build_code</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.add_auto_build_code"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_auto_build_code">[docs]</a>    <span class="k">def</span> <span class="nf">add_auto_build_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add auto build code for binary extension modules in :file:`__init__.py` of the package.&quot;&quot;&quot;</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>
        <span class="n">text_to_insert</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;try:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;    import </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;except ModuleNotFoundError as e:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    # Try to build this binary extension:&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    from pathlib import Path&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    import click&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    from et_micc_build.cli_micc_build import auto_build_binary_extension&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;    msg = auto_build_binary_extension(Path(__file__).parent, &#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    if not msg:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;        import </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;    else:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;        click.secho(msg, fg=&#39;bright_red&#39;)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">)</span>
        <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">insert_in_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span>
            <span class="n">text_to_insert</span><span class="p">,</span>
            <span class="n">startswith</span><span class="o">=</span><span class="s2">&quot;__version__ = &quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_to_insert</span><span class="p">)</span>
        <span class="n">db_entry</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span></div>

<div class="viewcode-block" id="Project.add_cpp_module"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_cpp_module">[docs]</a>    <span class="k">def</span> <span class="nf">add_cpp_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a cpp module to this project.&quot;&quot;&quot;</span>
        <span class="n">project_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span>

        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Adding cpp module cpp_</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> to project </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                                <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;module_name&#39;</span><span class="p">:</span> <span class="n">module_name</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">expand</span><span class="o">.</span><span class="n">expand_templates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expand failed during Project.add_cpp_module for project (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">package_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">template_parameters</span><span class="p">[</span><span class="s1">&#39;package_name&#39;</span><span class="p">]</span>
            <span class="n">src_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="n">package_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;cpp_&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
                                    <span class="p">,</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.cpp&#39;</span>
                                    <span class="p">)</span>
            <span class="n">cmk_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="n">package_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;cpp_&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;CMakeLists.txt&#39;</span>
                                    <span class="p">)</span>
            <span class="n">tst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="s1">&#39;tests&#39;</span>
                                    <span class="p">,</span> <span class="s1">&#39;test_cpp_&#39;</span> <span class="o">+</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span>
                                    <span class="p">)</span>

            <span class="n">rst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span>
                                    <span class="p">,</span> <span class="n">package_name</span>
                                    <span class="p">,</span> <span class="s1">&#39;cpp_&#39;</span> <span class="o">+</span> <span class="n">module_name</span>
                                    <span class="p">,</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.rst&#39;</span>
                                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- C++ source in           </span><span class="si">{</span><span class="n">src_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- build settings in       </span><span class="si">{</span><span class="n">cmk_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Python test code in     </span><span class="si">{</span><span class="n">tst_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- module documentation in </span><span class="si">{</span><span class="n">rst_file</span><span class="si">}</span><span class="s2"> (restructuredText format).&quot;</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="n">project_path</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">({</span><span class="s1">&#39;et-micc-build&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">CURRENT_ET_MICC_BUILD_VERSION</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
                <span class="c1"># docs</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;API.rst&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;API.rst&quot;</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">.. include:: ../</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">/cpp_</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.rst</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="n">db_entry</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_auto_build_code</span><span class="p">(</span><span class="n">db_entry</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.app_exists"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.app_exists">[docs]</a>    <span class="k">def</span> <span class="nf">app_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if there is already an app with name ``app_name`` in this project.</span>

<span class="sd">        * :file:`&lt;package_name&gt;/cli_&lt;app_name&gt;.py`</span>

<span class="sd">        :param str app_name: app name</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cli_</span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.module_exists"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.module_exists">[docs]</a>    <span class="k">def</span> <span class="nf">module_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if there is already a module with name py:obj:`module_name` in this project.</span>

<span class="sd">        This can be either a Python module, package, or a binary extension module.</span>

<span class="sd">        :param str module_name: module name</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">py_module_exists</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">py_package_exists</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpp_module_exists</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">f90_module_exists</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Project.py_module_exists"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.py_module_exists">[docs]</a>    <span class="k">def</span> <span class="nf">py_module_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if there is already a python module with name :py:obj:`module_name`</span>
<span class="sd">        in the project at :file:`project_path`.</span>

<span class="sd">        :param str module_name: module name</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s1">.py&#39;</span>
        <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.py_package_exists"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.py_package_exists">[docs]</a>    <span class="k">def</span> <span class="nf">py_package_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if there is already a python package with name :py:obj:`module_name`</span>
<span class="sd">        in the project at :file:`project_path`.</span>

<span class="sd">        :param str module_name: module name</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="n">module_name</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.f90_module_exists"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.f90_module_exists">[docs]</a>    <span class="k">def</span> <span class="nf">f90_module_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if there is already a f90 module with name py:obj:`module_name` in this project.</span>

<span class="sd">        :param str module_name: module name</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="p">(</span><span class="s1">&#39;f90_&#39;</span> <span class="o">+</span> <span class="n">module_name</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.f90&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.cpp_module_exists"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.cpp_module_exists">[docs]</a>    <span class="k">def</span> <span class="nf">cpp_module_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if there is already a cpp module with name py:obj:`module_name` in this project.</span>

<span class="sd">        :param str module_name: module name</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="p">(</span><span class="s1">&#39;cpp_&#39;</span> <span class="o">+</span> <span class="n">module_name</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.cpp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Project.add_dependencies"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.add_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add dependencies to the :file:`pyproject.toml` file.</span>

<span class="sd">        :param dict deps: (package,version_constraint) pairs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tool_poetry_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="p">[</span><span class="s1">&#39;tool&#39;</span><span class="p">][</span><span class="s1">&#39;poetry&#39;</span><span class="p">][</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">version_constraint</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pkg</span> <span class="ow">in</span> <span class="n">tool_poetry_dependencies</span><span class="p">:</span>
                <span class="c1"># project was already depending on this package</span>
                <span class="n">range1</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">version_range</span><span class="p">(</span><span class="n">version_constraint</span><span class="p">)</span>
                <span class="n">range2</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">version_range</span><span class="p">(</span><span class="n">tool_poetry_dependencies</span><span class="p">[</span><span class="n">pkg</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">range1</span> <span class="o">==</span> <span class="n">range2</span><span class="p">:</span>
                    <span class="c1"># nothing to do: new and old version specifcation are the same</span>
                    <span class="k">continue</span>
                <span class="n">intersection</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">range1</span><span class="p">,</span> <span class="n">range2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">validate_intersection</span><span class="p">(</span><span class="n">intersection</span><span class="p">):</span>
                    <span class="nb">range</span> <span class="o">=</span> <span class="n">intersection</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">range</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">most_recent</span><span class="p">(</span><span class="n">version_constraint</span><span class="p">,</span> <span class="n">tool_poetry_dependencies</span><span class="p">[</span><span class="n">pkg</span><span class="p">])</span>
                <span class="n">tool_poetry_dependencies</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">version_constraint</span><span class="p">(</span><span class="nb">range</span><span class="p">)</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># an entirely new dependency</span>
                <span class="n">tool_poetry_dependencies</span><span class="p">[</span><span class="n">pkg</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_constraint</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">modified</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pyproject_toml</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Dependencies added. Run `poetry install` to install missing dependencies in the project&#39;s virtual environment.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Project.module_to_package"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.module_to_package">[docs]</a>    <span class="k">def</span> <span class="nf">module_to_package</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_py</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move file :file:`module.py` to :file:`module/__init__.py`.</span>

<span class="sd">        :param str|Path module_py: path to module.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module_py</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">module_py</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_py</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">module_py</span><span class="p">)</span>
        <span class="n">src</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_py</span><span class="p">)</span>

        <span class="n">package_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_py</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">package</span> <span class="o">=</span> <span class="n">module_py</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">package_name</span>
        <span class="n">package</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">package</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

        <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
                           <span class="sa">f</span><span class="s2">&quot; . Module </span><span class="si">{</span><span class="n">module_py</span><span class="si">}</span><span class="s2"> converted to package </span><span class="si">{</span><span class="n">package_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s2">__init__.py.&quot;</span>
                           <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">log_file_path</span><span class="p">:</span>
            <span class="n">log_file_name</span> <span class="o">=</span> <span class="n">log_file_path</span><span class="o">.</span><span class="n">name</span>
            <span class="n">log_file_dir</span> <span class="o">=</span> <span class="n">log_file_path</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">project_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.micc.log&quot;</span>
            <span class="n">log_file_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">project_path</span>
            <span class="n">log_file_path</span> <span class="o">=</span> <span class="n">log_file_dir</span> <span class="o">/</span> <span class="n">log_file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">log_file_path</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;clear_log&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">log_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">log_file_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># create a new logger object that will write to the log file and to the console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">create_logger</span><span class="p">(</span><span class="n">log_file_path</span><span class="p">)</span>

        <span class="c1"># set the log level from the verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">verbosity_to_loglevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current logfile = </span><span class="si">{</span><span class="n">log_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;clear_log&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The log file was cleared: </span><span class="si">{</span><span class="n">log_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">clear_log</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>


<div class="viewcode-block" id="Project.deserialize_db"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.deserialize_db">[docs]</a>    <span class="k">def</span> <span class="nf">deserialize_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read file ``db.json`` into self.db.&quot;&quot;&quot;</span>

        <span class="n">db_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;db.json&#39;</span>
        <span class="k">if</span> <span class="n">db_json</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">db_json</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Project.serialize_db"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.serialize_db">[docs]</a>    <span class="k">def</span> <span class="nf">serialize_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_entry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write self.db to file ``db.json``.</span>

<span class="sd">        Self.options is a SimpleNamespace object which is not default json serializable.</span>
<span class="sd">        This function takes care of that by converting to ``str`` where possible, and</span>
<span class="sd">        ignoring objects that do not need serialization, as e.g. self.options.logger.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">db_entry</span><span class="p">:</span>
            <span class="c1"># produce a json serializable version of db_entry[&#39;options&#39;]:</span>
            <span class="n">my_options</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">db_entry</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
                    <span class="c1"># default serializable types</span>
                    <span class="n">my_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;serialize_db: using (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                    <span class="n">my_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;serialize_db: using (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:str(&#39;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&#39;))&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;serialize_db: ignoring (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="n">db_entry</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">my_options</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">):</span>
                <span class="c1"># Read db.json into self.db if self.db does not yet exist.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_db</span><span class="p">()</span>

            <span class="c1"># store the entry in self.db:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">add_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_entry</span>

        <span class="c1"># finally, serialize self.db</span>
        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">in_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;db.json&#39;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Project.mv_component"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.mv_component">[docs]</a>    <span class="k">def</span> <span class="nf">mv_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rename or Remove a component (sub-module, sub-package, Fortran module, C++ module, app (CLI).&quot;&quot;&quot;</span>
        <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cur_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">new_name</span>
        <span class="c1"># Look up &lt;cur_name&gt; in the project&#39;s database to find out what kind of a component it is:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deserialize_db</span><span class="p">()</span>
        <span class="n">db_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">cur_name</span><span class="p">]</span> <span class="c1"># may raise KeyError</span>

        <span class="n">component_options</span> <span class="o">=</span> <span class="n">db_entry</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new_name</span><span class="p">:</span> <span class="c1"># rename</span>
            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span>
                                   <span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; Renaming component </span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">:&quot;</span>
                                   <span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">entire_project</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming entire project (--entire-project): &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">entire_package</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming entire package (--entire-package): &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Python sub-package: &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s2">__init__.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming test file: &#39;tests/test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming Python sub-module: &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming test file: &#39;tests/test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;f90&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fortran sub-module: &#39;f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.f90&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming test file: &#39;tests/test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span><span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;cpp&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C++ sub-module: &#39;cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.cpp&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming test file: &#39;tests/test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command line interface (no subcommands): &#39;cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;test_cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                    
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">db_entry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;options&#39;</span><span class="p">:</span>
                        <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="n">key</span>
                        <span class="n">new_string</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">new_string</span><span class="p">,</span> <span class="n">contents_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">db_entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_string</span>

                <span class="c1"># Update the database:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating database entry for : &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_entry</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1"># remove</span>
            <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span>
                                   <span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; Removing component &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                                   <span class="p">):</span>
                <span class="k">if</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing Python sub-package: &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s2">__init__.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="n">cur_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing test file: &#39;tests/test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">,)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;py&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing Python sub-module: &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing test file: &#39;tests/test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;f90&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing Fortran sub-module: &#39;f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing test file: &#39;tests/test_f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_f90_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;cpp&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing C++ sub-module: &#39;cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing test file: &#39;tests/test_cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;test_cpp_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">.py&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;app&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">component_options</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing app: &#39;cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing test file: &#39;test_cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span>  <span class="s1">&#39;tests&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;test_cli_</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">.py&quot;</span><span class="p">)</span>


                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">db_entry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_path</span> <span class="o">/</span> <span class="n">key</span>
                        <span class="n">parent_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">old_string</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span>
                        <span class="n">new_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">old_string</span><span class="p">,</span> <span class="n">new_string</span><span class="p">,</span> <span class="n">contents_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Update the database:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating database entry for : &#39;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">cur_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialize_db</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">replace_in_folder</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">folderpath</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
        <span class="n">cur_dirname</span> <span class="o">=</span> <span class="n">folderpath</span><span class="o">.</span><span class="n">name</span>
        <span class="n">new_dirname</span> <span class="o">=</span> <span class="n">cur_dirname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cur_name</span><span class="p">,</span><span class="n">new_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Renaming folder &quot;</span><span class="si">{</span><span class="n">cur_dirname</span><span class="si">}</span><span class="s1">&quot; -&gt; &quot;</span><span class="si">{</span><span class="n">new_dirname</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">):</span>
            <span class="c1"># first rename the folder</span>
            <span class="n">new_folderpath</span> <span class="o">=</span> <span class="n">folderpath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">new_dirname</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">folderpath</span><span class="p">,</span> <span class="n">new_folderpath</span><span class="p">)</span>

            <span class="c1"># rename subfolder names:</span>
            <span class="n">folder_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of tuples with (oldname,newname)</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_folderpath</span><span class="p">)):</span>
                <span class="n">_filter</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="c1"># in place modification of the list of folders to traverse</span>
                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                    <span class="n">new_folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cur_name</span><span class="p">,</span><span class="n">new_name</span><span class="p">)</span>
                    <span class="n">folder_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">folder</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">new_folder</span><span class="p">)))</span>

            <span class="c1"># rename subfolder names:</span>
            <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">folder_list</span><span class="p">:</span>
                <span class="n">old_folder</span> <span class="o">=</span> <span class="n">tpl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_folder</span> <span class="o">=</span> <span class="n">tpl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renaming folder &#39;</span><span class="si">{</span><span class="n">old_folder</span><span class="si">}</span><span class="s2">&#39;  -&gt; &#39;</span><span class="si">{</span><span class="n">new_folder</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_folder</span><span class="p">,</span> <span class="n">new_folder</span><span class="p">)</span>

            <span class="c1"># rename in files and file contents:</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_folderpath</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.orig.&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.so&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.lock&#39;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_in_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">file</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                <span class="n">_filter</span><span class="p">(</span><span class="n">folders</span><span class="p">)</span> <span class="c1"># in place modification of the list of folders to traverse</span>


    <span class="k">def</span> <span class="nf">remove_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">remove_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<div class="viewcode-block" id="Project.replace_in_file"><a class="viewcode-back" href="../../api.html#et_micc.project.Project.replace_in_file">[docs]</a>    <span class="k">def</span> <span class="nf">replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">contents_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace &lt;cur_name&gt; with &lt;new_name&gt; in the filename and its contents.&quot;&quot;&quot;</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">name</span>

        <span class="n">what</span> <span class="o">=</span> <span class="s1">&#39;Modifying&#39;</span> <span class="k">if</span> <span class="n">contents_only</span> <span class="k">else</span> <span class="s1">&#39;Renaming&#39;</span>
        <span class="k">with</span> <span class="n">et_micc</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">what</span><span class="si">}</span><span class="s2"> file </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading from </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">old_contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replacing &quot;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">&quot; with &quot;</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s1">&quot; in file contents.&#39;</span><span class="p">)</span>
            <span class="n">new_contents</span> <span class="o">=</span> <span class="n">old_contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cur_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">contents_only</span><span class="p">:</span>
                <span class="n">new_file</span> <span class="o">=</span> <span class="n">file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cur_name</span><span class="p">,</span><span class="n">new_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Replacing &quot;</span><span class="si">{</span><span class="n">cur_name</span><span class="si">}</span><span class="s1">&quot; with &quot;</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s1">&quot; in file name -&gt; &quot;</span><span class="si">{</span><span class="n">new_file</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">new_file</span>

            <span class="c1"># By first renaming the original file, we avoid problems when the new</span>
            <span class="c1"># file name is identical to the old file name (because it is invariant,</span>
            <span class="c1"># e.g. __init__.py)</span>
            <span class="n">orig_file</span> <span class="o">=</span> <span class="s1">&#39;.orig.&#39;</span><span class="o">+</span><span class="n">file</span>
            <span class="n">orig_path</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">orig_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Keeping original file &quot;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&quot; as &quot;</span><span class="si">{</span><span class="n">orig_file</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">orig_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing modified file contents to </span><span class="si">{</span><span class="n">new_path</span><span class="si">}</span><span class="s1">: &#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_contents</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="n">folders</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;In place modification of the list of folders to traverse.</span>

<span class="sd">    see https://docs.python.org/3/library/os.html</span>

<span class="sd">    ...</span>

<span class="sd">    When topdown is True, the caller can modify the dirnames list in-place</span>
<span class="sd">    (perhaps using del or slice assignment), and walk() will only recurse</span>
<span class="sd">    into the subdirectories whose names remain in dirnames; this can be used</span>
<span class="sd">    to prune the search, impose a specific order of visiting, or even to</span>
<span class="sd">    inform walk() about directories the caller creates or renames before it</span>
<span class="sd">    resumes walk() again. Modifying dirnames when topdown is False has no</span>
<span class="sd">    effect on the behavior of the walk, because in bottom-up mode the</span>
<span class="sd">    directories in dirnames are generated before dirpath itself is generated.</span>

<span class="sd">    ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exclude_folders</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.venv&#39;</span><span class="p">,</span> <span class="s1">&#39;.git&#39;</span><span class="p">,</span> <span class="s1">&#39;_build&#39;</span><span class="p">,</span> <span class="s1">&#39;_cmake_build&#39;</span><span class="p">,</span> <span class="s1">&#39;__pycache__&#39;</span><span class="p">]</span>
    <span class="n">folders</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">exclude_folders</span><span class="p">]</span>

<span class="c1"># eof</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Engelbert Tijskens

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>