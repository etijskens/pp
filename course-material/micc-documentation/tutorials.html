

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorials &mdash; et_micc 1.0.19 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Interesting links on Python programming" href="links.html" />
    <link rel="prev" title="Frequently asked questions" href="faq.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> et_micc
          

          
          </a>

          
            
            
              <div class="version">
                1.0.19
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme.html">Micc</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="apps.html">Applications (CLI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="devenv.html">Development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently asked questions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-1-getting-started-with-micc">Tutorial 1: Getting started with micc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#micc-setup">1.0 Micc setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-project-with-micc">1.1 Creating a project with micc</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#modules-and-packages-intermediate">1.1.1. Modules and packages [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#what-s-in-a-name-intermediate">1.1.2 What’s in a name [intermediate]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#first-steps-in-project-management-using-micc">1.2 First steps in project management (using micc)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-project-path-in-micc-intermediate">1.2.1. The project path in micc [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtual-environments">1.2.2 Virtual environments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modules-and-scripts">1.2.3 Modules and scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-your-code">1.2.4 Testing your code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generating-documentation-intermediate">1.2.5 Generating documentation [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#version-control-advanced">1.2.6 Version control [advanced]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous">1.3 Miscellaneous</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-license-file-intermediate">1.3.1 The license file [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-pyproject-toml-file-intermediate">1.3.2 The pyproject.toml file [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-log-file-micc-log-intermediate">1.3.3 The log file Micc.log [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adjusting-micc-to-your-needs-advanced">1.3.4 Adjusting micc to your needs [advanced]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#a-first-real-project">1.4 A first real project</a></li>
<li class="toctree-l3"><a class="reference internal" href="#improving-efficiency">1.5 Improving efficiency</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#timing-your-code">1.5.1 Timing your code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#comparing-to-numpy">1.5.2 Comparing to Numpy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#conclusion">1.6 Conclusion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-2-binary-extensions">Tutorial 2: Binary extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction-high-performance-python">2.1 Introduction - High Performance Python</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#choosing-between-fortran-and-c-for-binary-extension-modules-intermediate">2.1.1 Choosing between Fortran and C++ for binary extension modules [intermediate]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#adding-binary-extensions-to-a-micc-project">2.2 Adding Binary extensions to a Micc project</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#micc-build-options">2.2.3 micc-build options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-binary-extensions-from-fortran">2.3 Building binary extensions from Fortran</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fortran-modules-intermediate">2.3.1 Fortran modules [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-the-build-intermediate">2.3.2 Controlling the build [intermediate]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-binary-extensions-from-c">2.4 Building binary extensions from C++</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#control-build-cpp">2.4.1 Controlling the build [intermediate]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-type-issues">2.5 Data type issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#corresponding-data-types-intermediate">2.5.1 Corresponding data types [intermediate]</a></li>
<li class="toctree-l4"><a class="reference internal" href="#returning-large-data-structures-advanced">2.5.2 Returning large data structures [advanced]</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#documenting-binary-extension-modules">2.6 Documenting binary extension modules</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-3-adding-python-components">Tutorial 3: Adding Python components</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-python-module">3.1 Adding a Python module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#testing-the-module">Testing the module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#documenting-the-module">Documenting the module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-python-command-line-interface">3.2 Adding a Python Command Line Interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#testing-the-application">Testing the application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#documenting-an-application">Documenting an application</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-4-version-control-and-version-management">Tutorial 4: Version control and version management</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#git-support">4.1 Git support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#version-management">4.2 Version management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-5-publishing-your-code">Tutorial 5 - Publishing your code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#publishing-to-the-python-package-index">5.1 Publishing to the Python Package Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-packages-with-binary-extension-modules">5.2 Publishing packages with binary extension modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-your-documentation-on-readthedocs-org">5.4 Publishing your documentation on readthedocs.org</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorial-6-using-micc-projects-on-the-vsc-clusters">Tutorial 6 - Using micc projects on the VSC clusters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#accessing-the-cluster">6.1 Accessing the cluster</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-modules">6.2 Using modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-micc-on-the-cluster">6.2 Using Micc on the cluster</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python-and-python-packages">6.2.1 Python and Python packages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-poetry">6.2.2 Using Poetry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">6.2.3 Creating virtual environments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-dependencies">6.2.4 Installing dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#access-to-compilers">6.2.5 Access to compilers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">6.2.6 CMake</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">6.2.6 Git</a></li>
<li class="toctree-l4"><a class="reference internal" href="#a-remark-on-the-order-of-things">6.2.7 a remark on the order of things</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="links.html">Interesting links on Python programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">et_micc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tutorials</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorials.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorials">
<h1>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h1>
<div class="section" id="tutorial-1-getting-started-with-micc">
<h2>Tutorial 1: Getting started with micc<a class="headerlink" href="#tutorial-1-getting-started-with-micc" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These tutorials focus not just on how to use <a class="reference external" href="https://micc.readthedocs.io">micc</a>. Rather they describe a workflow
for how you might set up a python project and develop it using best practises, with
the help of <a class="reference external" href="https://micc.readthedocs.io">micc</a>.</p>
<p>All tutorial sections start with the bare essentials, which should get you
up and running. They are often followed by more detailed subsections that
provide useful background information that is needed for intermediate or
advanced usage. These sections have an explicit <em>[intermediate]</em> or
<em>[advanced]</em> tag in the title, e.g. <a class="reference internal" href="#modules-and-packages"><span class="std std-ref">1.1.1. Modules and packages [intermediate]</span></a> and they are
indented. Background sections can be skipped on first reading, but the user
is encouraged to read them at some point. The tutorials are rather extensive
as they interlaced with many good practices advises.</p>
</div>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> wants to provide a practical interface to the many aspects of managing a
Python project: setting up a new project in a standardized way, adding documentation,
version control, publishing the code to <a class="reference external" href="https://pypi.org">PyPI</a>, building binary extension modules in C++
or Fortran, dependency management, … For all these aspect there are tools available,
yet i found myself struggling get everything right and looking up the details each time.
<a class="reference external" href="https://micc.readthedocs.io">Micc</a> is an attempt to wrap all the details by providing the user with a standardized
yet flexible workflow for managing a Python project. Standardizing is a great way to
increase productivity. For many aspects the tools used by <a class="reference external" href="https://micc.readthedocs.io">Micc</a> are completely hidden
from the user, e.g. project setup, adding components, building binary extensions, …
For other aspects <a class="reference external" href="https://micc.readthedocs.io">Micc</a> provides just the necessary setup for you to use other tools
as you need them. Learning to use the following tools is certainly beneficial:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://python-poetry.org/">Poetry</a>: for dependency management, virtual environment creation, and
publishing the project to <a class="reference external" href="https://pypi.org">PyPI</a> (and a lot more, if you like). Although
extremely handy on a desktop machine or a laptop, it does not play well with
the module system that is used on the VSC clusters for accessing applications.
A workaround is provided in Tutorial 6.</p></li>
<li><p><a class="reference external" href="https://git-scm.com">Git</a>: for version control. Its use is optional
but highly recommended. See Tutorial 4 for some <a class="reference external" href="https://git-scm.com">git</a> coverage.</p></li>
<li><p><a class="reference external" href="https://pytest.org/en/latest/">Pytest</a>: for (unit) testing. Also optional and also highly recommended.</p></li>
<li><p><a class="reference external" href="http://www.sphinx-doc.org/en/master/">Sphinx</a>: for building documentation. Optional but recommended.</p></li>
</ul>
<p>The basic commands for these tools are covered in these tutorials.</p>
<div class="section" id="micc-setup">
<h3>1.0 Micc setup<a class="headerlink" href="#micc-setup" title="Permalink to this headline">¶</a></h3>
<p>Before micc can be used it must be setup to specify some preferences. Most entries
have sensible default entries, but your name, email address and github user name
have to be provided by you, if they are to make any sense, obviously. The github
username is needed if you want to be able to push your commits to github.
Run <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">setup</span></code> to set the preferences:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">setup</span>
<span class="n">your</span> <span class="n">full</span> <span class="n">name</span> <span class="p">[</span><span class="n">first</span><span class="o">-</span><span class="n">name</span> <span class="n">last</span><span class="o">-</span><span class="n">name</span><span class="p">]:</span> <span class="n">Engelbert</span> <span class="n">Tijskens</span>
<span class="n">your</span> <span class="n">e</span><span class="o">-</span><span class="n">mail</span> <span class="n">address</span> <span class="p">[</span><span class="n">your</span><span class="o">.</span><span class="n">email</span><span class="nd">@whatev</span><span class="o">.</span><span class="n">er</span><span class="p">]:</span> <span class="n">engelbert</span><span class="o">.</span><span class="n">tijskens</span><span class="nd">@uantwerpen</span><span class="o">.</span><span class="n">be</span>
<span class="n">your</span> <span class="n">github</span> <span class="n">username</span> <span class="p">(</span><span class="n">leave</span> <span class="n">empty</span> <span class="k">if</span> <span class="n">you</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">one</span><span class="p">,</span>
  <span class="ow">or</span> <span class="n">create</span> <span class="n">one</span> <span class="n">at</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">join</span><span class="p">)</span> <span class="p">[</span><span class="n">your</span><span class="o">-</span><span class="n">github</span><span class="o">-</span><span class="n">username</span><span class="p">]:</span> <span class="n">etijskens</span>
<span class="n">the</span> <span class="n">initial</span> <span class="n">version</span> <span class="n">number</span> <span class="n">of</span> <span class="n">a</span> <span class="n">new</span> <span class="n">project</span> <span class="p">[</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span><span class="p">]:</span>
<span class="n">default</span> <span class="n">git</span> <span class="n">branch</span> <span class="p">[</span><span class="n">master</span><span class="p">]:</span>
<span class="n">default</span> <span class="n">minimal</span> <span class="n">Python</span> <span class="n">version</span> <span class="p">[</span><span class="mf">3.7</span><span class="p">]:</span>
<span class="n">Html</span> <span class="n">theme</span> <span class="k">for</span> <span class="n">sphinx</span> <span class="n">documentation</span> <span class="p">[</span><span class="n">sphinx_rtd_theme</span><span class="p">]:</span>
<span class="n">Choose</span> <span class="n">default</span> <span class="n">license</span> <span class="p">(</span><span class="n">MIT</span> <span class="n">license</span><span class="p">,</span> <span class="n">BSD</span> <span class="n">license</span><span class="p">,</span> <span class="n">ISC</span> <span class="n">license</span><span class="p">,</span> <span class="n">Apache</span> <span class="n">Software</span> <span class="n">License</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">GNU</span> <span class="n">General</span> <span class="n">Public</span> <span class="n">License</span> <span class="n">v3</span><span class="p">,</span> <span class="n">Not</span> <span class="nb">open</span> <span class="n">source</span><span class="p">)</span> <span class="p">[</span><span class="n">MIT</span> <span class="n">license</span><span class="p">]:</span>
<span class="n">python</span> <span class="n">file</span> <span class="n">extension</span> <span class="p">[</span><span class="n">py</span><span class="p">]:</span>
<span class="n">Done</span>

<span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">change</span> <span class="n">your</span> <span class="n">preferences</span><span class="p">,</span> <span class="n">edit</span> <span class="n">the</span> <span class="n">default</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">file</span>
    <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/.</span><span class="n">et_micc</span><span class="o">/</span><span class="n">micc</span><span class="o">.</span><span class="n">json</span>
<span class="n">Note</span> <span class="n">that</span> <span class="n">these</span> <span class="n">changes</span> <span class="n">will</span> <span class="n">only</span> <span class="n">affect</span> <span class="n">NEW</span> <span class="n">projects</span><span class="o">.</span> <span class="n">Existing</span> <span class="n">projects</span> <span class="n">will</span> <span class="n">be</span> <span class="n">unaffected</span><span class="o">.</span>
</pre></div>
</div>
<p>You may want to correct your entries, but not that changes will only affect NEW projects,
not existing ones.</p>
</div>
<div class="section" id="creating-a-project-with-micc">
<span id="create-proj"></span><h3>1.1 Creating a project with micc<a class="headerlink" href="#creating-a-project-with-micc" title="Permalink to this headline">¶</a></h3>
<p>Creating a new project with <a class="reference external" href="https://micc.readthedocs.io">micc</a> is simple:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">create</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_first_project</span>
</pre></div>
</div>
<p>This creates a new project <em>my_first_project</em> in folder <code class="docutils literal notranslate"><span class="pre">path/to</span></code>.
Note that the directory  <code class="docutils literal notranslate"><span class="pre">path/to/my_first_project</span></code> must either not exist,
or be empty.</p>
<p>Typically, the new project is created in the current working directory:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> path/to
&gt; micc create my_first_project
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">[</span> Creating project <span class="o">(</span>my_first_project<span class="o">)</span>:
<span class="o">[</span>INFO<span class="o">]</span>               Python module <span class="o">(</span>my_first_project<span class="o">)</span>: <span class="nv">structure</span> <span class="o">=</span> <span class="o">(</span>my_first_project/my_first_project.py<span class="o">)</span>
...
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">]</span> <span class="k">done</span>.
</pre></div>
</div>
</div></blockquote>
<p>After creating the project, we <code class="docutils literal notranslate"><span class="pre">cd</span></code> into the project directory because then any further
<a class="reference external" href="https://micc.readthedocs.io">micc</a> commands will automatically act on the project in the current working directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cd</span> <span class="n">my_first_project</span>
</pre></div>
</div>
<p>To apply a <a class="reference external" href="https://micc.readthedocs.io">micc</a> command to a project that is not in the current working directory
see <a class="reference internal" href="#micc-project-path"><span class="std std-ref">1.2.1. The project path in micc [intermediate]</span></a>.</p>
<p>The above command creates a project for a simple Python <em>module</em>, that is, the
project directory will contain - among others - a file <code class="docutils literal notranslate"><span class="pre">my_first_project.py</span></code> in
which represents the Python module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>my_first_project          # the project directory
└── my_first_project.py   # the Python module, this is where your code goes
</pre></div>
</div>
<p>When some client code imports this module:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">my_first_module</span>
</pre></div>
</div>
</div></blockquote>
<p>Python reads and executes the code in <code class="docutils literal notranslate"><span class="pre">my_first_module.py</span></code>. (Typically, this registers
the methods and classes defined in the module file. Also some variables, may be set up).</p>
<p>Note that the name of the Python module name is (automatically) taken from the project name
that with gave in the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">create</span></code> command. If you want project and module names to
differ from each other, check out the <a class="reference internal" href="#project-and-module-naming"><span class="std std-ref">1.1.2 What’s in a name [intermediate]</span></a> section.</p>
<p>The module project type above is suited for problems that can be solved with a single
Python file (<code class="docutils literal notranslate"><span class="pre">my_first_project.py</span></code> in the above case). For more complex problems a
<em>package</em> structure is more appropriate. To learn more about the use of Python modules
vs packages, check out the <a class="reference internal" href="#modules-and-packages"><span class="std std-ref">1.1.1. Modules and packages [intermediate]</span></a> section below.</p>
<div class="section" id="modules-and-packages-intermediate">
<span id="modules-and-packages"></span><h4>1.1.1. Modules and packages [intermediate]<a class="headerlink" href="#modules-and-packages-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>A <em>Python module</em> is the simplest Python project we can create. It is meant for rather
small projects that conveniently fit in a single (Python) file. More complex projects
require a <em>package</em> structure. They are created by adding the <code class="docutils literal notranslate"><span class="pre">--package</span></code> flag on the
command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">create</span> <span class="n">my_first_project</span> <span class="o">--</span><span class="n">package</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">[</span> <span class="n">Creating</span> <span class="n">project</span> <span class="p">(</span><span class="n">my_first_project</span><span class="p">):</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="n">Python</span> <span class="n">package</span> <span class="p">(</span><span class="n">my_first_project</span><span class="p">):</span> <span class="n">structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_first_project</span><span class="o">/</span><span class="n">my_first_project</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">)</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="p">[</span> <span class="n">Creating</span> <span class="n">git</span> <span class="n">repository</span>
                       <span class="o">...</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]</span>            <span class="n">Run</span> <span class="s1">&#39;poetry install&#39;</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">project</span> <span class="n">directory</span> <span class="n">to</span> <span class="n">create</span> <span class="n">a</span> <span class="n">virtual</span> <span class="n">environment</span> <span class="ow">and</span> <span class="n">install</span> <span class="n">its</span> <span class="n">dependencies</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
</pre></div>
</div>
<p>The output shows a different file structure of the project than for a module. Instead
of the file <code class="docutils literal notranslate"><span class="pre">my_first_project.py</span></code> there is a directory <code class="docutils literal notranslate"><span class="pre">my_first_project</span></code>, containing
a <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file. So, the structure of a package project looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>my_first_project          # the project directory
└── my_first_project      # the package directory
    └── __init__.py       # the file where your code goes
</pre></div>
</div>
<p>Typically, the package directory will contain several other Python files that together
make up your Python package. When some client code imports a module with a package
structure,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">my_first_module</span>
</pre></div>
</div>
<p>Python reads the code in <code class="docutils literal notranslate"><span class="pre">my_first_module/__init__.py</span></code> and executes it. The
<code class="docutils literal notranslate"><span class="pre">my_first_module/__init__.py</span></code> file is the equivalent of the <code class="docutils literal notranslate"><span class="pre">my_first_module.py</span></code>
in a module structure.</p>
<p>The distinction between a module structure and a package structure is also important
when you publish the module. When installing a Python package with a module structure,
only the <code class="docutils literal notranslate"><span class="pre">my_first_project.py</span></code> will be installed, while with the package structure
the entire <code class="docutils literal notranslate"><span class="pre">my_first_project</span></code> directory will be installed.</p>
<p>If you created a projected with a module structure and discover over time that its
complexity has grown beyond the limits of a simple module, you can easily convert
it to a <em>package</em> structure project at any time. First <code class="docutils literal notranslate"><span class="pre">cd</span></code> into the project
directory and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cd</span> <span class="n">my_first_project</span>
<span class="o">&gt;</span> <span class="n">micc</span> <span class="n">convert</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">package</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="n">Converting</span> <span class="n">Python</span> <span class="n">module</span> <span class="n">project</span> <span class="n">my_first_project</span> <span class="n">to</span> <span class="n">Python</span> <span class="n">package</span> <span class="n">project</span><span class="o">.</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]</span>        <span class="n">Pre</span><span class="o">-</span><span class="n">existing</span> <span class="n">files</span> <span class="n">that</span> <span class="n">would</span> <span class="n">be</span> <span class="n">overwritten</span><span class="p">:</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]</span>          <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">p1</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">rst</span>
<span class="n">Aborting</span> <span class="n">because</span> <span class="s1">&#39;overwrite==False&#39;</span><span class="o">.</span>
  <span class="n">Rerun</span> <span class="n">the</span> <span class="n">command</span> <span class="k">with</span> <span class="n">the</span> <span class="s1">&#39;--backup&#39;</span> <span class="n">flag</span> <span class="n">to</span> <span class="n">first</span> <span class="n">backup</span> <span class="n">these</span> <span class="n">files</span> <span class="p">(</span><span class="o">*.</span><span class="n">bak</span><span class="p">)</span><span class="o">.</span>
  <span class="n">Rerun</span> <span class="n">the</span> <span class="n">command</span> <span class="k">with</span> <span class="n">the</span> <span class="s1">&#39;--overwrite&#39;</span> <span class="n">flag</span> <span class="n">to</span> <span class="n">overwrite</span> <span class="n">these</span> <span class="n">files</span> <span class="n">without</span> <span class="n">backup</span><span class="o">.</span>
</pre></div>
</div>
<p>Because we do not want to replace existing files inadvertently, this command will
always fail, unless you add either the <code class="docutils literal notranslate"><span class="pre">--backup</span></code> flag, in which case <a class="reference external" href="https://micc.readthedocs.io">micc</a> makes
a backup of all files it wants to replace, or the <code class="docutils literal notranslate"><span class="pre">--overwrite</span></code> flag, in which case
those files will be overwritten. <a class="reference external" href="https://micc.readthedocs.io">Micc</a> will always produce a list of files it wants
to replace. You can safely use <code class="docutils literal notranslate"><span class="pre">--overwrite</span></code>, unless you deliberately modified one
of the files in the list (which is rarely needed). If you did change one of the listed
files, however, use the <code class="docutils literal notranslate"><span class="pre">--backup</span></code> flag and manually copy the the changes from the <code class="file docutils literal notranslate"><span class="pre">.bak</span></code>
file to the new file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc convert-to-package --overwrite
Converting simple Python project my_first_project to general Python project.
<span class="o">[</span>WARNING<span class="o">]</span>        <span class="s1">&#39;--overwrite&#39;</span> specified: pre-existing files will be overwritten WITHOUT backup:
<span class="o">[</span>WARNING<span class="o">]</span>        overwriting /Users/etijskens/software/dev/workspace/ET-dot/docs/index.rst
</pre></div>
</div>
<p>and run the <code class="docutils literal notranslate"><span class="pre">info</span></code> command to verify the result:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc info
Project my_first_project located at /Users/etijskens/software/dev/workspace/my_first_project
  package: my_first_project
  version: <span class="m">0</span>.0.0
  structure: my_first_project/__init__.py <span class="o">(</span>Python package<span class="o">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="what-s-in-a-name-intermediate">
<span id="project-and-module-naming"></span><h4>1.1.2 What’s in a name [intermediate]<a class="headerlink" href="#what-s-in-a-name-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>The name you choose for your project has many consequences. Ideally, a project
name is:</p>
<ul class="simple">
<li><p>descriptive,</p></li>
<li><p>unique,</p></li>
<li><p>short.</p></li>
</ul>
<p>Although one might think of even more requirements, such as being easy to type,
satisfying these three is already hard enough.
E.g. <em>my_nifty_module</em> may possibly be unique, but it is neither descriptive,
neither short. On the other hand, <em>dot_product</em> is descriptive, reasonably
short, but probably not unique. Even <em>my_dot_product</em> is probably not
unique, and, in addition, confusing to any user that might want to adopt <em>your</em>
<em>my_dot_product</em>. A unique name - or at least a name that has not been taken
before - becomes really important when you want to publish your code for others
to use it. The standard place to publish Python code is the
<a class="reference external" href="https://pypi.org">Python Package Index</a>, where you find hundreds of thousands
of projects, many of which are really interesting and of high quality. Even if
there are only a few colleagues that you want to share your code with, you make
their life (as well as yours) easier when you publish your <em>my_nifty_module</em> at
<a class="reference external" href="https://pypi.org">PyPI</a>. To install your <code class="docutils literal notranslate"><span class="pre">my_nifty_module</span></code> they will only need to type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">my_nifty_module</span>
</pre></div>
</div>
<p>while having internet access, obviously. The name <em>my_nifty_module</em> is not used
so far, but nevertheless we recommend to choose a better name. <a class="reference external" href="https://micc.readthedocs.io">Micc</a> will help
you publishing your code at <a class="reference external" href="https://pypi.org">PyPI</a>  with as little effort as possible (see
<a class="reference internal" href="#tutorial-5"><span class="std std-ref">Tutorial 5 - Publishing your code</span></a>), provided your name has not been used sofar. Note that
the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">create</span></code> command has a <code class="docutils literal notranslate"><span class="pre">--publish</span></code> flag that checks if the name you
want to use for your project is still available on <a class="reference external" href="https://pypi.org">PyPI</a>, and, if not, refuses to
create the project and asks you to use another name for your project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">create</span> <span class="n">oops</span> <span class="o">--</span><span class="n">publish</span>
<span class="p">[</span><span class="n">ERROR</span><span class="p">]</span>
    <span class="n">The</span> <span class="n">name</span> <span class="s1">&#39;oops&#39;</span> <span class="ow">is</span> <span class="n">already</span> <span class="ow">in</span> <span class="n">use</span> <span class="n">on</span> <span class="n">PyPI</span><span class="o">.</span>
    <span class="n">The</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">created</span><span class="o">.</span>
    <span class="n">You</span> <span class="n">must</span> <span class="n">choose</span> <span class="n">another</span> <span class="n">name</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">publish</span> <span class="n">your</span> <span class="n">code</span><span class="o">.</span>
</pre></div>
</div>
<p>As there are indeed hundreds of thousands of Python packages published on <a class="reference external" href="https://pypi.org">PyPI</a>,
finding a good name has become quite hard. Personally, I often use a simple and
short descriptive name, prefixed by my initials, <code class="docutils literal notranslate"><span class="pre">et-</span></code>, which usually makes
the name unique. E.g <code class="docutils literal notranslate"><span class="pre">et-oops</span></code> does not exist. This has the additional advantage
that all my published modules are grouped in the alphabetic <a class="reference external" href="https://pypi.org">PyPI</a> listing.</p>
<p>Another point of attention is that although in principle project names can be anything
supported by your OS file system, as they are just the name of a directory, <a class="reference external" href="https://micc.readthedocs.io">micc</a>
insists that module and package names comply with the
<a class="reference external" href="https://www.python.org/dev/peps/pep-0008/#package-and-module-names">PEP8 module naming rules</a>.
<a class="reference external" href="https://micc.readthedocs.io">Micc</a> derives the package (or module) name from the project name as follows:</p>
<ul class="simple">
<li><p>capitals are replaced by lower-case</p></li>
<li><p>hyphens``’-‘`` are replaced by underscores <code class="docutils literal notranslate"><span class="pre">'_'</span></code></p></li>
</ul>
<p>If the resulting module name is not PEP8 compliant, you get an informative error
message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">create</span> <span class="mi">1</span><span class="n">proj</span>
<span class="p">[</span><span class="n">ERROR</span><span class="p">]</span>
<span class="n">The</span> <span class="n">project</span> <span class="n">name</span> <span class="p">(</span><span class="mi">1</span><span class="n">proj</span><span class="p">)</span> <span class="n">does</span> <span class="ow">not</span> <span class="k">yield</span> <span class="n">a</span> <span class="n">PEP8</span> <span class="n">compliant</span> <span class="n">module</span> <span class="n">name</span><span class="p">:</span><span class="s2">&quot;</span>
  <span class="n">The</span> <span class="n">project</span> <span class="n">name</span> <span class="n">must</span> <span class="n">start</span> <span class="k">with</span> <span class="n">char</span><span class="p">,</span> <span class="ow">and</span> <span class="n">contain</span> <span class="n">only</span> <span class="n">chars</span><span class="p">,</span> <span class="n">digits</span><span class="p">,</span> <span class="n">hyphens</span> <span class="ow">and</span> <span class="n">underscores</span><span class="o">.</span><span class="s2">&quot;</span>
  <span class="n">Alternatively</span><span class="p">,</span> <span class="n">provide</span> <span class="n">an</span> <span class="n">explicit</span> <span class="n">module</span> <span class="n">name</span> <span class="k">with</span> <span class="n">the</span> <span class="o">--</span><span class="n">module</span><span class="o">-</span><span class="n">name</span><span class="o">=&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>The last line indicates that you can specify an explicit module name, unrelated to
the project name. In that case PEP8 compliance is not checked. The responsability
then is all yours.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="first-steps-in-project-management-using-micc">
<span id="first-steps"></span><h3>1.2 First steps in project management (using micc)<a class="headerlink" href="#first-steps-in-project-management-using-micc" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-project-path-in-micc-intermediate">
<span id="micc-project-path"></span><h4>1.2.1. The project path in micc [intermediate]<a class="headerlink" href="#the-project-path-in-micc-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>All <a class="reference external" href="https://micc.readthedocs.io">micc</a> commands accept the global <code class="docutils literal notranslate"><span class="pre">--project-path=&lt;path&gt;</span></code> parameter. Global
parameters appear before the subcommand name. E.g. the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="o">--</span><span class="n">project</span><span class="o">-</span><span class="n">path</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_first_project</span> <span class="n">info</span>
<span class="n">Project</span> <span class="n">my_first_project</span> <span class="n">located</span> <span class="n">at</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_first_project</span><span class="o">.</span>
  <span class="n">package</span><span class="p">:</span> <span class="n">my_first_project</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span>
  <span class="n">structure</span><span class="p">:</span> <span class="n">my_first_project</span><span class="o">.</span><span class="n">py</span> <span class="p">(</span><span class="n">Python</span> <span class="n">module</span><span class="p">)</span>
</pre></div>
</div>
<p>prints some info on the project at <code class="docutils literal notranslate"><span class="pre">path/to/my_first_project</span></code>. This can conveniently be
abbreviated as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="o">-</span><span class="n">p</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_first_project</span> <span class="n">info</span>
</pre></div>
</div>
<p>Even the <code class="docutils literal notranslate"><span class="pre">create</span></code> command accepts the global <code class="docutils literal notranslate"><span class="pre">--project-path=&lt;path&gt;</span></code> parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="o">-</span><span class="n">p</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_second_project</span> <span class="n">create</span>
</pre></div>
</div>
<p>will create project <code class="docutils literal notranslate"><span class="pre">my_second_project</span></code> in the specified location. The command is
identical to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">create</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_second_project</span>
</pre></div>
</div>
<p>The default value for the project path is the current working directory, so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">info</span>
</pre></div>
</div>
<p>will print info about the project in the current working directory.</p>
<p>Hence, while working on a project, it is convenient to cd into the project directory
and execute your <a class="reference external" href="https://micc.readthedocs.io">micc</a> commands from there, without the the global <code class="docutils literal notranslate"><span class="pre">--project-path=&lt;path&gt;</span></code>
parameter.</p>
<p>This approach works even with the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">create</span></code> command. If you create an empty
directory and <code class="docutils literal notranslate"><span class="pre">cd</span></code> into it, you can just run <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">create</span></code> and it will create
the project in the current working directory, taking the project name from the name
of the current working directory.</p>
</div></blockquote>
</div>
<div class="section" id="virtual-environments">
<span id="id1"></span><h4>1.2.2 Virtual environments<a class="headerlink" href="#virtual-environments" title="Permalink to this headline">¶</a></h4>
<p>Virtual environments enable you to set up a Python environment that isolated
from the installed Python on your system. In this way you can easily cope with varying
dependencies between your Python projects.</p>
<p>For a detailed introduction to virtual environments see
<a class="reference external" href="https://realpython.com/python-virtual-environments-a-primer/">Python Virtual Environments: A Primer</a>.</p>
<p>When you are developing or using several Python projects it can indeed become difficult
for a single Python environment to satisfy all the dependency requirements of these
projects simultaneously. Dependency conflicts can easily arise.
Python promotes and facilitates code reuse and as a consequence Python tools typically
depend on tens to hundreds of other modules. If toolA and toolB both need moduleC, but
each requires a different version of it, there is a conflict because it is impossible
to install two versions of the same module in a Python environment. The solution that
the Python community has come up with for this problem is the construction of <em>virtual
environments</em>, which isolates the dependencies of a single project in a single
environment.</p>
<div class="section" id="creating-virtual-environments">
<span id="venv"></span><h5>1.2.2.1 Creating virtual environments<a class="headerlink" href="#creating-virtual-environments" title="Permalink to this headline">¶</a></h5>
<p>Since Python 3.3 Python comes with a <code class="xref py py-mod docutils literal notranslate"><span class="pre">venv</span></code> module for the creation of
virtual environments. To set up a virtual environment, you first select the Python
version you want to use, e.g. using <a class="reference external" href="https://github.com/pyenv/pyenv">pyenv</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pyenv</span> <span class="n">local</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">python</span> <span class="o">--</span><span class="n">version</span>
<span class="n">Python</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">which</span> <span class="n">python</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/.</span><span class="n">pyenv</span><span class="o">/</span><span class="n">shims</span><span class="o">/</span><span class="n">python</span>
</pre></div>
</div>
<p>Next, create the virtual environment <code class="docutils literal notranslate"><span class="pre">my_virtual_environment</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="n">my_virtual_environment</span>
</pre></div>
</div>
<p>This creates a directory <code class="file docutils literal notranslate"><span class="pre">my_virtual_environment</span></code> in the current working directory
which contains a complete isolated Python environment. To use the virtual environment, you
must <em>activate</em> it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">source</span> <span class="n">my_virtual_environment</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="n">my_virtual_environment</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>Activating a virtual environment modifies the command prompt to remind you constantly
that you are now working in virtual environment <code class="docutils literal notranslate"><span class="pre">my_virtual_environment</span></code>. You can
verify the Python version and its location:</p>
<blockquote>
<div><p>(my_virtual_environment) &gt; python –version
Python 3.7.5
(my_virtual_environment) &gt; which python
path/to/my_virtual_environment/bin/python</p>
</div></blockquote>
<p>If you now install new packages, they will be installed in the virtual environment <strong>only</strong>.
The virtual environment can be <em>deactivated</em> by running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">my_virtual_environment</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">deactivate</span>
<span class="o">&gt;</span>
</pre></div>
</div>
<p>after which the <code class="docutils literal notranslate"><span class="pre">(my_virtual_environment)</span></code> in the prompt disappears, and you are
back to where you created the virtual environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">--</span><span class="n">version</span>
<span class="n">Python</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">which</span> <span class="n">python</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/.</span><span class="n">pyenv</span><span class="o">/</span><span class="n">shims</span><span class="o">/</span><span class="n">python</span>
<span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-virtual-environments-with-poetry">
<span id="venv-poetry"></span><h5>1.2.2.2 Creating virtual environments with Poetry<a class="headerlink" href="#creating-virtual-environments-with-poetry" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="https://python-poetry.org/">Poetry</a> uses the above mechanism to manage virtual environment on a per project
basis, and can install all the dependencies of that project, as specified in the
<code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file, using the <code class="docutils literal notranslate"><span class="pre">install</span></code> command. Since our project does
not have a virtual environment yet, <a class="reference external" href="https://python-poetry.org/">Poetry</a> creates one, named <code class="file docutils literal notranslate"><span class="pre">.venv</span></code>, and
installs all dependencies in it. Again, we first choose the Python version to use
for the project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pyenv</span> <span class="n">local</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">python</span> <span class="o">--</span><span class="n">version</span>
<span class="n">Python</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">which</span> <span class="n">python</span>
<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/.</span><span class="n">pyenv</span><span class="o">/</span><span class="n">shims</span><span class="o">/</span><span class="n">python</span>
</pre></div>
</div>
<p>Next, we <code class="docutils literal notranslate"><span class="pre">cd</span></code> into the project directory and use <a class="reference external" href="https://python-poetry.org/">poetry</a> to create the virtual environment
and at the same install all the project’s dependencies aa specified in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cd</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_first_project</span>
<span class="o">&gt;</span> <span class="n">poetry</span> <span class="n">install</span>
<span class="n">Creating</span> <span class="n">virtualenv</span> <span class="n">et</span><span class="o">-</span><span class="n">dot</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">my_first_project</span><span class="o">/.</span><span class="n">venv</span>
<span class="n">Updating</span> <span class="n">dependencies</span>
<span class="n">Resolving</span> <span class="n">dependencies</span><span class="o">...</span> <span class="p">(</span><span class="mf">0.8</span><span class="n">s</span><span class="p">)</span>

<span class="n">Writing</span> <span class="n">lock</span> <span class="n">file</span>

<span class="n">Package</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">10</span> <span class="n">installs</span><span class="p">,</span> <span class="mi">0</span> <span class="n">updates</span><span class="p">,</span> <span class="mi">0</span> <span class="n">removals</span>

  <span class="o">-</span> <span class="n">Installing</span> <span class="n">pyparsing</span> <span class="p">(</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">six</span> <span class="p">(</span><span class="mf">1.13</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">atomicwrites</span> <span class="p">(</span><span class="mf">1.3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">attrs</span> <span class="p">(</span><span class="mf">19.3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">more</span><span class="o">-</span><span class="n">itertools</span> <span class="p">(</span><span class="mf">7.2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">packaging</span> <span class="p">(</span><span class="mf">19.2</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">pluggy</span> <span class="p">(</span><span class="mf">0.13</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">py</span> <span class="p">(</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">wcwidth</span> <span class="p">(</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">7</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">pytest</span> <span class="p">(</span><span class="mf">4.6</span><span class="o">.</span><span class="mi">6</span><span class="p">)</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">my_first_project</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The installed packages are all dependencies of pytest which we require for testing
our code. The last package is my_first_project itself, which is installed in so-called
<em>development mode</em>. This means that any changes in the source code are immediately
visible in the virtual environment. Adding/removing dependencies is easily achieved
by running <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">add</span> <span class="pre">some_module</span></code> and <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">remove</span> <span class="pre">some_other_module</span></code>.
Consult the <a class="reference external" href="https://python-poetry.org/docs/">poetry_documentation</a> for details.</p>
<p>To use the just created virtual environment of our project, we must activate it,
as before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://python-poetry.org/">Poetry</a> always names the virtual environment of a project <code class="file docutils literal notranslate"><span class="pre">.venv</span></code>. So, when
working on several projects at the same time, you can sometimes get confused which
project’s virtual environment is actually activated. Just run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">which</span> <span class="n">python</span>
<span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_first_project</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>If you no longer need the virtual environment, deactivate it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">deactivate</span>
<span class="o">&gt;</span>
</pre></div>
</div>
<p>If something is wrong with a virtual environment, you can simply delete it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">.</span><span class="n">venv</span>
</pre></div>
</div>
<p>and create it again. Sometimes it is necessary to delete the <code class="file docutils literal notranslate"><span class="pre">poetry.lock</span></code> as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">rm</span> <span class="n">poetry</span><span class="o">.</span><span class="n">lock</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="modules-and-scripts">
<span id="id2"></span><h4>1.2.3 Modules and scripts<a class="headerlink" href="#modules-and-scripts" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> always creates fully functional examples, complete with test code and documentation,
so that you can inspect the files and learn how things are working. The <code class="file docutils literal notranslate"><span class="pre">my_first_project.py</span></code>
module contains a simple <em>hello world</em> method, called <code class="docutils literal notranslate"><span class="pre">hello</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Package my_first_project</span>
<span class="sd">========================</span>

<span class="sd">A &#39;hello world&#39; example.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>


<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&#39;Hello world&#39; method.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;Hello &quot;</span> <span class="o">+</span> <span class="n">who</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>The module can be used right away. Open an interactive Python session and enter the
following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> path/to/my_first_project
&gt; <span class="nb">source</span> .venv/bin/activate
<span class="o">(</span>.venv<span class="o">)</span> &gt; python
Python <span class="m">3</span>.8.0 <span class="o">(</span>default, Nov <span class="m">25</span> <span class="m">2019</span>, <span class="m">20</span>:09:24<span class="o">)</span>
<span class="o">[</span>Clang <span class="m">11</span>.0.0 <span class="o">(</span>clang-1100.0.33.12<span class="o">)]</span> on darwin
Type <span class="s2">&quot;help&quot;</span>, <span class="s2">&quot;copyright&quot;</span>, <span class="s2">&quot;credits&quot;</span> or <span class="s2">&quot;license&quot;</span> <span class="k">for</span> more information.
&gt;&gt;&gt; import my_first_project
&gt;&gt;&gt; my_first_project.hello<span class="o">()</span>
<span class="s1">&#39;Hello world&#39;</span>
&gt;&gt;&gt; my_first_project.hello<span class="o">(</span><span class="s2">&quot;student&quot;</span><span class="o">)</span>
<span class="s1">&#39;Hello student&#39;</span>
&gt;&gt;&gt;
</pre></div>
</div>
<p><strong>Productivity tip</strong></p>
<p>Using an interactive python session to verify that a module does indeed what
you expect is a bit cumbersome. A quicker way is to modify the module so that it
can also behave as a script. Add the following lines to <code class="file docutils literal notranslate"><span class="pre">my_first_project.py</span></code>
at the end of the file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">hello</span><span class="p">())</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">hello</span><span class="p">(</span><span class="s2">&quot;student&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>and execute it on the command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> &gt; python my_first_project.py
Hello world
Hello student
</pre></div>
</div>
<p>The body of the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__==&quot;__main__&quot;:</span></code> statement is only executed if the file
is executed as a script. When the file is imported, the condition is <code class="docutils literal notranslate"><span class="pre">False</span></code>, and
the body (the script part) is ignored.</p>
<p>While working on a single-file project it is sometimes handy to put your tests
the body of <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__==&quot;__main__&quot;:</span></code>, as below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
   <span class="k">assert</span> <span class="n">hello</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Hello world&quot;</span>
   <span class="k">assert</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;student&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Hello student&quot;</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-*# success #*-&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The last line makes sure that you get a message that all tests went well if they
did, otherwise an <code class="xref py py-exc docutils literal notranslate"><span class="pre">AssertionError</span></code> will be raised.
When you now execute the script, you should see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">python</span> <span class="n">my_first_project</span><span class="o">.</span><span class="n">py</span>
<span class="o">-*</span><span class="c1"># success #*-</span>
</pre></div>
</div>
<p>When you develop your code in an IDE like <a class="reference external" href="https://www.pydev.org">eclipse+pydev</a> or
<a class="reference external" href="https://www.jetbrains.com/pycharm/">PyCharm</a>, you can even execute the file without
having to leave your editor and switch to a terminal. You can quickly code, test and
debug in a single window.</p>
<p>While this is a very productive way of developing, it is a bit on the <em>quick and dirty</em>
side. If the module code and the tests become more involved, however,the file will soon
become cluttered with test code and a more scalable way to organise your tests is needed.
<a class="reference external" href="https://micc.readthedocs.io">Micc</a> has already taken care of this.</p>
</div>
<div class="section" id="testing-your-code">
<span id="testing"></span><h4>1.2.4 Testing your code<a class="headerlink" href="#testing-your-code" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Test-driven_development">Test driven development</a> is a
software development process that relies on the repetition of a very short development cycle:
requirements are turned into very specific test cases, then the code is improved so that the
tests pass. This is opposed to software development that allows code to be added that is not
proven to meet requirements. The advantage of this is clear: the shorter the cycle, the
smaller the code that is to be searched for bugs. This allows you to produce correct code
faster, and in case you are a beginner, also speeds your learning of Python. Please check
Ned Batchelder’s very good introduction to <a class="reference external" href="https://nedbatchelder.com/text/test3.html">testing with pytest</a>.</p>
<p>When <a class="reference external" href="https://micc.readthedocs.io">micc</a> creates a new project, or when you add components to an existing project,
it immediately adds a test script for each component in the <code class="file docutils literal notranslate"><span class="pre">tests</span></code> directory.
The test script for the <code class="xref py py-mod docutils literal notranslate"><span class="pre">my_first_project</span></code> module is in file <code class="file docutils literal notranslate"><span class="pre">ET-dot/tests/test_my_first_project.py</span></code>.
Let’s take a look at the relevant section:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Tests for my_first_project package.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">my_first_project</span>

<span class="k">def</span> <span class="nf">test_hello_noargs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test for my_first_project.hello().&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">my_first_project</span><span class="o">.</span><span class="n">hello</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">s</span><span class="o">==</span><span class="s2">&quot;Hello world&quot;</span>

<span class="k">def</span> <span class="nf">test_hello_me</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test for my_first_project.hello(&#39;me&#39;).&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">my_first_project</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s1">&#39;me&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">s</span><span class="o">==</span><span class="s2">&quot;Hello me&quot;</span>
</pre></div>
</div>
<p>Tests like this are very useful to ensure that during development the changes to
your code do not break things. There are many Python tools for unit testing and test
driven development. Here, we use <a class="reference external" href="https://pytest.org/en/latest/">Pytest</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nv">pytest</span>
<span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform darwin -- Python <span class="m">3</span>.7.4, pytest-4.6.5, py-1.8.0, pluggy-0.13.0
rootdir: /Users/etijskens/software/dev/workspace/my_first_project
collected <span class="m">2</span> items

tests/test_my_first_project.py ..                                                        <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">============================</span> <span class="m">2</span> passed <span class="k">in</span> <span class="m">0</span>.05 <span class="nv">seconds</span> <span class="o">=============================</span>
</pre></div>
</div>
<p>The output shows some info about the environment in which we are running the tests,
the current working directory (c.q. the project directory, and the number of tests
it collected (2). <a class="reference external" href="https://pytest.org/en/latest/">Pytest</a> looks for test methods in all <code class="file docutils literal notranslate"><span class="pre">test_*.py</span></code> or
<code class="file docutils literal notranslate"><span class="pre">*_test.py</span></code> files in the current directory and accepts <code class="docutils literal notranslate"><span class="pre">test</span></code> prefixed methods
outside classes and <code class="docutils literal notranslate"><span class="pre">test</span></code> prefixed methods inside <code class="docutils literal notranslate"><span class="pre">Test</span></code> prefixed classes as test
methods to be executed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sometimes <a class="reference external" href="https://pytest.org/en/latest/">pytest</a> discovers unintended test files or functions in other directories
than the <code class="file docutils literal notranslate"><span class="pre">tests</span></code> directory, leading to puzzling errors. It is therefore safe
to instruct <a class="reference external" href="https://pytest.org/en/latest/">pytest</a> to look only in the <code class="file docutils literal notranslate"><span class="pre">tests</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pytest</span> <span class="n">tests</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<p>If a test would fail you get a detailed report to help you find the cause of the
error and fix it.</p>
<div class="section" id="debugging-test-code">
<span id="debug-test-code"></span><h5>1.2.4.1 Debugging test code<a class="headerlink" href="#debugging-test-code" title="Permalink to this headline">¶</a></h5>
<p>When the report provided by <a class="reference external" href="https://pytest.org/en/latest/">pytest</a> does not yield a clue on the
cause of the failing test, you must use debugging and execute the failing test step
by step to find out what is going wrong where. From the viewpoint of <a class="reference external" href="https://pytest.org/en/latest/">pytest</a>, the
files in the <code class="file docutils literal notranslate"><span class="pre">tests</span></code> directory are modules. <a class="reference external" href="https://pytest.org/en/latest/">Pytest</a> imports them and collects
the test methods, and executes them. <a class="reference external" href="https://micc.readthedocs.io">Micc</a> also makes every test module executable using
the technique described in <a class="reference internal" href="#modules-and-scripts"><span class="std std-ref">1.2.3 Modules and scripts</span></a>. At the end of every test file you
will find some extra code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">the_test_you_want_to_debug</span> <span class="o">=</span> <span class="n">test_hello_noargs</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__main__ running&quot;</span><span class="p">,</span> <span class="n">the_test_you_want_to_debug</span><span class="p">)</span>
    <span class="n">the_test_you_want_to_debug</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-*# finished #*-&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On the first line of the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">&quot;__main__&quot;:</span></code> body, the name of the test method
we want to debug is set to variable <code class="docutils literal notranslate"><span class="pre">the_test_you_want_to_debug</span></code>, here <code class="docutils literal notranslate"><span class="pre">test_hello_noargs</span></code>.
The variable thus becomes an alias for the test method. Line 2 prints a message with the name
of the test method being debugged:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">python</span> <span class="n">tests</span><span class="o">/</span><span class="n">test_et_dot</span><span class="o">.</span><span class="n">py</span>
<span class="n">__main__</span> <span class="n">running</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">test_hello_noargs</span> <span class="n">at</span> <span class="mh">0x1037337a0</span><span class="o">&gt;</span>     <span class="c1"># output of line 2</span>
<span class="o">-*</span><span class="c1"># finished #*-                                                 # output of line 4</span>
</pre></div>
</div>
<p>Line 3 actually calls the test method. Finally, line 4  prints a message to let the user know
that the script is finished.</p>
<p>You can use your favourite Python debugger to execute this script and step into the
<code class="docutils literal notranslate"><span class="pre">test_hello_noargs</span></code> test method and from there into <code class="docutils literal notranslate"><span class="pre">my_first_project.hello</span></code> to
examine if everything goes as expected.</p>
</div>
</div>
<div class="section" id="generating-documentation-intermediate">
<span id="generate-doc"></span><h4>1.2.5 Generating documentation [intermediate]<a class="headerlink" href="#generating-documentation-intermediate" title="Permalink to this headline">¶</a></h4>
<p>Documentation is extracted from the source code using <a class="reference external" href="http://www.sphinx-doc.org/en/master/">Sphinx</a>.
It is almost completely generated automatically from the doc-strings in your code. Doc-strings are the
text between triple double quote pairs in the examples above, e.g. <code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;This</span> <span class="pre">is</span> <span class="pre">a</span> <span class="pre">doc-string.&quot;&quot;&quot;</span></code>.
Important doc-strings are:</p>
<ul class="simple">
<li><p><em>module</em> doc-strings: at the beginning of the module. Provides an overview of what the
module is for.</p></li>
<li><p><em>class</em> doc-strings: right after the <code class="docutils literal notranslate"><span class="pre">class</span></code> statement: explains what the class is for.
(Usually, the doc-string of the __init__ method is put here as well, as <em>dunder</em> methods
(starting and ending with a double underscore) are not automatically considered by <a class="reference external" href="http://www.sphinx-doc.org/en/master/">sphinx</a>.</p></li>
<li><p><em>method</em> doc-strings: right after a <code class="docutils literal notranslate"><span class="pre">def</span></code> statement.</p></li>
</ul>
<p>According to <a class="reference external" href="https://www.python.org/dev/peps/pep-0287/">pep-0287</a> the recommended format for
Python doc-strings is <a class="reference external" href="http://www.sphinx-doc.org/en/master/usage/restructuredtext/index.html">restructuredText</a>.
E.g. a typical method doc-string looks like this:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">who</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Short (one line) description of the hello_world method.</span>

<span class="sd">    A detailed and longer description of the hello_world method.</span>
<span class="sd">    blablabla...</span>

<span class="sd">    :param str who: an explanation of the who parameter. You should</span>
<span class="sd">        mention e.g. its default value.</span>
<span class="sd">    :returns: a description of what hello_world returns (if relevant).</span>
<span class="sd">    :raises: which exceptions are raised under what conditions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Here, you can find some more <a class="reference external" href="http://queirozf.com/entries/python-docstrings-reference-examples">examples</a>.</p>
<p>Thus, if you take good care writing doc-strings, helpful documentation follows automatically.</p>
<p>Micc sets up al the necessary components for documentation generation in sub-directory
<code class="file docutils literal notranslate"><span class="pre">et-dot/docs/</span></code>. There, you find a <code class="file docutils literal notranslate"><span class="pre">Makefile</span></code> that provides a simple interface
to <a class="reference external" href="http://www.sphinx-doc.org/en/master/">Sphinx</a>. Here is the workflow that is necessary to build the documentation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> path/to/et-dot
&gt; <span class="nb">source</span> .venv/bin/activate
<span class="o">(</span>.venv<span class="o">)</span> &gt; <span class="nb">cd</span> docs
<span class="o">(</span>.venv<span class="o">)</span> &gt; make html
</pre></div>
</div>
<p>The last line produces documentation in html format.</p>
<p>Let’s explain the steps</p>
<ol class="arabic">
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span></code> into the project directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cd</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">et</span><span class="o">-</span><span class="n">dot</span>
<span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p>Activate the project’s virtual environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>This is necessary because the tools for documentation generation are installed there.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span></code> into the docs subdirectory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cd</span> <span class="n">docs</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>Here, you will find the <code class="file docutils literal notranslate"><span class="pre">Makefile</span></code> that does the work:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span>
<span class="n">total</span> <span class="mi">80</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">etijskens</span>  <span class="n">staff</span>  <span class="mi">1871</span> <span class="n">Dec</span> <span class="mi">10</span> <span class="mi">11</span><span class="p">:</span><span class="mi">24</span> <span class="n">Makefile</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ol>
<p>To see a list of possible documentation formats, just run <code class="docutils literal notranslate"><span class="pre">make</span></code> without arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(.venv) &gt; make
Sphinx v2.2.2
Please use `make target&#39; where target is one of
  html        to make standalone HTML files
  dirhtml     to make HTML files named index.html in directories
  singlehtml  to make a single large HTML file
  pickle      to make pickle files
  json        to make JSON files
  htmlhelp    to make HTML files and an HTML help project
  qthelp      to make HTML files and a qthelp project
  devhelp     to make HTML files and a Devhelp project
  epub        to make an epub
  latex       to make LaTeX files, you can set PAPER=a4 or PAPER=letter
  latexpdf    to make LaTeX and PDF files (default pdflatex)
  latexpdfja  to make LaTeX files and run them through platex/dvipdfmx
  text        to make text files
  man         to make manual pages
  texinfo     to make Texinfo files
  info        to make Texinfo files and run them through makeinfo
  gettext     to make PO message catalogs
  changes     to make an overview of all changed/added/deprecated items
  xml         to make Docutils-native XML files
  pseudoxml   to make pseudoxml-XML files for display purposes
  linkcheck   to check all external links for integrity
  doctest     to run all doctests embedded in the documentation (if enabled)
  coverage    to run coverage check of the documentation (if enabled)
(.venv) &gt;
</pre></div>
</div>
<ol class="arabic">
<li><p>To build documentation in html format, enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">make</span> <span class="n">html</span>
<span class="o">...</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>This will generation documentation in <code class="file docutils literal notranslate"><span class="pre">et-dot/docs/_build/html</span></code>. Note that
<strong>it is essential that this command executes in the project’s virtual environment</strong>.
You can view the documentation in your favorite browser:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">open</span> <span class="n">_build</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>       <span class="c1"># on macosx</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xdg</span><span class="o">-</span><span class="nb">open</span> <span class="n">_build</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>   <span class="c1"># on ubuntu</span>
</pre></div>
</div>
<p>(On the cluster the command will fail because it does not have a graphical environment
and it cannot run a html-browser.)</p>
<p>Here is a screenshot:</p>
<img alt="_images/im1-1.png" src="_images/im1-1.png" />
<p>If your expand the <strong>API</strong> tab on the left, you get to see the <code class="xref py py-mod docutils literal notranslate"><span class="pre">my_first_project</span></code>
module documentation, as it generated from the doc-strings:</p>
<img alt="_images/im1-2.png" src="_images/im1-2.png" />
</li>
<li><p>To build documentation in .pdf format, enter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">make</span> <span class="n">latexpdf</span>
</pre></div>
</div>
<p>This will generation documentation in :<a class="reference external" href="file:et-dot/docs/_build/latex/et-dot">file:et-dot/docs/_build/latex/et-dot</a>.pdf`.
You can view it in your favorite pdf viewer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">open</span> <span class="n">_build</span><span class="o">/</span><span class="n">latex</span><span class="o">/</span><span class="n">et</span><span class="o">-</span><span class="n">dot</span><span class="o">.</span><span class="n">pdf</span>      <span class="c1"># on macosx</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xdg</span><span class="o">-</span><span class="nb">open</span> <span class="n">_build</span><span class="o">/</span><span class="n">latex</span><span class="o">/</span><span class="n">et</span><span class="o">-</span><span class="n">dot</span><span class="o">.</span><span class="n">pdf</span>      <span class="c1"># on ubuntu</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When building documentation by running the <code class="file docutils literal notranslate"><span class="pre">docs/Makefile</span></code>, it is
verified that the correct virtual environment is activated, and that the needed
Python modules are installed in that environment. If not, they are first installed
using <cite>pip install</cite>. These components are not becoming dependencies of the project.
If needed you can add dependencies using the <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">add</span></code> command.</p>
</div>
<p>The boilerplate code for documentation generation is in the <code class="docutils literal notranslate"><span class="pre">docs</span></code> directory, just as
if it were generated by hand using the <code class="docutils literal notranslate"><span class="pre">sphinx-quickstart</span></code> command. (In fact, it was
generated using <code class="docutils literal notranslate"><span class="pre">sphinx-quickstart</span></code>, but then turned into a
<a class="reference external" href="https://github.com/audreyr/cookiecutter-pypackage">Cookiecutter</a> template.)
those files is not recommended, and only rarely needed. Then there are a number
of <code class="file docutils literal notranslate"><span class="pre">.rst</span></code> files with <strong>capitalized</strong> names in the <strong>project directory</strong>:</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">README.rst</span></code> is assumed to contain an overview of the project,</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">API.rst</span></code> describes the classes and methods of the project in detail,</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">APPS.rst</span></code> describes command line interfaces or apps added to your project.</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">AUTHORS.rst</span></code> list the contributors to the project</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">HISTORY.rst</span></code> which should describe the changes that were made to the code.</p></li>
</ul>
<p>The <code class="file docutils literal notranslate"><span class="pre">.rst</span></code> extenstion stands for <a class="reference external" href="http://www.sphinx-doc.org/en/master/usage/restructuredtext/index.html">reStructuredText</a>. It is a simple and concise
approach to text formatting.</p>
<p>If you add components to your project through <a class="reference external" href="https://micc.readthedocs.io">micc</a>, care is taken that the
<code class="file docutils literal notranslate"><span class="pre">.rst</span></code> files in the project directory and the <code class="file docutils literal notranslate"><span class="pre">docs</span></code> directory are
modified as necessary, so that <a class="reference external" href="http://www.sphinx-doc.org/en/master/">sphinx</a> is able find the doc-strings. Even for
command line interfaces (CLI, or console scripts) based on
<a class="reference external" href="https://click.palletsprojects.com/en/7.x/">click</a> the documentation is generated
neatly from the <code class="xref py py-obj docutils literal notranslate"><span class="pre">help</span></code> strings of options and the doc-strings of the commands.</p>
</div>
<div class="section" id="version-control-advanced">
<span id="version-control"></span><h4>1.2.6 Version control [advanced]<a class="headerlink" href="#version-control-advanced" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>Although version control is extremely important for any software project
with a lifetime of more a day, we mark it as an advanced topic as it does
not affect the development itself. <a class="reference external" href="https://micc.readthedocs.io">Micc</a> facilitates version control by
automatically creating a local <a class="reference external" href="https://git-scm.com">git</a> repository in your project directory.
If you do not want to use it, you may ignore it or even delete it.</p>
<p><a class="reference external" href="https://git-scm.com">Git</a> is a version control system that solves many practical problems related
to the process software development, independent of whether your are the only
developer, or there is an entire team working on it from different places in
the world. You find more information about how <a class="reference external" href="https://micc.readthedocs.io">micc</a> uses <a class="reference external" href="https://git-scm.com">git</a> in <a class="reference internal" href="#tutorial-4"><span class="std std-ref">Tutorial 4: Version control and version management</span></a>.</p>
<p>Let’s take a close look at the output of the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">create</span> <span class="pre">my_first_project</span></code>
command. The first line tells us that a project directory is being created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">[</span> <span class="n">Creating</span> <span class="n">project</span> <span class="p">(</span><span class="n">my_first_project</span><span class="p">):</span>
</pre></div>
</div>
<p>The next line explains the structure of the project, module or package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="n">Python</span> <span class="n">module</span> <span class="p">(</span><span class="n">my_first_project</span><span class="p">):</span> <span class="n">structure</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_first_project</span><span class="o">/</span><span class="n">my_first_project</span><span class="o">.</span><span class="n">py</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we are informed that a local <a class="reference external" href="https://git-scm.com">git</a> repository is being created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="p">[</span> <span class="n">Creating</span> <span class="n">git</span> <span class="n">repository</span>
</pre></div>
</div>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> tries to push this local repository to a remote repository at
<a class="reference external" href="https://github.com/yourgitaccount">https://github.com/yourgitaccount</a>. If you did not create a remote <a class="reference external" href="https://git-scm.com">git</a>
repository on beforehand, this gives rise to some warnings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">WARNING</span><span class="p">]</span>                    <span class="o">&gt;</span> <span class="n">git</span> <span class="n">push</span> <span class="o">-</span><span class="n">u</span> <span class="n">origin</span> <span class="n">master</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]</span>                    <span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
                             <span class="n">remote</span><span class="p">:</span> <span class="n">Repository</span> <span class="ow">not</span> <span class="n">found</span><span class="o">.</span>
                             <span class="n">fatal</span><span class="p">:</span> <span class="n">repository</span> <span class="s1">&#39;https://github.com/yourgitaccount/my_first_project/&#39;</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> is unable to push the local repo to github, if the remote repo does
not exist. The local repo is for many purposes sufficient, but the remote
repo enables sharing your work with others and provides a backup of your work.</p>
<p>Finally, <a class="reference external" href="https://micc.readthedocs.io">micc</a> informs us that the tasks are finished.</p>
<blockquote>
<div><p>[INFO]               ] done.
[INFO]           ] done.
&gt;</p>
</div></blockquote>
<p>Note that the name of the remote git repo is the project name, not the module name.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="miscellaneous">
<span id="id3"></span><h3>1.3 Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-license-file-intermediate">
<span id="license"></span><h4>1.3.1 The license file [intermediate]<a class="headerlink" href="#the-license-file-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>The project directory contains a <code class="file docutils literal notranslate"><span class="pre">LICENCE</span></code> file, a <code class="file docutils literal notranslate"><span class="pre">text</span></code> file
describing the licence applicable to your project. You can choose between</p>
<ul class="simple">
<li><p>MIT license (default),</p></li>
<li><p>BSD license,</p></li>
<li><p>ISC license,</p></li>
<li><p>Apache Software License 2.0,</p></li>
<li><p>GNU General Public License v3 and</p></li>
<li><p>Not open source.</p></li>
</ul>
<p>MIT license is a very liberal license and the default option. If you’re unsure which
license to choose, you can use resources such as <a class="reference external" href="https://choosealicense.com">GitHub’s Choose a License</a></p>
<p>You can select the license file when you create the project:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">cd</span> some_empty_dir
&gt; micc create --license BSD
</pre></div>
</div>
<p>Of course, the project depends in no way on the license file, so it can
be replaced manually at any time by the license you desire.</p>
</div></blockquote>
</div>
<div class="section" id="the-pyproject-toml-file-intermediate">
<span id="pyproject-toml"></span><h4>1.3.2 The pyproject.toml file [intermediate]<a class="headerlink" href="#the-pyproject-toml-file-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>The file <code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code> (located in the project directory) is the
modern way to describe the build system requirements of the project:
<a class="reference external" href="https://www.python.org/dev/peps/pep-0518/">PEP 518</a>. Although most of
this file’s content is generated automatically by <a class="reference external" href="https://micc.readthedocs.io">micc</a> and <a class="reference external" href="https://python-poetry.org/">poetry</a> some
understanding of it is useful, consult <a class="reference external" href="https://poetry.eustace.io/docs/pyproject/">https://poetry.eustace.io/docs/pyproject/</a>.</p>
<p>The <code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file is rather human-readable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cat</span> <span class="n">pyproject</span><span class="o">.</span><span class="n">toml</span>
<span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">poetry</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ET-dot&quot;</span>
<span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&lt;Enter a one-sentence description of this project here.&gt;&quot;</span>
<span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Engelbert Tijskens &lt;engelbert.tijskens@uantwerpen.be&gt;&quot;</span><span class="p">]</span>
<span class="n">license</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="n">readme</span> <span class="o">=</span> <span class="s1">&#39;README.rst&#39;</span>

<span class="n">repository</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/etijskens/ET-dot&quot;</span>
<span class="n">homepage</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/etijskens/ET-dot&quot;</span>

<span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;packaging&#39;</span><span class="p">,</span> <span class="s1">&#39;poetry&#39;</span><span class="p">]</span>

<span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">poetry</span><span class="o">.</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">python</span> <span class="o">=</span> <span class="s2">&quot;^3.7&quot;</span>
<span class="n">et</span><span class="o">-</span><span class="n">micc</span><span class="o">-</span><span class="n">build</span> <span class="o">=</span> <span class="s2">&quot;^0.10.10&quot;</span>

<span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">poetry</span><span class="o">.</span><span class="n">dev</span><span class="o">-</span><span class="n">dependencies</span><span class="p">]</span>
<span class="n">pytest</span> <span class="o">=</span> <span class="s2">&quot;^4.4.2&quot;</span>

<span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">poetry</span><span class="o">.</span><span class="n">scripts</span><span class="p">]</span>

<span class="p">[</span><span class="n">build</span><span class="o">-</span><span class="n">system</span><span class="p">]</span>
<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;poetry&gt;=0.12&quot;</span><span class="p">]</span>
<span class="n">build</span><span class="o">-</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;poetry.masonry.api&quot;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="the-log-file-micc-log-intermediate">
<span id="log-file"></span><h4>1.3.3 The log file Micc.log [intermediate]<a class="headerlink" href="#the-log-file-micc-log-intermediate" title="Permalink to this headline">¶</a></h4>
<p>The project directory also contains a log file <code class="file docutils literal notranslate"><span class="pre">micc.log</span></code>. All <a class="reference external" href="https://micc.readthedocs.io">micc</a> commands
that modify the state of the project leave a trace in this file, So you can look up
what happened when to your project. Should you think that the log file has become
too big, or just useless, you can delete it manually, or add the <code class="docutils literal notranslate"><span class="pre">--clear-log</span></code> flag
before any <a class="reference external" href="https://micc.readthedocs.io">micc</a> subcommand, to remove it. If the subcommand alters the state of the
project, the log file will only contain the log messages from the last subcommand.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; ll micc.log
-rw-r--r--  <span class="m">1</span> etijskens  staff  <span class="m">34</span> Oct <span class="m">10</span> <span class="m">20</span>:37 micc.log

&gt; micc --clear-log info
Project bar located at /Users/etijskens/software/dev/workspace/bar
  package: bar
  version: <span class="m">0</span>.0.0
  structure: bar.py <span class="o">(</span>Python module<span class="o">)</span>

&gt; ll micc.log
ls: micc.log: No such file or directory
</pre></div>
</div>
</div>
<div class="section" id="adjusting-micc-to-your-needs-advanced">
<span id="adjusting-micc"></span><h4>1.3.4 Adjusting micc to your needs [advanced]<a class="headerlink" href="#adjusting-micc-to-your-needs-advanced" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> is based on a series of additive <a class="reference external" href="https://github.com/audreyr/cookiecutter-pypackage">Cookiecutter</a> templates which generate the
boilerplate code. If you like, you can tweak these templates in the
<code class="file docutils literal notranslate"><span class="pre">site-packages/et_micc/templates</span></code> directory of your <a class="reference external" href="https://micc.readthedocs.io">micc</a> installation. When you
<code class="docutils literal notranslate"><span class="pre">pipx</span></code> installed <a class="reference external" href="https://micc.readthedocs.io">micc</a>, that is typically something like:</p>
<blockquote>
<div><p><code class="file docutils literal notranslate"><span class="pre">~/.local/pipx/venvs/et-micc/lib/pythonX.Y/site-packages/et_micc</span></code>,</p>
</div></blockquote>
<p>where :file`pythonX.Y` is the python version you installed <a class="reference external" href="https://micc.readthedocs.io">micc</a> with.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="a-first-real-project">
<span id="first-project"></span><h3>1.4 A first real project<a class="headerlink" href="#a-first-real-project" title="Permalink to this headline">¶</a></h3>
<p>Let’s start with a simple problem: a Python module that computes the
<a class="reference external" href="https://en.wikipedia.org/wiki/Dot_product">scalar product of two arrays</a>,
generally referred to as the <em>dot product</em>.
Admittedly, this not a very rewarding goal, as there are already many Python
packages, e.g. <a class="reference external" href="https://numpy.org">Numpy</a>, that solve this problem in an elegant and efficient way.
However, because the dot product is such a simple concept in linear algebra,
it allows us to illustrate the usefulness of Python as a language for High
Performance Computing, as well as the capabilities of <a class="reference external" href="https://micc.readthedocs.io">Micc</a>.</p>
<p>First, set up a new project for this <em>dot</em> project, which i named <em>ET-dot</em>, <em>ET</em>
being my initials. Not knowing beforehand how involved this project will become,
we create a simple <em>module</em> project:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc -p ET-dot create
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">[</span> Creating project <span class="o">(</span>ET-dot<span class="o">)</span>:
<span class="o">[</span>INFO<span class="o">]</span>               Python module <span class="o">(</span>my_first_project<span class="o">)</span>: <span class="nv">structure</span> <span class="o">=</span> <span class="o">(</span>ET-dot/et_dot.py
<span class="o">[</span>INFO<span class="o">]</span>               <span class="o">[</span> Creating git repository
<span class="o">[</span>WARNING<span class="o">]</span>                    &gt; git push -u origin master
<span class="o">[</span>WARNING<span class="o">]</span>                    <span class="o">(</span>stderr<span class="o">)</span>
                             remote: Repository not found.
                             fatal: repository <span class="s1">&#39;https://github.com/etijskens/ET-dot/&#39;</span> not found
<span class="o">[</span>INFO<span class="o">]</span>               <span class="o">]</span> <span class="k">done</span>.
<span class="o">[</span>WARNING<span class="o">]</span>            Run <span class="s1">&#39;poetry install&#39;</span> <span class="k">in</span> the project directory to create a virtual environment and install its dependencies.
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">]</span> <span class="k">done</span>.
&gt; <span class="nb">cd</span> ET-dot
</pre></div>
</div>
<p>As the output shows the module name is converted from the project name and made compliant with the
<a class="reference external" href="https://www.python.org/dev/peps/pep-0008/#package-and-module-names">PEP8 module naming rules</a>:
<em>et_dot</em>. Next, we create a virtual environment for the project with all the standard <a class="reference external" href="https://micc.readthedocs.io">micc</a>
dependencies:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; poetry install
Creating virtualenv et-dot <span class="k">in</span> /Users/etijskens/software/dev/workspace/tmp/ET-dot/.venv
Updating dependencies
Resolving dependencies... <span class="o">(</span><span class="m">0</span>.8s<span class="o">)</span>

Writing lock file


Package operations: <span class="m">10</span> installs, <span class="m">0</span> updates, <span class="m">0</span> removals

  - Installing pyparsing <span class="o">(</span><span class="m">2</span>.4.5<span class="o">)</span>
  - Installing six <span class="o">(</span><span class="m">1</span>.13.0<span class="o">)</span>
  - Installing atomicwrites <span class="o">(</span><span class="m">1</span>.3.0<span class="o">)</span>
  - Installing attrs <span class="o">(</span><span class="m">19</span>.3.0<span class="o">)</span>
  - Installing more-itertools <span class="o">(</span><span class="m">8</span>.0.2<span class="o">)</span>
  - Installing packaging <span class="o">(</span><span class="m">19</span>.2<span class="o">)</span>
  - Installing pluggy <span class="o">(</span><span class="m">0</span>.13.1<span class="o">)</span>
  - Installing py <span class="o">(</span><span class="m">1</span>.8.0<span class="o">)</span>
  - Installing wcwidth <span class="o">(</span><span class="m">0</span>.1.7<span class="o">)</span>
  - Installing pytest <span class="o">(</span><span class="m">4</span>.6.7<span class="o">)</span>
  - Installing ET-dot <span class="o">(</span><span class="m">0</span>.0.0<span class="o">)</span>
&gt;
</pre></div>
</div>
<p>Next, activate the virtual environment:</p>
<blockquote>
<div><p>&gt; source .venv/bin/activate
(.venv) &gt;</p>
</div></blockquote>
<p>Open module file <code class="file docutils literal notranslate"><span class="pre">et_dot.py</span></code> in your favourite editor and code a dot product
method (naievely) as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Package et_dot</span>
<span class="sd">==============</span>
<span class="sd">Python module for computing the dot product of two arrays.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.0.0&quot;</span>

<span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the dot product of *a* and *b*.</span>

<span class="sd">    :param a: a 1D array.</span>
<span class="sd">    :param b: a 1D array of the same length as *a*.</span>
<span class="sd">    :returns: the dot product of *a* and *b*.</span>
<span class="sd">    :raises: ArithmeticError if ``len(a)!=len(b)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">!=</span><span class="n">n</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ArithmeticError</span><span class="p">(</span><span class="s2">&quot;dot(a,b) requires len(a)==len(b).&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>We defined a <code class="xref py py-meth docutils literal notranslate"><span class="pre">dot()</span></code> method with an informative doc-string that describes
the parameters, the return value and the kind of exceptions it may raise.</p>
<p>We could use the dot method in a script as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">et_dot</span> <span class="kn">import</span> <span class="n">dot</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.1</span><span class="p">,</span><span class="mf">4.2</span><span class="p">,</span><span class="mf">4.3</span><span class="p">]</span>
<span class="n">a_dot_b</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This dot product implementation is naive for many reasons:</p>
<ul class="simple">
<li><p>Python is very slow at executing loops, as compared to Fortran or C++.</p></li>
<li><p>The objects we are passing in are plain Python <code class="xref py py-obj docutils literal notranslate"><span class="pre">list`s.</span> <span class="pre">A</span> <span class="pre">:py:obj:`list</span></code>
is a very powerfull data structure, with array-like properties, but it is not
exactly an array. A <code class="xref py py-obj docutils literal notranslate"><span class="pre">list</span></code> is in fact an array of pointers to Python
objects, and therefor list elements can reference anything, not just a numeric value
as we would expect from an array. With elements being pointers, looping over the
array elements implies non-contiguous memory access, another source of inefficiency.</p></li>
<li><p>The dot product is a subject of Linear Algebra. Many excellent libraries have been
designed for this purpose. <a class="reference external" href="https://numpy.org">Numpy</a> should be your starting
point because it is well integrated with many other Python packages. There is also
<a class="reference external" href="http://eigen.tuxfamily.org/index.php?title=Main_Page">Eigen</a>
a C++ library for linear algebra that is neatly exposed to Python by
<a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a>.</p></li>
</ul>
<p>However, starting out with a simple and naive implementation is not a bad idea at all.
Once it is correct, it can serve as reference implementation to test any improvements
against it.</p>
</div>
<p>In order to proof that our implementation of the dot product is correct, we write some
tests. For this we open the file <code class="docutils literal notranslate"><span class="pre">tests/test_et_dot.py</span></code>. Remove the original tests put in
by <a class="reference external" href="https://micc.readthedocs.io">micc</a>, and add a new one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">et_dot</span>

<span class="k">def</span> <span class="nf">test_dot_aa</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">==</span><span class="n">expected</span>
</pre></div>
</div>
<p>Save the file, and run the test. <a class="reference external" href="https://pytest.org/en/latest/">Pytest</a> will show a line for every test source file.
On each such line a <code class="docutils literal notranslate"><span class="pre">.</span></code> will appear for every successfull test, and a <code class="docutils literal notranslate"><span class="pre">F</span></code> for a
failing test.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> &gt; <span class="nv">pytest</span>
<span class="o">===============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===============================</span>
platform darwin -- Python <span class="m">3</span>.7.4, pytest-4.6.5, py-1.8.0, pluggy-0.13.0
rootdir: /Users/etijskens/software/dev/workspace/ET-dot
collected <span class="m">1</span> item

tests/test_et_dot.py .                                                      <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">============================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.08 <span class="nv">seconds</span> <span class="o">=============================</span>
<span class="o">(</span>.venv<span class="o">)</span> &gt;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the project’s virtual environment is not activated, the command <code class="docutils literal notranslate"><span class="pre">pytest</span></code>
will generally not be found.</p>
</div>
<p>Great! our test succeeded. Let’s increment the project’s version (<code class="docutils literal notranslate"><span class="pre">-p</span></code> is short for <code class="docutils literal notranslate"><span class="pre">--patch</span></code>,
and requests incrementing the patch component of the version string):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">micc</span> <span class="n">version</span> <span class="o">-</span><span class="n">p</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">(</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">version</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>You can read more about the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">version</span></code> command in section <a class="reference internal" href="#version-management"><span class="std std-ref">4.2 Version management</span></a>.</p>
<p>Obviously, our test tests only one particular case.
A clever way of testing is to focus on properties. From mathematics we now that
the dot product is commutative. Let’s add a test for that.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">test_dot_commutative</span><span class="p">():</span>
    <span class="c1"># create two arrays of length 10 with random float numbers:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
        <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="c1"># do the test</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">ba</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ab</span><span class="o">==</span><span class="n">ba</span>
</pre></div>
</div>
<p>You can easily verify that this test works too. We increment the version string again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">micc</span> <span class="n">version</span> <span class="o">-</span><span class="n">p</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">(</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">version</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>There is however a risk in using
arrays of random numbers. Maybe we were just lucky and got random numbers that satisfy
the test by accident. Also the test is not reproducible anymore. The next time we run
<a class="reference external" href="https://pytest.org/en/latest/">pytest</a> we will get other random numbers, and maybe the test will fail. That would
represent a serious problem: since we cannot reproduce the failing test, we have no way
finding out what went wrong. For random numbers we can fix the seed at the beginning of
the test. Random number generators are deterministic, so fixing the seed makes the code
reproducible. To increase coverage we put a loop around the test.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_dot_commutative_2</span><span class="p">():</span>
    <span class="c1"># Fix the seed for the random number generator of module random.</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># choose array size</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># create two arrays of length n with with zeros:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># repetion loop:</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="c1"># fill a and b with random float numbers:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="c1"># do the test</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="n">ba</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ab</span><span class="o">==</span><span class="n">ba</span>
</pre></div>
</div>
<p>Again the test works. Another property of the dot product is that the dot product
with a zero vector is zero.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_dot_zero</span><span class="p">():</span>
    <span class="c1"># Fix the seed for the random number generator of module random.</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># choose array size</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># create two arrays of length n with with zeros:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># repetion loop (the underscore is a placeholder for a variable dat we do not use):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="c1"># fill a with random float numbers:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="c1"># do the test</span>
        <span class="n">azero</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">zero</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">azero</span><span class="o">==</span><span class="mi">0</span>
</pre></div>
</div>
<p>This test works too. Furthermore, the dot product with a vector of ones is the sum of
the elements of the other vector:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_dot_one</span><span class="p">():</span>
    <span class="c1"># Fix the seed for the random number generator of module random.</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># choose array size</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># create two arrays of length n with with zeros:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="c1"># repetion loop (the underscore is a placeholder for a variable dat we do not use):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="c1"># fill a with random float numbers:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="c1"># do the test</span>
        <span class="n">aone</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">aone</span><span class="o">==</span><span class="n">expected</span>
</pre></div>
</div>
<p>Success again. We are getting quite confident in the correctness of our implementation. Here
is another test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_dot_one_2</span><span class="p">():</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">1.0e16</span>
    <span class="n">a</span>   <span class="o">=</span> <span class="p">[</span><span class="n">a1</span> <span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="n">a1</span><span class="p">]</span>
    <span class="n">one</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="o">==</span><span class="n">expected</span>
</pre></div>
</div>
<p>Clearly, it is a special case of the test above the expected result is the sum of the elements
in <code class="docutils literal notranslate"><span class="pre">a</span></code>, that is <code class="docutils literal notranslate"><span class="pre">1.0</span></code>. Yet it - unexpectedly - fails. Fortunately <a class="reference external" href="https://pytest.org/en/latest/">pytest</a> produces a readable
report about the failure:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nv">pytest</span>
<span class="o">=================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==================================</span>
platform darwin -- Python <span class="m">3</span>.7.4, pytest-4.6.5, py-1.8.0, pluggy-0.13.0
rootdir: /Users/etijskens/software/dev/workspace/ET-dot
collected <span class="m">6</span> items

tests/test_et_dot.py .....F                                                      <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=======================================</span> <span class="nv">FAILURES</span> <span class="o">=======================================</span>
____________________________________ test_dot_one_2 ____________________________________

    def test_dot_one_2<span class="o">()</span>:
        <span class="nv">a1</span> <span class="o">=</span> <span class="m">1</span>.0e16
        <span class="nv">a</span>   <span class="o">=</span> <span class="o">[</span>a1 , <span class="m">1</span>.0, -a1<span class="o">]</span>
        <span class="nv">one</span> <span class="o">=</span> <span class="o">[</span><span class="m">1</span>.0, <span class="m">1</span>.0, <span class="m">1</span>.0<span class="o">]</span>
        <span class="nv">expected</span> <span class="o">=</span> <span class="m">1</span>.0
        <span class="nv">result</span> <span class="o">=</span> et_dot.dot<span class="o">(</span>a,one<span class="o">)</span>
&gt;       assert <span class="nv">result</span><span class="o">==</span>expected
E       assert <span class="m">0</span>.0 <span class="o">==</span> <span class="m">1</span>.0

tests/test_et_dot.py:91: <span class="nv">AssertionError</span>
<span class="o">==========================</span> <span class="m">1</span> failed, <span class="m">5</span> passed <span class="k">in</span> <span class="m">0</span>.17 <span class="nv">seconds</span> <span class="o">==========================</span>
&gt;
</pre></div>
</div>
<p>Mathematically, our expectations about the outcome of the test are certainly correct. Yet,
<a class="reference external" href="https://pytest.org/en/latest/">pytest</a> tells us it found that the result is <code class="docutils literal notranslate"><span class="pre">0.0</span></code> rather than <code class="docutils literal notranslate"><span class="pre">1.0</span></code>. What could possibly
be wrong? Well our mathematical expectations are based on our - false - assumption that the
elements of <code class="docutils literal notranslate"><span class="pre">a</span></code> are real numbers, most of which in decimal representation are characterised
by an infinite number of digits. Computer memory being finite, however, Python (and for that
matter all other programming languages) uses a finite number of bits to approximate real
numbers. These numbers are called <em>floating point numbers</em> and their arithmetic is called
<em>floating point arithmetic</em>.  <em>Floating point arithmetic</em> has quite different properties than
real number arithmetic. A floating point number in Python uses 64 bits which yields
approximately 15 representable digits. Observe the consequences of this in the Python statements
below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1e16</span>
<span class="go">1e+16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mf">1e16</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mf">1e16</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1e16</span> <span class="o">==</span> <span class="mf">1e16</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mf">1e16</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e16</span>
<span class="go">0.0</span>
</pre></div>
</div>
<p>There are several lessons to be learned from this:</p>
<ul class="simple">
<li><p>The test does not fail because our code is wrong, but because our mind is used to reasoning
about real number arithmetic, rather than <em>floating point arithmetic</em> rules. As the latter
is subject to round-off errors, tests sometimes fail unexpectedly.  Note that for comparing
floating point numbers the the standard library provides a <code class="xref py py-meth docutils literal notranslate"><span class="pre">math.isclose()</span></code> method.</p></li>
<li><p>Another silent assumption by which we can be mislead is in the random numbers. In fact,
<code class="xref py py-meth docutils literal notranslate"><span class="pre">random.random()</span></code> generates pseudo-random numbers <strong>in the interval ``[0,1[``</strong>, which
is quite a bit smaller than <code class="docutils literal notranslate"><span class="pre">]-inf,+inf[</span></code>. No matter how often we run the test the special
case above that fails will never be encountered, which may lead to unwarranted confidence in
the code.</p></li>
</ul>
<p>So, how do we cope with the failing test? Here is a way using <code class="xref py py-meth docutils literal notranslate"><span class="pre">math.isclose()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">test_dot_one_2</span><span class="p">():</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">1.0e16</span>
    <span class="n">a</span>   <span class="o">=</span> <span class="p">[</span><span class="n">a1</span> <span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="n">a1</span><span class="p">]</span>
    <span class="n">one</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">one</span><span class="p">)</span>
    <span class="c1"># assert result==expected</span>
    <span class="k">assert</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a reasonable solution if we accept that when dealing with numbers as big as <code class="docutils literal notranslate"><span class="pre">1e16</span></code>,
an absolute difference of <code class="docutils literal notranslate"><span class="pre">10</span></code> is negligible.</p>
<p>Another aspect that should be tested is the behavior of the code in exceptional circumstances.
Does it indeed raise <code class="xref py py-exc docutils literal notranslate"><span class="pre">ArithmeticError</span></code> if the arguments are not of the same length?
Here is a test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">test_dot_unequal_length</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ArithmeticError</span><span class="p">):</span>
        <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="xref py py-meth docutils literal notranslate"><span class="pre">pytest.raises()</span></code> is a <em>context manager</em> that will verify that <code class="xref py py-exc docutils literal notranslate"><span class="pre">ArithmeticError</span></code>
is raise when its body is executed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A detailed explanation about context managers see
<a class="reference external" href="https://jeffknupp.com/blog/2016/03/07/python-with-context-managers//">https://jeffknupp.com/blog/2016/03/07/python-with-context-managers//</a></p>
</div>
<p>Note that you can easily make <code class="xref py py-meth docutils literal notranslate"><span class="pre">et_dot.dot()</span></code> raise other
exceptions, e.g. <code class="xref py py-exc docutils literal notranslate"><span class="pre">TypeError</span></code> by passing in arrays of non-numeric types:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;two&#39;</span><span class="p">])</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;/Users/etijskens/software/dev/workspace/ET-dot/et_dot.py&quot;</span>, line <span class="m">23</span>, in <span class="n">dot</span>
    <span class="n">d</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="gr">TypeError</span>: <span class="n">unsupported operand type(s) for +=: &#39;int&#39; and &#39;str&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>Note that it is not the product <code class="docutils literal notranslate"><span class="pre">a[i]*b[i]</span></code> for <code class="docutils literal notranslate"><span class="pre">i=1</span></code> that is wreaking havoc, but
the addition of its result to <code class="docutils literal notranslate"><span class="pre">d</span></code>.</p>
<p>At this point you might notice that even for a very simple and well defined function
as the dot product the amount of test code easily exceeds the amount of tested code
by a factor of 5 or more. This is not at all uncommon. As the tested code here is an
isolated piece of code, you will probably leave it alone as soon as it passes the tests
and you are confident in the solution. If at some point, the <code class="xref py py-meth docutils literal notranslate"><span class="pre">dot()</span></code> would fail
you should write a test that reproduces the error and improve the solution so that it
passes the test.</p>
<p>When constructing software for more complex problems, there will very soon be many
interacting components and running the tests after modifying one of the components
will help you assure that all components still play well together, and spot problems
as soon as possible.</p>
<p>At this point we want to produce a git tag of the project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">micc</span> <span class="n">tag</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Creating</span> <span class="n">git</span> <span class="n">tag</span> <span class="n">v0</span><span class="o">.</span><span class="mf">0.7</span> <span class="k">for</span> <span class="n">project</span> <span class="n">ET</span><span class="o">-</span><span class="n">dot</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Done</span><span class="o">.</span>
</pre></div>
</div>
<p>The tag is a label for the current code base of our project. It marks a specific
point in the development of a code, in this case the point where our (first)
implementation is considered correct. That is, however, not to say that the tests
are now useless and can be thrown away. Every time we need to change the implemention,
to improve the user interface or the efficiency, or add a feature, we should run the
tests again to make sure that the changes did not break the code. of course, we should
also extend the test suite to cover the new properties of the code.</p>
</div>
<div class="section" id="improving-efficiency">
<span id="efficiency"></span><h3>1.5 Improving efficiency<a class="headerlink" href="#improving-efficiency" title="Permalink to this headline">¶</a></h3>
<p>There are times when a just a correct solution to the problem at hand
is sufficient. If <code class="docutils literal notranslate"><span class="pre">ET-dot</span></code> is meant to compute a few dot products of small
arrays, the naive implementation above will probably be sufficient.
However, if it is to be used many times and for large arrays and the uses
is impatiently waiting for the answer, or if your computing resources are
scarse, a more efficient implementation is needed. Especially in scientific
computing and high performance computing, where compute tasks may run for days
using hundreds or even thousands of of compute nodes and resources are
to be shared with many researchers, using the resources efficiently is
of utmost importance and efficient implementations are therefore indispensable.</p>
<p>However important efficiency may be, it is nevertheless a good strategy for developing a
new piece of code, to start out with a simple, even naive implementation, neglecting
efficiency considerations totally, instead focussing on correctness. Python has a
reputation of being an extremely productive programming language. Once you have
proven the correctness of this first version it can serve as a reference solution
to verify the correctness of later more efficient implementations. In addition,
the analysis of this version can highlight the sources of inefficiency and help
you focus your attention to the parts that really need it.</p>
<div class="section" id="timing-your-code">
<span id="timing-code"></span><h4>1.5.1 Timing your code<a class="headerlink" href="#timing-your-code" title="Permalink to this headline">¶</a></h4>
<p>The simplest way to probe the efficiency of your code is to time it: write a simple script
and record how long it takes to execute. Let us first look at the structure of a Python script.</p>
<p>Here’s a script (using the above structure) that computes the dot product of two long arrays
of random numbers.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;file et_dot/prof/run1.py&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">et_dot</span> <span class="kn">import</span> <span class="n">dot</span>

<span class="k">def</span> <span class="nf">random_array</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an array with n random numbers in [0,1[.&quot;&quot;&quot;</span>
    <span class="c1"># Below we use a list comprehension (a Python idiom for creating a list from an iterable object).</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">random_array</span><span class="p">()</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">random_array</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-*# done #*-&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We store this file, which we rather simply called <code class="file docutils literal notranslate"><span class="pre">run1.py</span></code>, e.g. in a directory
<code class="file docutils literal notranslate"><span class="pre">prof</span></code> where we intend to keep all our profiling work. You can execute the script
from the command line (with the project directory as the current working directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> &gt; python ./prof/run1.py
<span class="m">251</span>.08238559724717
-*# <span class="k">done</span> <span class="c1">#*-</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As our script does not fix the random number seed, every run has a different outcome.</p>
</div>
<p>We are now ready to time our script. There are many ways to achieve this. Here is a
<a class="reference external" href="https://realpython.com/python-timer/">particularly good introduction</a>. The
<a class="reference external" href="https://pypi.org/project/et-stopwatch/">et-stopwatch project</a> takes this a little
further. We add it as a development dependency (<code class="docutils literal notranslate"><span class="pre">-D</span></code>) of our project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">poetry</span> <span class="n">add</span> <span class="n">et_stopwatch</span> <span class="o">-</span><span class="n">D</span>
<span class="n">Using</span> <span class="n">version</span> <span class="o">^</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">0</span> <span class="k">for</span> <span class="n">et_stopwatch</span>
<span class="n">Updating</span> <span class="n">dependencies</span>
<span class="n">Resolving</span> <span class="n">dependencies</span><span class="o">...</span> <span class="p">(</span><span class="mf">0.2</span><span class="n">s</span><span class="p">)</span>
<span class="n">Writing</span> <span class="n">lock</span> <span class="n">file</span>
<span class="n">Package</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">1</span> <span class="n">install</span><span class="p">,</span> <span class="mi">0</span> <span class="n">updates</span><span class="p">,</span> <span class="mi">0</span> <span class="n">removals</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">et</span><span class="o">-</span><span class="n">stopwatch</span> <span class="p">(</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>A development dependency is a package that is not needed for using the package
at hand, bit only needed during development.</p>
<p>Using the <code class="xref py py-class docutils literal notranslate"><span class="pre">Stopwatch</span></code> class to time pieces of code is simple:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;file et_dot/prof/run1.py&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">et_stopwatch</span> <span class="kn">import</span> <span class="n">Stopwatch</span>

<span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Stopwatch</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;init&quot;</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">random_array</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">random_array</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">Stopwatch</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;dot &quot;</span><span class="p">):</span>
        <span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-*# done #*-&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>When the script is exectuted the two <code class="docutils literal notranslate"><span class="pre">with</span></code> blocks will print the time it takes
to execytre their body. The first <code class="docutils literal notranslate"><span class="pre">with</span></code> block times the initialisation if the arrays,
and the second dot product computation.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> &gt; python ./prof/run1.py
init: <span class="m">0</span>.000281 s
dot : <span class="m">0</span>.000174 s
-*# <span class="k">done</span> <span class="c1">#*-</span>
&gt;
</pre></div>
</div>
<p>Note that the initialization phase took longer than the computation. Random number
generation is rather expensive.</p>
</div>
<div class="section" id="comparing-to-numpy">
<span id="comparison-numpy"></span><h4>1.5.2 Comparing to Numpy<a class="headerlink" href="#comparing-to-numpy" title="Permalink to this headline">¶</a></h4>
<p>As said earlier, our implementation of the dot product is rather naive. If you want
to become a good programmer, you should understand that you are probably not the
first researcher in need of a dot product implementation. For most linear algebra
problems, <a class="reference external" href="https://numpy.org">Numpy</a> provides very efficient implementations.
Below the <code class="file docutils literal notranslate"><span class="pre">run1.py</span></code> script adds timing results for the <a class="reference external" href="https://numpy.org">Numpy</a> equivalent of
our code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;file et_dot/prof/run1.py&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Stopwatch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;et init&quot;</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">random_array</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">random_array</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">Stopwatch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;et dot &quot;</span><span class="p">):</span>
        <span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Stopwatch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;np init&quot;</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Stopwatch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;np dot &quot;</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-*# done #*-&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Obviously, to run this script, we must first install <a class="reference external" href="https://numpy.org">Numpy</a> (again as a development
dependency):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">poetry</span> <span class="n">add</span> <span class="n">numpy</span> <span class="o">-</span><span class="n">D</span>
<span class="n">Using</span> <span class="n">version</span> <span class="o">^</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">1</span> <span class="k">for</span> <span class="n">numpy</span>
<span class="n">Updating</span> <span class="n">dependencies</span>
<span class="n">Resolving</span> <span class="n">dependencies</span><span class="o">...</span> <span class="p">(</span><span class="mf">1.5</span><span class="n">s</span><span class="p">)</span>
<span class="n">Writing</span> <span class="n">lock</span> <span class="n">file</span>
<span class="n">Package</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">1</span> <span class="n">install</span><span class="p">,</span> <span class="mi">0</span> <span class="n">updates</span><span class="p">,</span> <span class="mi">0</span> <span class="n">removals</span>
  <span class="o">-</span> <span class="n">Installing</span> <span class="n">numpy</span> <span class="p">(</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>Here are the results of the modified script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> &gt; python ./prof/run1.py
et init: <span class="m">0</span>.000252 s
et dot : <span class="m">0</span>.000219 s
np init: <span class="m">7</span>.8e-05 s
np dot : <span class="m">3</span>.2e-05 s
-*# <span class="k">done</span> <span class="c1">#*-</span>
&gt;
</pre></div>
</div>
<p>Obviously, <a class="reference external" href="https://numpy.org">Numpy</a> does significantly better than our naive dot product implementation.
The reasons for this improvement are:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://numpy.org">Numpy</a> arrays are contiguous data structures of floating point numbers, unlike Python’s
<code class="xref py py-class docutils literal notranslate"><span class="pre">list</span></code>, where every item can in fact point to an arbitrary Python object.
Contiguous memory access is far more efficient. In addition, the memory footprint of
a numpy array is significantly lower that that of a plain Python list.</p></li>
<li><p>The loop over <a class="reference external" href="https://numpy.org">Numpy</a> arrays is implemented in a low-level programming languange.
This allows to make full use of the processors hardware features, such as <em>vectorization</em>
and <em>fused multiply-add</em> (FMA).</p></li>
</ul>
</div>
</div>
<div class="section" id="conclusion">
<span id="id5"></span><h3>1.6 Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>There are three important generic lessons to be learned from this tutorial:</p>
<ol class="arabic simple">
<li><p>Always start your projects with a simple and straightforward implementation which
can be easily be proven to be correct, even if you know that it will not satisfy
your efficiency constraints. You should use it as a reference to prove the correctness
of future more efficient implementations.</p></li>
<li><p>Write test code for proving correctness.</p></li>
<li><p>Time your code to understand which parts are time consuming and which not. Optimize
bottlenecks first and do not waste time optimizing code that does not contribute
significantly to the total runtime. Optimized code is typically harder to read and
may become a maintenance issue.</p></li>
<li><p>Before you write code, in this case our dot product implementation, spent some time
searching the internet to see what is already available. Especially in the field of
scientific and high performance computing there are many excellent libraries available
which are hard to beat. Use your precious time for new stuff. Consider adding new features
to an existing codebase, rather than starting from scratch. It will gain you time,
improve your programming skills. It might also give your code more visibility, and more
users, because you provide them with and extra feature on top of something they are
already used to.</p></li>
</ol>
</div>
</div>
<div class="section" id="tutorial-2-binary-extensions">
<span id="tutorial-2"></span><h2>Tutorial 2: Binary extensions<a class="headerlink" href="#tutorial-2-binary-extensions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction-high-performance-python">
<span id="intro-hppython"></span><h3>2.1 Introduction - High Performance Python<a class="headerlink" href="#introduction-high-performance-python" title="Permalink to this headline">¶</a></h3>
<p>Suppose for a moment that <a class="reference external" href="https://numpy.org">Numpy</a> did not have a dot product implementation and that
the implementation provided in Tutorial-1 is way too slow to be practical for your
research project. Consequently, you are forced to accelarate your dot product code
in some way or another. There are several approaches for this. Here are a number of
highly recommended links covering them:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://developer.ibm.com/dwblog/2018/use-python-for-scientific-research/">Why you should use Python for scientific research</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=zQeYx87mfyw">Performance Python: Seven Strategies for Optimizing Your Numerical Code</a></p></li>
<li><p><a class="reference external" href="http://www.admin-magazine.com/HPC/Articles/High-Performance-Python-1">High performance Python 1</a></p></li>
<li><p><a class="reference external" href="http://www.admin-magazine.com/HPC/Articles/High-Performance-Python-2">High performance Python 2</a></p></li>
<li><p><a class="reference external" href="http://www.admin-magazine.com/HPC/Articles/High-Performance-Python-3">High performance Python 3</a></p></li>
<li><p><a class="reference external" href="http://www.admin-magazine.com/HPC/Articles/High-Performance-Python-4">High performance Python 4</a></p></li>
</ul>
<p>Two of the approaches discussed in the <em>High Performance Python</em> series involve rewriting
your code in Modern Fortran or C++ and generate a shared library that can be imported in
Python just as any Python module. This is exactly the approach taken in important HPC
Python modules, such as <a class="reference external" href="https://numpy.org">Numpy</a>, <a class="reference external" href="https://pytorch.org/">pyTorch</a> and <a class="reference external" href="https://pandas.pydata.org">pandas</a>.
Such shared libraries are called <em>binary extension modules</em>. Constructing binary extension
modules is by far the most scalable and flexible of all current acceleration strategies, as
these languages are designed to squeeze the maximum of performance out of a CPU.</p>
<p>However, figuring out how to build such binary extension modules is a bit of a challenge,
especially in the case of C++. This is in fact one of the main reasons why <a class="reference external" href="https://micc.readthedocs.io">Micc</a> was designed:
facilitating the construction of binary extension modules and enabling the developer to create
high performance tools with ease.
To that end, <a class="reference external" href="https://micc.readthedocs.io">Micc</a> provides boilerplate code for binary extensions as well a practical wrapper
around top-notch tools for building the binary extensions from Fortran and C++ source. This
wrapper is called <a class="reference external" href="https://github.com/etijskens/et-micc-build">micc-build</a>. It uses <a class="reference external" href="https://cmake.org">CMake</a> to pass the necessary parameters to the compiler.
In between the compiler and <a class="reference external" href="https://cmake.org">CMake</a> there is a tool that tells how a Python module is to be
constructed from the source code. For Fortran that is <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> (which comes with <a class="reference external" href="https://numpy.org">Numpy</a>), and
for C++ it is <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a>. This is illustrated in the figure below:</p>
<blockquote>
<div><img alt="_images/im-building.png" src="_images/im-building.png" />
</div></blockquote>
<p>There is a difference in how <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> and <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a> operate. <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">F2py</a> is an <em>executable</em> that inspects
the Fortran source and create wrappers for the subprograms it finds and uses the compiler to
build the extension module. (The wrappers are in C, so <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> needs a C compiler as well).
<a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">Pybind11</a> is a <em>C++ template library</em> that is used to express what needs to be exposed in the
binary extension module.</p>
<div class="section" id="choosing-between-fortran-and-c-for-binary-extension-modules-intermediate">
<span id="f90-orr-cpp"></span><h4>2.1.1 Choosing between Fortran and C++ for binary extension modules [intermediate]<a class="headerlink" href="#choosing-between-fortran-and-c-for-binary-extension-modules-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>Here are a number of arguments that you may wish to take into account for choosing the
programming language for your binary extension modules:</p>
<ul class="simple">
<li><p>Fortran is a simpler language than C++.</p></li>
<li><p>It is easier to write efficient code in Fortran than C++.</p></li>
<li><p>C++ is a general purpose language (as is Python), whereas Fortran is meant for scientific
computing. Consequently, C++ is a much more expressive language.</p></li>
<li><p>C++ comes with a huge standard library, providing lots of data structures and algorithms
that are hard to match in Fortran. If the standard library is not enough, there are also
the highly recommended <a class="reference external" href="https://boost.org">Boost</a> libraries and many other high
qualityh domain specific libraries. There are also domain specific libraries in Fortran,
but their count differs by an order of magnitude at least.</p></li>
<li><p>With <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">Pybind11</a> you can almost expose anything from the C++ side to Python, not just
functions.</p></li>
<li><p>Modern Fortran is (imho) not as good documented as C++. Useful place to look for
language features and idioms are:</p>
<ul>
<li><p><a class="reference external" href="https://www.fortran90.org/">https://www.fortran90.org/</a></p></li>
<li><p><a class="reference external" href="http://www.cplusplus.com/">http://www.cplusplus.com/</a></p></li>
<li><p><a class="reference external" href="https://en.cppreference.com/w/">https://en.cppreference.com/w/</a></p></li>
</ul>
</li>
</ul>
<p>In short, C++ provides much more possibilities, but it is not for the novice.
As to my own experience, I discovered that working on projects of moderate complexity
I progressed significantly faster using Fortran rather than C++, despite the fact that
my knowledge of Fortran is quite limited compared to C++. However, your mileage may vary.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="adding-binary-extensions-to-a-micc-project">
<span id="add-bin-ext"></span><h3>2.2 Adding Binary extensions to a <a class="reference external" href="https://micc.readthedocs.io">Micc</a> project<a class="headerlink" href="#adding-binary-extensions-to-a-micc-project" title="Permalink to this headline">¶</a></h3>
<p>Adding a binary extension to your current project is as simple as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">add</span> <span class="n">foo</span> <span class="o">--</span><span class="n">f90</span>   <span class="c1"># add a binary extension &#39;foo&#39; written in (Modern) Fortran</span>
<span class="o">...</span>
<span class="o">&gt;</span> <span class="n">micc</span> <span class="n">add</span> <span class="n">bar</span> <span class="o">--</span><span class="n">cpp</span>   <span class="c1"># add a binary extension &#39;bar&#39; written in C++</span>
<span class="o">...</span>
</pre></div>
</div>
<p>You can add as many binary extensions to your code as you want. However, the project
must have a <em>package</em> structure (see <a class="reference internal" href="#modules-and-packages"><span class="std std-ref">1.1.1. Modules and packages [intermediate]</span></a> for how to convert
a project with a <em>module</em> structure). <a class="reference external" href="https://micc.readthedocs.io">Micc</a> puts the source files for the foo Fortran
binary extension in subdirectory <code class="file docutils literal notranslate"><span class="pre">f90_foo</span></code> of the package directory, and for the
C++ binary extension in subdirectory <code class="file docutils literal notranslate"><span class="pre">cpp_bar</span></code> of the package directory.</p>
<p>Enter your own code in the generated source code files. The output of the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">add</span></code>
commands will have a line like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="o">-</span> <span class="n">Fortran</span> <span class="n">source</span> <span class="ow">in</span>       <span class="o">&lt;</span><span class="n">my_project</span><span class="o">&gt;/&lt;</span><span class="n">my_package</span><span class="o">&gt;/</span><span class="n">f90_foo</span><span class="o">/</span><span class="n">foo</span><span class="o">.</span><span class="n">f90</span><span class="o">.</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="o">-</span> <span class="n">C</span><span class="o">++</span> <span class="n">source</span> <span class="ow">in</span>       <span class="o">&lt;</span><span class="n">my_project</span><span class="o">&gt;/&lt;</span><span class="n">my_package</span><span class="o">&gt;/</span><span class="n">cpp_bar</span><span class="o">/</span><span class="n">bar</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;my_project&gt;</span></code> is the project directory and <code class="docutils literal notranslate"><span class="pre">&lt;my_package&gt;</span></code> is the package directory.</p>
<p>This tells you where to add your code. After entering yor code, activate your project’s virtual
environment, and run <code class="docutils literal notranslate"><span class="pre">micc-build</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">micc</span><span class="o">-</span><span class="n">build</span>
<span class="o">...</span>                      <span class="c1"># a lot of output</span>
</pre></div>
</div>
<p>If there are no syntax errors all your binary extensions will be built, and you
will be able to import the  modules <code class="xref py py-mod docutils literal notranslate"><span class="pre">foo</span></code> and <code class="xref py py-mod docutils literal notranslate"><span class="pre">bar</span></code> in your
project and use their subroutines and functions. Because <code class="xref py py-mod docutils literal notranslate"><span class="pre">foo</span></code> and
<code class="xref py py-mod docutils literal notranslate"><span class="pre">bar</span></code> are submodules of your <a class="reference external" href="https://micc.readthedocs.io">micc</a> project, you must import them as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">my_package.foo</span>
<span class="kn">import</span> <span class="nn">my_package.bar</span>

<span class="c1"># call foofun in my_package.foo</span>
<span class="n">my_package</span><span class="o">.</span><span class="n">foo</span><span class="o">.</span><span class="n">foofun</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># call barfun in my_package.bar</span>
<span class="n">my_package</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">barfun</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that the general principles are laid out, we can go into the details.</p>
<div class="section" id="micc-build-options">
<span id="id6"></span><h4>2.2.3 micc-build options<a class="headerlink" href="#micc-build-options" title="Permalink to this headline">¶</a></h4>
<p>Here is an overview of micc-build options. The most interesting options are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">&lt;module-to-build&gt;</span></code>: build only the specified module, as opposed to
all binary extension modules in the project</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-b</span> <span class="pre">&lt;build-type&gt;</span></code>: build a <code class="docutils literal notranslate"><span class="pre">&lt;build-type&gt;</span></code> version, default=``RELEASE``,
otherwise <code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>, MINSIZEREL, <code class="docutils literal notranslate"><span class="pre">RELWITHDEBINFO</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--clean</span></code>: perform a clean build</p></li>
</ul>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc-build --help
Usage: micc-build <span class="o">[</span>OPTIONS<span class="o">]</span>

  Build binary extension libraries <span class="o">(</span>f90 and cpp modules<span class="o">)</span>.

Options:
  -v, --verbosity          The verbosity of the program.
  -p, --project-path PATH  The path to the project directory. The default is
                           the current working directory.

  -m, --module TEXT        Build only this module. The module kind prefix
                           <span class="o">(</span><span class="sb">``</span>cpp_<span class="sb">``</span> <span class="k">for</span> C++ modules, <span class="sb">``</span>f90_<span class="sb">``</span> <span class="k">for</span> Fortran
                           modules<span class="o">)</span> may be omitted.

  -b, --build-type TEXT    build type: any of the standard CMake build types:
                           DEBUG, MINSIZEREL, RELEASE, RELWITHDEBINFO.

  --clean                  Perform a clean build.
  --cleanup                Cleanup build directory after successful build.
  --version                Show the version and exit.
  --help                   Show this message and exit.
</pre></div>
</div>
</div>
</div>
<div class="section" id="building-binary-extensions-from-fortran">
<span id="building-f90"></span><h3>2.3 Building binary extensions from Fortran<a class="headerlink" href="#building-binary-extensions-from-fortran" title="Permalink to this headline">¶</a></h3>
<p>Let us add a binary extension module for a dot product version written in Fortran.
First, we verify that our <code class="docutils literal notranslate"><span class="pre">ET-dot</span></code> project has a package structure (assuming that
the current working directory is the project directory <code class="file docutils literal notranslate"><span class="pre">ET-dot</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">info</span>
<span class="n">Project</span> <span class="n">ET</span><span class="o">-</span><span class="n">dot</span> <span class="n">located</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">bert</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span>
  <span class="n">package</span><span class="p">:</span> <span class="n">et_dot</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span>
  <span class="n">structure</span><span class="p">:</span> <span class="n">et_dot</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span> <span class="p">(</span><span class="n">Python</span> <span class="n">package</span><span class="p">)</span>
<span class="o">&gt;</span>
</pre></div>
</div>
<p>If the last line reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
  <span class="n">structure</span><span class="p">:</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">py</span> <span class="p">(</span><span class="n">Python</span> <span class="n">module</span><span class="p">)</span>
</pre></div>
</div>
<p>you must convert the project:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">convert</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">package</span> <span class="o">--</span><span class="n">overwrite</span>
<span class="o">...</span>
</pre></div>
</div>
<p>(See <a class="reference internal" href="#modules-and-packages"><span class="std std-ref">1.1.1. Modules and packages [intermediate]</span></a> for details).</p>
<p>We are now ready to create a f90 module for a Fortran implementation of the
dot product, say <code class="docutils literal notranslate"><span class="pre">dotf</span></code>, where the <code class="docutils literal notranslate"><span class="pre">f</span></code>, obviously, is for Fortran:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">micc</span> <span class="n">add</span> <span class="n">dotf</span> <span class="o">--</span><span class="n">f90</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">[</span> <span class="n">Adding</span> <span class="n">f90</span> <span class="n">module</span> <span class="n">dotf</span> <span class="n">to</span> <span class="n">project</span> <span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="o">-</span> <span class="n">Fortran</span> <span class="n">source</span> <span class="ow">in</span>       <span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">f90_dotf</span><span class="o">/</span><span class="n">dotf</span><span class="o">.</span><span class="n">f90</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="o">-</span> <span class="n">Python</span> <span class="n">test</span> <span class="n">code</span> <span class="ow">in</span>     <span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_f90_dotf</span><span class="o">.</span><span class="n">py</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>               <span class="o">-</span> <span class="n">module</span> <span class="n">documentation</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">f90_dotf</span><span class="o">/</span><span class="n">dotf</span><span class="o">.</span><span class="n">rst</span> <span class="p">(</span><span class="ow">in</span> <span class="n">restructuredText</span> <span class="nb">format</span><span class="p">)</span><span class="o">.</span>
<span class="p">[</span><span class="n">WARNING</span><span class="p">]</span>            <span class="n">Dependencies</span> <span class="n">added</span><span class="o">.</span> <span class="n">Run</span> \<span class="s1">&#39;poetry update</span><span class="se">\&#39;</span><span class="s1"> to update the project</span><span class="se">\&#39;</span><span class="s1">s virtual environment.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
</pre></div>
</div>
<p>The output tells us where to enter the Fortran source code, the test code and the documentation.
These files contain already working example code.</p>
<p>The warning in the output above tells us that <a class="reference external" href="https://micc.readthedocs.io">micc</a> added some development dependencies
to our project. These dependencies provide the machinery to build binary extension
modules and must be installed in the virtual environment of our project. The easy
way to do this is by running <code class="docutils literal notranslate"><span class="pre">poetry</span> <span class="pre">install</span></code> as is mentioned in the warning.
The former will install missing dependencies, the latter will get the latest
version of all dependencies and install them.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; poetry install
Updating dependencies
Resolving dependencies... <span class="o">(</span><span class="m">15</span>.1s<span class="o">)</span>

Writing lock file

Package operations: <span class="m">18</span> installs, <span class="m">1</span> update, <span class="m">0</span> removals

  • Installing python-dateutil <span class="o">(</span><span class="m">2</span>.8.1<span class="o">)</span>
  • Installing arrow <span class="o">(</span><span class="m">0</span>.17.0<span class="o">)</span>
  • Installing soupsieve <span class="o">(</span><span class="m">2</span>.1<span class="o">)</span>
  • Installing text-unidecode <span class="o">(</span><span class="m">1</span>.3<span class="o">)</span>
  • Installing beautifulsoup4 <span class="o">(</span><span class="m">4</span>.9.3<span class="o">)</span>
  • Installing binaryornot <span class="o">(</span><span class="m">0</span>.4.4<span class="o">)</span>
  • Installing jinja2-time <span class="o">(</span><span class="m">0</span>.2.0<span class="o">)</span>
  • Installing poyo <span class="o">(</span><span class="m">0</span>.5.0<span class="o">)</span>
  • Installing python-slugify <span class="o">(</span><span class="m">4</span>.0.1<span class="o">)</span>
  • Installing cookiecutter <span class="o">(</span><span class="m">1</span>.7.2<span class="o">)</span>
  • Installing pypi-simple <span class="o">(</span><span class="m">0</span>.8.0<span class="o">)</span>
  • Installing semantic-version <span class="o">(</span><span class="m">2</span>.8.5<span class="o">)</span>
  • Updating sphinx-rtd-theme <span class="o">(</span><span class="m">0</span>.5.1 -&gt; <span class="m">0</span>.4.3<span class="o">)</span>
  • Installing tomlkit <span class="o">(</span><span class="m">0</span>.5.11<span class="o">)</span>
  • Installing walkdir <span class="o">(</span><span class="m">0</span>.4.1<span class="o">)</span>
  • Installing et-micc <span class="o">(</span><span class="m">1</span>.0.12<span class="o">)</span>
  • Installing numpy <span class="o">(</span><span class="m">1</span>.19.5<span class="o">)</span>
  • Installing pybind11 <span class="o">(</span><span class="m">2</span>.6.1<span class="o">)</span>
  • Installing et-micc-build <span class="o">(</span><span class="m">1</span>.0.12<span class="o">)</span>

Installing the current project: ET-dot <span class="o">(</span><span class="m">0</span>.0.6<span class="o">)</span>
</pre></div>
</div>
<p>In fact the only dependency added in <code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code> was <a class="reference external" href="https://github.com/etijskens/et-micc-build">micc-build</a>,
but that depends on numpy, pybind11 and et-micc, which in turn have their own
sub-dependencies, all of which are nicely resolved by <a class="reference external" href="https://python-poetry.org/">poetry</a> and installed.
Although <a class="reference external" href="https://github.com/etijskens/et-micc-build">micc-build</a> also needs <a class="reference external" href="https://cmake.org">CMake</a>, it is not added as dependency of <a class="reference external" href="https://github.com/etijskens/et-micc-build">micc-build</a>&gt;
In view of the widespread use of <a class="reference external" href="https://cmake.org">CMake</a>, it was considered better have a system-wide
CMake installation (see section <a class="reference internal" href="devenv.html#development-environment"><span class="std std-ref">Development environment</span></a>).</p>
<p>The dependency of <code class="file docutils literal notranslate"><span class="pre">et-micc-build</span></code> on <code class="file docutils literal notranslate"><span class="pre">et-micc</span></code> makes that <code class="docutils literal notranslate"><span class="pre">micc</span></code> is now
also installed in the project’s virtual environment. Therefore, when the project’s
virtual environment is activated, the active <code class="docutils literal notranslate"><span class="pre">micc</span></code> is the one in the project’s
virtual environment, which might be a more recent version than the system-wide micc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">which</span> <span class="n">micc</span>
<span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">micc</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>If you do not want to use <a class="reference external" href="https://python-poetry.org/">poetry</a> to install the dependencies, you can lookup the
dependencies in <code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, see that there is only <code class="docutils literal notranslate"><span class="pre">et-micc-build</span></code>,
and run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">et-micc-build</span></code> in the Python environment you want to use
for your project development. (Using a virtual environment is good practise, see
<a class="reference internal" href="#virtual-environments"><span class="std std-ref">1.2.2 Virtual environments</span></a>).</p>
<p>Let’s continue our development of a Fortran version of the dot product. Replace the
existing code in the Fortran source file <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/f90_dotf/dotf.f90</span></code>
(using your favourite editor or an IDE) with:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">dotf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
  <span class="c">! Compute the dot product of a and b</span>
  <span class="c">!</span>
    <span class="k">implicit none</span>
  <span class="c">!-------------------------------------------------------------------------------------------------</span>
    <span class="kt">integer</span><span class="o">*</span><span class="mi">4</span>              <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>   <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>                                 <span class="kd">::</span> <span class="n">dotf</span>
  <span class="c">!-------------------------------------------------------------------------------------------------</span>
  <span class="c">! declare local variables</span>
    <span class="kt">integer</span><span class="o">*</span><span class="mi">4</span> <span class="kd">::</span> <span class="n">i</span>
  <span class="c">!-------------------------------------------------------------------------------------------------</span>
    <span class="n">dotf</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
        <span class="n">dotf</span> <span class="o">=</span> <span class="n">dotf</span> <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">end do</span>
<span class="k">end function </span><span class="n">dotf</span>
</pre></div>
</div>
<p>The binary extension module can now be built by running <code class="docutils literal notranslate"><span class="pre">micc-build</span></code>. This produces
a lot of output, most of which is omitted here, except for the build settings discovered
by <a class="reference external" href="https://cmake.org">CMake</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">[</span> <span class="n">Building</span> <span class="n">f90</span> <span class="n">module</span> <span class="s1">&#39;dotf&#39;</span><span class="p">:</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="o">--</span><span class="n">clean</span><span class="p">:</span> <span class="n">shutil</span><span class="o">.</span><span class="n">removing</span><span class="p">(</span><span class="s1">&#39;/Users/etijskens/software/dev/workspace/ET-dot/et_dot/f90_dotf/_cmake_build&#39;</span><span class="p">)</span><span class="o">.</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">[</span> <span class="o">&gt;</span> <span class="n">cmake</span> <span class="o">-</span><span class="n">D</span> <span class="n">PYTHON_EXECUTABLE</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">-</span><span class="n">D</span> <span class="n">CMAKE_BUILD_TYPE</span><span class="o">=</span><span class="n">RELEASE</span> <span class="o">..</span>    <span class="o">...</span>
<span class="o">...</span>
                   <span class="c1"># Build settings ###################################################################################</span>
                   <span class="n">CMAKE_Fortran_COMPILER</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gfortran</span>
                   <span class="n">CMAKE_BUILD_TYPE</span>      <span class="p">:</span> <span class="n">RELEASE</span>
                   <span class="n">F2PY_opt</span>              <span class="p">:</span> <span class="o">--</span><span class="n">opt</span><span class="o">=</span><span class="s1">&#39;-O3&#39;</span>
                   <span class="n">F2PY_arch</span>             <span class="p">:</span>
                   <span class="n">F2PY_f90flags</span>         <span class="p">:</span>
                   <span class="n">F2PY_debug</span>            <span class="p">:</span>
                   <span class="n">F2PY_defines</span>          <span class="p">:</span> <span class="o">-</span><span class="n">DNPY_NO_DEPRECATED_API</span><span class="o">=</span><span class="n">NPY_1_7_API_VERSION</span><span class="p">;</span><span class="o">-</span><span class="n">DF2PY_REPORT_ON_ARRAY_COPY</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="o">-</span><span class="n">DNDEBUG</span>
                   <span class="n">F2PY_includes</span>         <span class="p">:</span>
                   <span class="n">F2PY_linkdirs</span>         <span class="p">:</span>
                   <span class="n">F2PY_linklibs</span>         <span class="p">:</span>
                   <span class="n">module</span> <span class="n">name</span>           <span class="p">:</span> <span class="n">dotf</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
                   <span class="n">module</span> <span class="n">filepath</span>       <span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">f90_dotf</span><span class="o">/</span><span class="n">_cmake_build</span><span class="o">/</span><span class="n">dotf</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
                   <span class="n">source</span>                <span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">f90_dotf</span><span class="o">/</span><span class="n">dotf</span><span class="o">.</span><span class="n">f90</span>
                   <span class="n">python</span> <span class="n">executable</span>     <span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="p">[</span><span class="n">version</span><span class="o">=</span><span class="n">Python</span> <span class="mf">3.8</span><span class="o">.</span><span class="mi">5</span><span class="p">]</span>
                     <span class="n">f2py</span> <span class="n">executable</span>     <span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">f2py</span> <span class="p">[</span><span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">]</span>
                   <span class="c1">####################################################################################################</span>
<span class="o">...</span>

<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="n">Binary</span> <span class="n">extensions</span> <span class="n">built</span> <span class="n">successfully</span><span class="p">:</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="o">-</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">dotf</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>At the end of the output is a summary of all binary extensions that have been built, or
failed to build. If the source file does not have any syntax errors, you will see a file like
<code class="file docutils literal notranslate"><span class="pre">dotf.cpython-38-darwin.so</span></code> in directory <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot</span></code>, Its extension depends on
the Python version (c.q. 3.8) you are using, and on your operating system (c.q. MacOS).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> &gt; ls -l et_dot
total <span class="m">8</span>
-rw-r--r--  <span class="m">1</span> etijskens  staff  <span class="m">720</span> Dec <span class="m">13</span> <span class="m">11</span>:04 __init__.py
drwxr-xr-x  <span class="m">6</span> etijskens  staff  <span class="m">192</span> Dec <span class="m">13</span> <span class="m">11</span>:12 f90_dotf/
lrwxr-xr-x  <span class="m">1</span> etijskens  staff   <span class="m">92</span> Dec <span class="m">13</span> <span class="m">11</span>:12 dotf.cpython-38-darwin.so
</pre></div>
</div>
<p>This file is the binary extension module, which can be imported like any other Python module.</p>
<p>Since our binary extension is built, we can test it. Here is some test code. Enter it in file
<code class="file docutils literal notranslate"><span class="pre">ET-dot/tests/test_f90_dotf.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># import the binary extension and rename the module locally as f90</span>
<span class="kn">import</span> <span class="nn">et_dot</span>
<span class="c1">#create alias to dotf binary extension module</span>
<span class="n">f90</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotf</span>

<span class="k">def</span> <span class="nf">test_dotf_aa</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># call the dotf function in the binary extension module:</span>
    <span class="n">a_dotf_a</span> <span class="o">=</span> <span class="n">f90</span><span class="o">.</span><span class="n">dotf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a_dotf_a</span><span class="o">==</span><span class="n">expected</span>
</pre></div>
</div>
<p>The astute reader will notice the magic that is happening here: <em>a</em> is a numpy array,
which is passed as is to our <code class="xref py py-meth docutils literal notranslate"><span class="pre">et_dot.dotf.dotf()</span></code> function in our binary extension.
An invisible wrapper function will check the types of the numpy arrays, retrieve pointers
to the memory of the numpy arrays, as well as the length of the arrays, and feed these
into our Fortran function, which computes the dot product. Next, the wrapper creates a
Python object and stores the outcome of computation in it, which is finally assigened to
the Python variable <code class="xref py py-obj docutils literal notranslate"><span class="pre">a_dotf_a.</span> <span class="pre">If</span> <span class="pre">you</span> <span class="pre">look</span> <span class="pre">carefully</span> <span class="pre">at</span> <span class="pre">the</span> <span class="pre">output</span> <span class="pre">of</span> <span class="pre">``micc-build`</span></code>,
you will see information about the wrappers that <code class="docutils literal notranslate"><span class="pre">f2py</span></code> constructed. These wrappers are
generated by <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> in C code, and thus it needs a C compiler, in addition to the Fortran
compiler for compilin our <code class="file docutils literal notranslate"><span class="pre">dotf.f90</span></code>.</p>
<p>Passing Numpy arrays directly to Fortran routines is <em>extremely productive</em>.
Many useful Python packages use <a class="reference external" href="https://numpy.org">numpy</a> for arrays, vectors, matrices, linear algebra, etc.
Being able to pass Numpy arrays directly into your own number crunching routines
relieves you from conversion between array types. In addition you can do the memory
management of your arrays and their initialization most conveniently in Python.</p>
<p>As you can see we test the outcome of dotf against the outcome of <code class="xref py py-meth docutils literal notranslate"><span class="pre">numpy.dot()</span></code>.
We thrust that outcome, but beware that this test may be susceptible to round-off error
because the representation of floating point numbers in Numpy and in Fortran may differ
slightly.</p>
<p>Here is the outcome of <code class="docutils literal notranslate"><span class="pre">pytest</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nv">pytest</span>
<span class="o">================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=================================</span>
platform darwin -- Python <span class="m">3</span>.7.4, pytest-4.6.5, py-1.8.0, pluggy-0.13.0
rootdir: /Users/etijskens/software/dev/workspace/ET-dot
collected <span class="m">8</span> items

tests/test_et_dot.py .......                                                   <span class="o">[</span> <span class="m">87</span>%<span class="o">]</span>
tests/test_f90_dotf.py .                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span> <span class="m">8</span> passed <span class="k">in</span> <span class="m">0</span>.16 <span class="nv">seconds</span> <span class="o">==============================</span>
&gt;
</pre></div>
</div>
<p>All our tests passed. Of course we can extend the tests in the same way as we did for the
naive Python implementation in the previous tutorial. We leave that as an exercise to the
reader.</p>
<p>The way in which we accessed the binary extension module in the test code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">et_dot</span>
<span class="c1">#create alias to dotf binary extension module</span>
<span class="n">f90</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotf</span>
</pre></div>
</div>
<p>is only possible because <a class="reference external" href="https://micc.readthedocs.io">micc</a> has taken care for us that the file <code class="file docutils literal notranslate"><span class="pre">et_dot/__init__.py</span></code>
imports the binary extension module <code class="file docutils literal notranslate"><span class="pre">dotf</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">et_dot.dotf</span>
</pre></div>
</div>
<p>In fact, <a class="reference external" href="https://micc.readthedocs.io">micc</a> added a little magic to automatically build the binary extension module
if it cannot be found.</p>
<div class="section" id="fortran-modules-intermediate">
<span id="f90-modules"></span><h4>2.3.1 Fortran modules [intermediate]<a class="headerlink" href="#fortran-modules-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>This may be a bit confusing, as we have been talking about Python modules, so far.
Fortran also has <em>modules</em>, to group things that belong together. So, these modules
are something different than the binary extension modules written in Fortran, which
are in fact Python modules.
If you put your subroutines and functions inside a Fortran module, that is in a
<code class="docutils literal notranslate"><span class="pre">MODULE/END</span> <span class="pre">MODULE</span></code> block, as in:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">MODULE </span><span class="n">my_f90_module</span>
<span class="k">implicit none</span>
<span class="k">contains</span>
<span class="k">  function </span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="p">...</span>
  <span class="k">end function </span><span class="n">dot</span>
<span class="k">END MODULE </span><span class="n">my_f90_module</span>
</pre></div>
</div>
<p>then f2py will expose the Fortran module name <code class="xref py py-obj docutils literal notranslate"><span class="pre">my_f90_module</span></code>
which in turn contains the function/subroutine names:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">et_dot</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">3.</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="c1"># this is the python version of the dot product</span>
<span class="mi">12</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotf</span><span class="o">.</span><span class="n">my_F90_module</span><span class="o">.</span><span class="n">dotf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="n">created</span> <span class="n">an</span> <span class="n">array</span> <span class="kn">from</span> <span class="nn">object</span>
<span class="n">created</span> <span class="n">an</span> <span class="n">array</span> <span class="kn">from</span> <span class="nn">object</span>
<span class="mf">12.0</span>
</pre></div>
</div>
<p>Note, the <code class="docutils literal notranslate"><span class="pre">created</span> <span class="pre">an</span> <span class="pre">array</span> <span class="pre">from</span> <span class="pre">object</span></code> warnings that appear when calling the
Fortran version of the dot product <code class="xref py py-obj docutils literal notranslate"><span class="pre">dotf</span></code>. As <code class="xref py py-obj docutils literal notranslate"><span class="pre">a</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">b</span></code> are
Python lists and not numpy arrays, the wrapper of <code class="docutils literal notranslate"><span class="pre">dotf</span></code> that was created by <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a>
has performed a conversion. Though this is sometimes practical, it comes at a cost:
a numpy array has to be created and the data in the <code class="xref py py-obj docutils literal notranslate"><span class="pre">lists</span></code> are copied to
the numpy array which is passed to the Fortran function. When the computation is
done the numpy arrays are destroyed. <a class="reference external" href="https://micc.readthedocs.io">Micc</a> instructs <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> to issue warnings when
potentially expensensive copy operations are performed by specifying the
<code class="docutils literal notranslate"><span class="pre">F2PY_REPORT_ON_ARRAY_COPY=1</span></code> flag (see the build settings in the output of the
<code class="docutils literal notranslate"><span class="pre">micc-build</span></code> command.</p>
<p>If you are bothered by having to type <code class="docutils literal notranslate"><span class="pre">et_dot.dotf.my_f90_module.</span></code> every time,
use this Python trick, which creates an alias for the Fortran object
<code class="docutils literal notranslate"><span class="pre">et_dot.dotf.my_f90_module</span></code>:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">et_dot</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f90</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotf</span><span class="o">.</span><span class="n">my_f90_module</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">f90</span><span class="o">.</span><span class="n">dotf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="mf">12.0</span>
</pre></div>
</div>
<p>You can eve create an alias for the <code class="xref py py-obj docutils literal notranslate"><span class="pre">dotf</span></code> function itself:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">et_dot</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dotf</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotf</span><span class="o">.</span><span class="n">my_f90_module</span><span class="o">.</span><span class="n">dotf</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">dotf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="mf">12.0</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="controlling-the-build-intermediate">
<span id="control-build-f90"></span><h4>2.3.2 Controlling the build [intermediate]<a class="headerlink" href="#controlling-the-build-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>The build parameters for our Fortran binary extension module are detailed in
the file <code class="file docutils literal notranslate"><span class="pre">et_dot/f90_dotf/CMakeLists.txt</span></code>. It is a rather lengthy file,
but most of it is boilerplate code which you should not need to touch. The
boilerplate sections are clearly marked. By default this file specifies that
a release version is to be built. The file documents a set of CMake variables
that can be used to control the build type:</p>
<ul class="simple">
<li><p>CMAKE_BUILD_TYPE : DEBUG | MINSIZEREL | RELEASE* | RELWITHDEBINFO</p></li>
<li><p>F2PY_noopt : turn off optimization options</p></li>
<li><p>F2PY_noarch : turn off architecture specific optimization options</p></li>
<li><p>F2PY_f90flags : additional compiler options</p></li>
<li><p>F2PY_arch : architecture specific optimization options</p></li>
<li><p>F2PY_opt : optimization options</p></li>
</ul>
<p>In addition you can specify</p>
<ul class="simple">
<li><p>preprocessor macro definitions</p></li>
<li><p>include directories</p></li>
<li><p>link directories</p></li>
<li><p>link libraries</p></li>
</ul>
<p>Here are the sections of <code class="file docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> to control the build. Uncomment
the parts you need and modify them to your needs.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span>...
# Set the build type:
#  - If you do not specify a build type, it is RELEASE by default.
#  - Note that the DEBUG build type will trigger f2py&#39;s &#39;--noopt --noarch --debug&#39; options.
# set(CMAKE_BUILD_TYPE DEBUG | MINSIZEREL | RELEASE | RELWITHDEBINFO)

#&lt;&lt; begin boilerplate code
    ...
#&gt;&gt; end boilerplate code

##################################################################################
####################################################### Customization section ####
# Specify compiler options #######################################################
# Uncomment to turn off optimization:
# set(F2PY_noopt 1)

# Uncomment to turn off architecture specific optimization:
# set(F2PY_noarch 1)

# Set additional f90 compiler flags:
# set(F2PY_f90flags your_flags_here)

# Set architecture specific optimization compiler flags:
# set(F2PY_arch your_flags_here)

# Overwrite optimization flags
# set(F2PY_opt your_flags_here)

# Add preprocessor macro definitions ###############################################################
# add_compile_definitions(
#     OPENFOAM=1912                     # set value
#     WM_LABEL_SIZE=$ENV{WM_LABEL_SIZE} # set value from environment variable
#     WM_DP                             # just define the macro
# )

# Add include directories ##########################################################################
# include_directories(
#     path/to/dir1
#     path/to/dir2
# )

# Add link directories #############################################################################
# link_directories(
#     path/to/dir1
# )

# Add link libraries (lib1 -&gt; liblib1.so) ##########################################################
# link_libraries(
#     lib1
#     lib2
# )
####################################################################################################

# only boilerplate code below
...
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="building-binary-extensions-from-c">
<span id="building-cpp"></span><h3>2.4 Building binary extensions from C++<a class="headerlink" href="#building-binary-extensions-from-c" title="Permalink to this headline">¶</a></h3>
<p>To illustrate building binary extension modules from C++ code, let us also create a
C++ implementation for the dot product. Such modules are called <em>cpp modules</em>.
Analogously to our <code class="xref py py-mod docutils literal notranslate"><span class="pre">dotf</span></code> module we will call the cpp module <code class="xref py py-mod docutils literal notranslate"><span class="pre">dotc</span></code>,
the <code class="docutils literal notranslate"><span class="pre">c</span></code> referring to C++.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">add</span></code> command to add a cpp module:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc add dotc --cpp
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">[</span> Adding cpp module dotc to project ET-dot.
<span class="o">[</span>INFO<span class="o">]</span>               - C++ <span class="nb">source</span> <span class="k">in</span>           ET-dot/et_dot/cpp_dotc/dotc.cpp.
<span class="o">[</span>INFO<span class="o">]</span>               - module documentation <span class="k">in</span> ET-dot/et_dot/cpp_dotc/dotc.rst <span class="o">(</span><span class="k">in</span> restructuredText format<span class="o">)</span>.
<span class="o">[</span>INFO<span class="o">]</span>               - Python <span class="nb">test</span> code <span class="k">in</span>     ET-dot/tests/test_cpp_dotc.py.
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">]</span> <span class="k">done</span>.
</pre></div>
</div>
<p>The output explains you where to add the C++ source code, the test code and the
documentation.  Note that this time there is no warning about dependencies being
added, because we took already care of that when we added the Fortran module
<code class="xref py py-mod docutils literal notranslate"><span class="pre">dotf</span></code> above (see <a class="reference internal" href="#building-f90"><span class="std std-ref">2.3 Building binary extensions from Fortran</span></a>).</p>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> uses <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a> to create wrappers for C++ functions. This
is by far the most practical choice for this (see
<a class="reference external" href="https://channel9.msdn.com/Events/CPP/CppCon-2016/CppCon-2016-Introduction-to-C-python-extensions-and-embedding-Python-in-C-Apps">https://channel9.msdn.com/Events/CPP/CppCon-2016/CppCon-2016-Introduction-to-C-python-extensions-and-embedding-Python-in-C-Apps</a>
for a good overview of this topic). It has a lot of ‘automagical’ features, and
it is a header-only C++ library.
<a class="reference external" href="https://www.boost.org/doc/libs/1_70_0/libs/python/doc/html/index.html">Boost.Python</a>
offers very similar features, but is not header-only and its library depends on
the python version you want to use - so you need a build a  different library for every
Python version you want to use.</p>
<p>Enter this code in the C++ source file <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/cpp_dotc/dotc.cpp</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pybind11/numpy.h&gt;</span><span class="cp"></span>

<span class="kt">double</span>
<span class="nf">dotc</span><span class="p">(</span> <span class="n">pybind11</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">a</span>
    <span class="p">,</span> <span class="n">pybind11</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">b</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">bufa</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
       <span class="p">,</span> <span class="n">bufb</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
       <span class="p">;</span>
 <span class="c1">// verify dimensions and shape:</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">bufa</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">bufb</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Number of dimensions must be one&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">bufa</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bufb</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Input shapes must match&quot;</span><span class="p">);</span>
    <span class="p">}</span>
 <span class="c1">// provide access to raw memory</span>
 <span class="c1">// because the Numpy arrays are mutable by default, py::array_t is mutable too.</span>
 <span class="c1">// Below we declare the raw C++ arrays for x and y as const to make their intent clear.</span>
    <span class="kt">double</span> <span class="k">const</span> <span class="o">*</span><span class="n">ptra</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span> <span class="k">const</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">bufa</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">double</span> <span class="k">const</span> <span class="o">*</span><span class="n">ptrb</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span> <span class="k">const</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">bufb</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

    <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bufa</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="n">ptra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ptrb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// describe what goes in the module</span>
<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">dotc</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="c1">// m is variable, holding the module description</span>
                         <span class="c1">// dotc is the module&#39;s name</span>
<span class="p">{</span><span class="c1">// optional module docstring:</span>
    <span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s">&quot;pybind11 dotc plugin&quot;</span><span class="p">;</span>
 <span class="c1">// list the functions you want to expose:</span>
 <span class="c1">// m.def(&quot;exposed_name&quot;, function_pointer, &quot;doc-string for the exposed function&quot;);</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;dotc&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dotc</span><span class="p">,</span> <span class="s">&quot;The dot product of two arrays &#39;a&#39; and &#39;b&#39;.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Obviously the C++ source code is more involved than its Fortran equivalent in the
previous section. This is because <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> is a program performing clever introspection
into the Fortran source code, whereas <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a> is “nothing” but a C++ template library.
As such it is not capable of introspection and the user is obliged to use
<a class="reference external" href="https://pybind11.readthedocs.io/en/stable/">pybind11</a> for accessing the arguments passed in by Python. At the cost of being more
verbose, it is more flexible.</p>
<p>We can now build the module. Because we do not want to rebuild the <code class="xref py py-mod docutils literal notranslate"><span class="pre">dotf</span></code> module
we add <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">dotc</span></code> to the command line, to indicate that only module <code class="xref py py-mod docutils literal notranslate"><span class="pre">dotc</span></code> must
be built:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">micc</span> <span class="n">build</span> <span class="o">-</span><span class="n">m</span> <span class="n">dotc</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">[</span> <span class="n">Building</span> <span class="n">cpp</span> <span class="n">module</span> <span class="s1">&#39;dotc&#39;</span><span class="p">:</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">[</span> <span class="o">&gt;</span> <span class="n">cmake</span> <span class="o">-</span><span class="n">D</span> <span class="n">PYTHON_EXECUTABLE</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span> <span class="o">-</span><span class="n">D</span> <span class="n">pybind11_DIR</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pybind11</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">cmake</span><span class="o">/</span><span class="n">pybind11</span> <span class="o">-</span><span class="n">D</span> <span class="n">CMAKE_BUILD_TYPE</span><span class="o">=</span><span class="n">RELEASE</span> <span class="o">..</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>              <span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                       <span class="o">--</span> <span class="n">Found</span> <span class="n">pybind11</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pybind11</span><span class="o">/</span><span class="n">include</span> <span class="p">(</span><span class="n">found</span> <span class="n">version</span> <span class="s2">&quot;2.6.1&quot;</span> <span class="p">)</span>
                       <span class="o">--</span> <span class="n">Configuring</span> <span class="n">done</span>
                       <span class="o">--</span> <span class="n">Generating</span> <span class="n">done</span>
                       <span class="o">--</span> <span class="n">Build</span> <span class="n">files</span> <span class="n">have</span> <span class="n">been</span> <span class="n">written</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">cpp_dotc</span><span class="o">/</span><span class="n">_cmake_build</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>              <span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
                       <span class="n">pybind11_DIR</span> <span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">pybind11</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">cmake</span><span class="o">/</span><span class="n">pybind11</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">[</span> <span class="o">&gt;</span> <span class="n">make</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>              <span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                       <span class="n">Scanning</span> <span class="n">dependencies</span> <span class="n">of</span> <span class="n">target</span> <span class="n">dotc</span>
                       <span class="p">[</span> <span class="mi">50</span><span class="o">%</span><span class="p">]</span> <span class="n">Building</span> <span class="n">CXX</span> <span class="nb">object</span> <span class="n">CMakeFiles</span><span class="o">/</span><span class="n">dotc</span><span class="o">.</span><span class="n">dir</span><span class="o">/</span><span class="n">dotc</span><span class="o">.</span><span class="n">cpp</span><span class="o">.</span><span class="n">o</span>
                       <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">Linking</span> <span class="n">CXX</span> <span class="n">shared</span> <span class="n">module</span> <span class="n">dotc</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
                       <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">Built</span> <span class="n">target</span> <span class="n">dotc</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">[</span> <span class="o">&gt;</span> <span class="n">make</span> <span class="n">install</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>              <span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                       <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">Built</span> <span class="n">target</span> <span class="n">dotc</span>
                       <span class="n">Install</span> <span class="n">the</span> <span class="n">project</span><span class="o">...</span>
                       <span class="o">--</span> <span class="n">Install</span> <span class="n">configuration</span><span class="p">:</span> <span class="s2">&quot;RELEASE&quot;</span>
                       <span class="o">--</span> <span class="n">Installing</span><span class="p">:</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">cpp_dotc</span><span class="o">/../</span><span class="n">dotc</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span>          <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="p">]</span> <span class="n">done</span><span class="o">.</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="n">Binary</span> <span class="n">extensions</span> <span class="n">built</span> <span class="n">successfully</span><span class="p">:</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span>           <span class="o">-</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">et_dot</span><span class="o">/</span><span class="n">dotc</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>The output shows that first <code class="docutils literal notranslate"><span class="pre">CMake</span></code> is called, followed by <code class="docutils literal notranslate"><span class="pre">make</span></code> and the installation
of the binary extension with a soft link. Finally, lists of modules that have been built
successfully, and modules that failed to build are output.</p>
<p>As for the Fortran case, the <code class="docutils literal notranslate"><span class="pre">micc-build</span></code> command produces a lot of output, most of
which is rather uninteresting - except in the case of errors. If the source file does
not have any syntax errors, and the build did not experience any problems, you will
also see a file like <code class="file docutils literal notranslate"><span class="pre">dotc.cpython-38-darwin.so</span></code> in directory <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot</span></code>,
which is the binary extension module that we can import in Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="n">et_dot</span>
<span class="n">total</span> <span class="mi">8</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span>  <span class="mi">1</span> <span class="n">etijskens</span>  <span class="n">staff</span>  <span class="mi">1339</span> <span class="n">Dec</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">40</span> <span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">4</span> <span class="n">etijskens</span>  <span class="n">staff</span>   <span class="mi">128</span> <span class="n">Dec</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">29</span> <span class="n">__pycache__</span><span class="o">/</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">7</span> <span class="n">etijskens</span>  <span class="n">staff</span>   <span class="mi">224</span> <span class="n">Dec</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">43</span> <span class="n">cpp_dotc</span><span class="o">/</span>
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">etijskens</span>  <span class="n">staff</span>    <span class="mi">93</span> <span class="n">Dec</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">43</span> <span class="n">dotc</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
<span class="n">lrwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">etijskens</span>  <span class="n">staff</span>    <span class="mi">94</span> <span class="n">Dec</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">27</span> <span class="n">dotf</span><span class="o">.</span><span class="n">cpython</span><span class="o">-</span><span class="mi">38</span><span class="o">-</span><span class="n">darwin</span><span class="o">.</span><span class="n">so</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">6</span> <span class="n">etijskens</span>  <span class="n">staff</span>   <span class="mi">192</span> <span class="n">Dec</span> <span class="mi">13</span> <span class="mi">14</span><span class="p">:</span><span class="mi">43</span> <span class="n">f90_dotf</span><span class="o">/</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The extension of the module <code class="file docutils literal notranslate"><span class="pre">dotc.cpython-38-darwin.so</span></code>
will depend on the Python version you are using, and on the operating system.</p>
</div>
<p>Here is the test code. It is almost exactly the same as that for the f90 module <code class="xref py py-mod docutils literal notranslate"><span class="pre">dotf</span></code>,
except for the module name. Enter the test code in <code class="file docutils literal notranslate"><span class="pre">ET-dot/tests/test_cpp_dotc.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">et_dot</span>
<span class="c1"># create alias to dotc binary extension module:</span>
<span class="n">cpp</span> <span class="o">=</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotc</span>

<span class="k">def</span> <span class="nf">test_dotc_aa</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="c1"># call function dotc in the binary extension module:</span>
    <span class="n">a_dotc_a</span> <span class="o">=</span> <span class="n">cpp</span><span class="o">.</span><span class="n">dotc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a_dotc_a</span><span class="o">==</span><span class="n">expected</span>
</pre></div>
</div>
<p>The conversion between the Numpy arrays to C++ arrays is here less magical, as the user
must provide code to do the conversion of Python variables to C++. This has the advantage
of showing the mechanics of the conversion more clearly, but it also leaves more space for
mistakes, and to beginners it may seem more complicated.</p>
<p>Finally, run pytest:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nv">pytest</span>
<span class="o">================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=================================</span>
platform darwin -- Python <span class="m">3</span>.7.4, pytest-4.6.5, py-1.8.0, pluggy-0.13.0
rootdir: /Users/etijskens/software/dev/workspace/ET-dot
collected <span class="m">9</span> items

tests/test_cpp_dotc.py .                                                       <span class="o">[</span> <span class="m">11</span>%<span class="o">]</span>
tests/test_et_dot.py .......                                                   <span class="o">[</span> <span class="m">88</span>%<span class="o">]</span>
tests/test_f90_dotf.py .                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==============================</span> <span class="m">9</span> passed <span class="k">in</span> <span class="m">0</span>.28 <span class="nv">seconds</span> <span class="o">==============================</span>
</pre></div>
</div>
<div class="section" id="control-build-cpp">
<span id="id7"></span><h4>2.4.1 Controlling the build [intermediate]<a class="headerlink" href="#control-build-cpp" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>The build parameters for our C++ binary extension module are detailed in
the file <code class="file docutils literal notranslate"><span class="pre">et_dot/cpp_dotc/CMakeLists.txt</span></code>. It contains significantly
less boilerplate code (which you should not need to touch), and provides
the same functionality as its counterpart for Fortran binary extension
modules. By default this file specifies that a release version is to be built.
Here is the section of <code class="file docutils literal notranslate"><span class="pre">et_dot/cpp_dotc/CMakeLists.txt</span></code> that you might
want to adjust to your needs:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c">###############################################################################</span>
<span class="c">#################################################### Customization section ####</span>
<span class="c"># set compiler:</span>
<span class="c"># set(CMAKE_CXX_COMPILER path/to/executable)</span>

<span class="c"># Set build type:</span>
<span class="c"># set(CMAKE_BUILD_TYPE DEBUG | MINSIZEREL | RELEASE | RELWITHDEBINFO)</span>

<span class="c"># Add compiler options:</span>
<span class="c"># set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} &lt;additional C++ compiler options&gt;&quot;)</span>

<span class="c"># Add preprocessor macro definitions:</span>
<span class="c"># add_compile_definitions(</span>
<span class="c">#     OPENFOAM=1912                     # set value</span>
<span class="c">#     WM_LABEL_SIZE=$ENV{WM_LABEL_SIZE} # set value from environment variable</span>
<span class="c">#     WM_DP                             # just define the macro</span>
<span class="c"># )</span>

<span class="c"># Add include directories</span>
<span class="c">#include_directories(</span>
<span class="c">#     path/to/dir1</span>
<span class="c">#     path/to/dir2</span>
<span class="c"># )</span>

<span class="c"># Add link directories</span>
<span class="c"># link_directories(</span>
<span class="c">#     path/to/dir1</span>
<span class="c"># )</span>

<span class="c"># Add link libraries (lib1 -&gt; liblib1.so)</span>
<span class="c"># link_libraries(</span>
<span class="c">#     lib1</span>
<span class="c">#     lib2</span>
<span class="c"># )</span>
<span class="c">####################################################################################################</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="data-type-issues">
<span id="data-types"></span><h3>2.5 Data type issues<a class="headerlink" href="#data-type-issues" title="Permalink to this headline">¶</a></h3>
<p>When interfacing several programming languages data types require special care.</p>
<div class="section" id="corresponding-data-types-intermediate">
<span id="corresponding-data-types"></span><h4>2.5.1 Corresponding data types [intermediate]<a class="headerlink" href="#corresponding-data-types-intermediate" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>An important point of attention when writing binary extension modules - and a
common source of problems - is that the data types of the variables passed in from
Python must match the data types of the Fortran or C++ routines.</p>
<p>Here is a table with the most relevant numeric data types in Python, Fortran and C++.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 21%" />
<col style="width: 16%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>data type</p></th>
<th class="head"><p>Numpy/Python</p></th>
<th class="head"><p>Fortran</p></th>
<th class="head"><p>C++</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>unsigned integer</p></td>
<td><p>uint32</p></td>
<td><p>N/A</p></td>
<td><p>signed long int</p></td>
</tr>
<tr class="row-odd"><td><p>unsigned integer</p></td>
<td><p>uint64</p></td>
<td><p>N/A</p></td>
<td><p>signed long long int</p></td>
</tr>
<tr class="row-even"><td><p>signed integer</p></td>
<td><p>int32</p></td>
<td><p>integer*4</p></td>
<td><p>signed long int</p></td>
</tr>
<tr class="row-odd"><td><p>signed integer</p></td>
<td><p>int64</p></td>
<td><p>integer*8</p></td>
<td><p>signed long long int</p></td>
</tr>
<tr class="row-even"><td><p>floating point</p></td>
<td><p>float32</p></td>
<td><p>real*4</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-odd"><td><p>floating point</p></td>
<td><p>float64</p></td>
<td><p>real*8</p></td>
<td><p>double</p></td>
</tr>
<tr class="row-even"><td><p>complex</p></td>
<td><p>complex64</p></td>
<td><p>complex*4</p></td>
<td><p>std::complex&lt;float&gt;</p></td>
</tr>
<tr class="row-odd"><td><p>complex</p></td>
<td><p>complex128</p></td>
<td><p>complex*8</p></td>
<td><p>std::complex&lt;double&gt;</p></td>
</tr>
</tbody>
</table>
<p>If there is automatic conversion between two data types in Python, e.g. from
<code class="docutils literal notranslate"><span class="pre">float32</span></code> to <code class="docutils literal notranslate"><span class="pre">float64</span></code> the wrappers around our function will perform the
conversion automatically. This happens both for Fortran and C++. However, this
comes with the cost of copying and converting, which is sometimes not acceptable.</p>
</div></blockquote>
</div>
<div class="section" id="returning-large-data-structures-advanced">
<span id="return-large"></span><h4>2.5.2 Returning large data structures [advanced]<a class="headerlink" href="#returning-large-data-structures-advanced" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>The result of a Fortran function and a C++ function in a binary extension module
is <strong>always</strong> copied back to the Python variable that will hold it. As copying
large data structures is detrimental to performance this shoud be avoided.
The solution to this problem is to write Fortran functions or subroutines and C++
functions that accept the result variable as an argument and modify it in place,
so that the copy operaton is avoided. Consider this example of a Fortran subroutine
that computes the sum of two arrays.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">sumab</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
  <span class="c">! Compute the sum of arrays a and b and overwrite array sumab with the result</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="o">*</span><span class="mi">4</span>              <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>   <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>   <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sumab</span>

  <span class="c">! declare local variables</span>
    <span class="kt">integer</span><span class="o">*</span><span class="mi">4</span> <span class="kd">::</span> <span class="n">i</span>

    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
        <span class="n">sumab</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">end do</span>
<span class="k">end subroutine </span><span class="n">add</span>
</pre></div>
</div>
<p>The crucial issue here is that the result array <code class="docutils literal notranslate"><span class="pre">sumab``*</span></code> has <code class="docutils literal notranslate"><span class="pre">intent(inout)</span></code>,
meaning that the <code class="docutils literal notranslate"><span class="pre">add</span></code> function has both read and write access to it. If
you qualify the intent of <em>sumab</em> as <code class="docutils literal notranslate"><span class="pre">in</span></code> you will not be able to overwrite it. That
is, obviously ok for the input parameters <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>. On the other hand and rather
surprisingly, qualifying it with <code class="docutils literal notranslate"><span class="pre">intent(out)</span></code> forces <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> to consider the
variable as a left hand side variable and define a wrapper like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sumab</span> <span class="o">=</span> <span class="n">wrapper_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>and, consequently, imply copying of the result variable.
While <code class="docutils literal notranslate"><span class="pre">intent(out)</span></code> would certainly ok in Fortran-only code, and the semantics of
the <a class="reference external" href="https://docs.scipy.org/doc/numpy/f2py/">f2py</a> interpretation is certainly correct, copying the result variable may have
unwanted an performance impact.</p>
<p>So, the general advice is: use functions to return only variables of small size, like
single number, or a tuple, maybe even a small fixed size array, but certainly not a
large array. If you have result variables of large size, compute them in place in
parameters with <code class="docutils literal notranslate"><span class="pre">intent(inout)</span></code>. If there is no useful small variable to return,
use a subroutine instead of a function.</p>
<p>It is often useful to have functions return an error code, or the CPU time the
computation used, as in the code below:</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">sumab</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
  <span class="c">! Compute the sum of arrays a and b and overwrite array sumab with the result</span>
  <span class="c">! Return the CPU time consumed in seconds.</span>
    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span><span class="o">*</span><span class="mi">4</span>              <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span><span class="p">,</span><span class="n">add</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>   <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>   <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sumab</span>

  <span class="c">! declare local variables</span>
    <span class="kt">integer</span><span class="o">*</span><span class="mi">4</span> <span class="kd">::</span> <span class="n">i</span>
    <span class="kt">real</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">start</span><span class="p">,</span> <span class="n">finish</span>

    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
        <span class="n">sumab</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="k">end do</span>
<span class="k">    call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">finish</span><span class="p">)</span>

    <span class="n">add</span> <span class="o">=</span> <span class="n">finish</span><span class="o">-</span><span class="n">start</span>

<span class="k">end function </span><span class="n">add</span>
</pre></div>
</div>
<p>Note that Python does not require you to store the return value of a function.
The above <code class="docutils literal notranslate"><span class="pre">add</span></code> function might be called as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">et_dot</span>
<span class="c1"># create an alias for the add function:</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">my_package</span><span class="o">.</span><span class="n">binextf90</span><span class="o">.</span><span class="n">add</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">3.</span><span class="p">])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">])</span>
<span class="n">sumab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
<span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sumab</span><span class="p">)</span> <span class="c1"># ignore the cpu time returned by add.</span>
<span class="n">cput</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sumab</span><span class="p">)</span> <span class="c1"># this time don&#39;t ignore it.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cput</span><span class="p">)</span>
</pre></div>
</div>
<p>Computing large arrays in placee can be accomplished in C++ quite similarly:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;pybind11/pybind11.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pybind11/numpy.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">pybind11</span><span class="p">;</span>

<span class="kt">void</span>
<span class="nf">add</span> <span class="p">(</span> <span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">a</span>
    <span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">b</span>
    <span class="p">,</span> <span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">sumab</span>
    <span class="p">)</span>
<span class="p">{</span><span class="c1">// request buffer description of the arguments</span>
    <span class="k">auto</span> <span class="n">buf_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
       <span class="p">,</span> <span class="n">buf_b</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
       <span class="p">,</span> <span class="n">buf_sumab</span> <span class="o">=</span> <span class="n">sumab</span><span class="p">.</span><span class="n">request</span><span class="p">()</span>
       <span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">buf_a</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span>
     <span class="o">||</span> <span class="n">buf_b</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span>
     <span class="o">||</span> <span class="n">buf_sumab</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Number of dimensions must be one&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">buf_a</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">buf_b</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
     <span class="o">||</span> <span class="p">(</span><span class="n">buf_a</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">buf_sumab</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Input shapes must match&quot;</span><span class="p">);</span>
    <span class="p">}</span>
 <span class="c1">// because the Numpy arrays are mutable by default, py::array_t is mutable too.</span>
 <span class="c1">// Below we declare the raw C++ arrays for a and b as const to make their intent clear.</span>
    <span class="kt">double</span> <span class="k">const</span> <span class="o">*</span><span class="n">ptr_a</span>     <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span> <span class="k">const</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">buf_a</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">double</span> <span class="k">const</span> <span class="o">*</span><span class="n">ptr_b</span>     <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span> <span class="k">const</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">buf_b</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">double</span>       <span class="o">*</span><span class="n">ptr_sumab</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span>       <span class="o">*&gt;</span><span class="p">(</span><span class="n">buf_sumab</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_a</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">ptr_sumab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptr_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ptr_b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>


<span class="n">PYBIND11_MODULE</span><span class="p">({{</span> <span class="n">cookiecutter</span><span class="p">.</span><span class="n">module_name</span> <span class="p">}},</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span><span class="c1">// optional module doc-string</span>
    <span class="n">m</span><span class="p">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s">&quot;pybind11 {{ cookiecutter.module_name }} plugin&quot;</span><span class="p">;</span> <span class="c1">// optional module docstring</span>
 <span class="c1">// list the functions you want to expose:</span>
 <span class="c1">// m.def(&quot;exposed_name&quot;, function_pointer, &quot;doc-string for the exposed function&quot;);</span>
    <span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;add&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">,</span> <span class="s">&quot;A function which adds two arrays &#39;a&#39; and &#39;b&#39; and stores the result in the third, &#39;sumab&#39;.&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, care must be taken that when casting <code class="docutils literal notranslate"><span class="pre">buf_sumab.ptr</span></code> one does not cast to const.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="documenting-binary-extension-modules">
<span id="document-binext"></span><h3>2.6 Documenting binary extension modules<a class="headerlink" href="#documenting-binary-extension-modules" title="Permalink to this headline">¶</a></h3>
<p>For Python modules the documentation is automatically extracted from the doc-strings
in the module. However, when it comes to documenting binary extension modules, this
does not seem a good option. Ideally, the source files <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/f90_dotf/dotf.f90</span></code>
and <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/cpp_dotc/dotc.cpp</span></code> should document the Fortran functions and
subroutines, and C++ functions, respectively, rahter than the Python interface. Yet
from the perspective of ET-dot being a Python project, the users is only interested
in the documentation of the Python interface to those functions and subroutines.
Therefore, <a class="reference external" href="https://micc.readthedocs.io">micc</a> requires you to document the Python interface in separate <code class="file docutils literal notranslate"><span class="pre">.rst</span></code>
files:</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/f90_dotf/dotf.rst</span></code></p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/cpp_dotc/dotc.rst</span></code></p></li>
</ul>
<p>Here are the contents, respectively, for <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/f90_dotf/dotf.rst</span></code>:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="gh">Module et_dot.dotf</span>
<span class="gh">******************</span>

Module <span class="na">:py:mod:</span><span class="nv">`dotf`</span> built from fortran code in <span class="na">:file:</span><span class="nv">`f90_dotf/dotf.f90`</span>.

<span class="p">..</span> <span class="ow">function</span><span class="p">::</span> dotf(a,b)
   <span class="nc">:module:</span> et_dot.dotf

   Compute the dot product of <span class="ge">*a*</span> and <span class="ge">*b*</span> (in Fortran.)

   <span class="nc">:param a:</span> 1D Numpy array with <span class="s">``dtype=numpy.float64``</span>
   <span class="nc">:param b:</span> 1D Numpy array with <span class="s">``dtype=numpy.float64``</span>
   <span class="nc">:returns:</span> the dot product of <span class="ge">*a*</span> and <span class="ge">*b*</span>
   <span class="nc">:rtype:</span> <span class="s">``numpy.float64``</span>
</pre></div>
</div>
<p>and for <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/cpp_dotc/dotc.rst</span></code>:</p>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="gh">Module et_dot.dotc</span>
<span class="gh">******************</span>

Module <span class="na">:py:mod:</span><span class="nv">`dotc`</span> built from fortran code in <span class="na">:file:</span><span class="nv">`cpp_dotc/dotc.cpp`</span>.

<span class="p">..</span> <span class="ow">function</span><span class="p">::</span> dotc(a,b)
   <span class="nc">:module:</span> et_dot.dotc

   Compute the dot product of <span class="ge">*a*</span> and <span class="ge">*b*</span> (in C++.)

   <span class="nc">:param a:</span> 1D Numpy array with <span class="s">``dtype=numpy.float64``</span>
   <span class="nc">:param b:</span> 1D Numpy array with <span class="s">``dtype=numpy.float64``</span>
   <span class="nc">:returns:</span> the dot product of <span class="ge">*a*</span> and <span class="ge">*b*</span>
   <span class="nc">:rtype:</span> <span class="s">``numpy.float64``</span>
</pre></div>
</div>
<p>Note that the documentation must be entirely in <code class="file docutils literal notranslate"><span class="pre">.rst</span></code> format (see
<a class="reference external" href="http://www.sphinx-doc.org/en/master/usage/restructuredtext/index.html">restructuredText</a>).</p>
<p>Build the documentation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">cd</span> <span class="n">docs</span> <span class="o">&amp;&amp;</span> <span class="n">make</span> <span class="n">html</span>
<span class="n">Already</span> <span class="n">installed</span><span class="p">:</span> <span class="n">click</span>
<span class="n">Already</span> <span class="n">installed</span><span class="p">:</span> <span class="n">sphinx</span><span class="o">-</span><span class="n">click</span>
<span class="n">Already</span> <span class="n">installed</span><span class="p">:</span> <span class="n">sphinx</span>
<span class="n">Already</span> <span class="n">installed</span><span class="p">:</span> <span class="n">sphinx</span><span class="o">-</span><span class="n">rtd</span><span class="o">-</span><span class="n">theme</span>
<span class="n">Running</span> <span class="n">Sphinx</span> <span class="n">v2</span><span class="o">.</span><span class="mf">2.2</span>
<span class="n">making</span> <span class="n">output</span> <span class="n">directory</span><span class="o">...</span> <span class="n">done</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="n">html_static_path</span> <span class="n">entry</span> <span class="s1">&#39;_static&#39;</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span>
<span class="n">building</span> <span class="p">[</span><span class="n">mo</span><span class="p">]:</span> <span class="n">targets</span> <span class="k">for</span> <span class="mi">0</span> <span class="n">po</span> <span class="n">files</span> <span class="n">that</span> <span class="n">are</span> <span class="n">out</span> <span class="n">of</span> <span class="n">date</span>
<span class="n">building</span> <span class="p">[</span><span class="n">html</span><span class="p">]:</span> <span class="n">targets</span> <span class="k">for</span> <span class="mi">7</span> <span class="n">source</span> <span class="n">files</span> <span class="n">that</span> <span class="n">are</span> <span class="n">out</span> <span class="n">of</span> <span class="n">date</span>
<span class="n">updating</span> <span class="n">environment</span><span class="p">:</span> <span class="p">[</span><span class="n">new</span> <span class="n">config</span><span class="p">]</span> <span class="mi">7</span> <span class="n">added</span><span class="p">,</span> <span class="mi">0</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">removed</span>
<span class="n">reading</span> <span class="n">sources</span><span class="o">...</span> <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">readme</span>
<span class="n">looking</span> <span class="k">for</span> <span class="n">now</span><span class="o">-</span><span class="n">outdated</span> <span class="n">files</span><span class="o">...</span> <span class="n">none</span> <span class="n">found</span>
<span class="n">pickling</span> <span class="n">environment</span><span class="o">...</span> <span class="n">done</span>
<span class="n">checking</span> <span class="n">consistency</span><span class="o">...</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">apps</span><span class="o">.</span><span class="n">rst</span><span class="p">:</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">document</span> <span class="n">isn</span><span class="s1">&#39;t included in any toctree</span>
<span class="n">done</span>
<span class="n">preparing</span> <span class="n">documents</span><span class="o">...</span> <span class="n">done</span>
<span class="n">writing</span> <span class="n">output</span><span class="o">...</span> <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">readme</span>
<span class="n">generating</span> <span class="n">indices</span><span class="o">...</span>  <span class="n">genindex</span> <span class="n">py</span><span class="o">-</span><span class="n">modindexdone</span>
<span class="n">highlighting</span> <span class="n">module</span> <span class="n">code</span><span class="o">...</span> <span class="p">[</span><span class="mi">100</span><span class="o">%</span><span class="p">]</span> <span class="n">et_dot</span><span class="o">.</span><span class="n">dotc</span>
<span class="n">writing</span> <span class="n">additional</span> <span class="n">pages</span><span class="o">...</span>  <span class="n">search</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">etijskens</span><span class="o">/</span><span class="n">software</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">sphinx_rtd_theme</span><span class="o">/</span><span class="n">search</span><span class="o">.</span><span class="n">html</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span> <span class="n">RemovedInSphinx30Warning</span><span class="p">:</span> <span class="n">To</span> <span class="n">modify</span> <span class="n">script_files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">theme</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="o">.</span> <span class="n">Please</span> <span class="n">insert</span> <span class="n">a</span> <span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span> <span class="n">tag</span> <span class="n">directly</span> <span class="ow">in</span> <span class="n">your</span> <span class="n">theme</span> <span class="n">instead</span><span class="o">.</span>
  <span class="p">{{</span> <span class="nb">super</span><span class="p">()</span> <span class="p">}}</span>
<span class="n">done</span>
<span class="n">copying</span> <span class="n">static</span> <span class="n">files</span><span class="o">...</span> <span class="o">...</span> <span class="n">done</span>
<span class="n">copying</span> <span class="n">extra</span> <span class="n">files</span><span class="o">...</span> <span class="n">done</span>
<span class="n">dumping</span> <span class="n">search</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">English</span> <span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="n">en</span><span class="p">)</span><span class="o">...</span> <span class="n">done</span>
<span class="n">dumping</span> <span class="nb">object</span> <span class="n">inventory</span><span class="o">...</span> <span class="n">done</span>
<span class="n">build</span> <span class="n">succeeded</span><span class="p">,</span> <span class="mi">2</span> <span class="n">warnings</span><span class="o">.</span>

<span class="n">The</span> <span class="n">HTML</span> <span class="n">pages</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">_build</span><span class="o">/</span><span class="n">html</span><span class="o">.</span>
</pre></div>
</div>
<p>The documentation is built using <code class="docutils literal notranslate"><span class="pre">make</span></code>. The <code class="file docutils literal notranslate"><span class="pre">Makefile</span></code> checks that the necessary components
<a class="reference external" href="http://www.sphinx-doc.org/en/master/">sphinx</a>, <a class="reference external" href="https://click.palletsprojects.com/en/7.x/">click</a>, sphinx-click_and <a class="reference external" href="https://sphinx-rtd-theme.readthedocs.io/en/stable/">sphinx-rtd-theme</a> are installed.</p>
<p>You can view the result in your favorite browser:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">open</span> <span class="n">_build</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>The filepath is made evident from the last output line above.
This is what the result looks like (html):</p>
<img alt="_images/img2-1.png" src="_images/img2-1.png" />
</div>
</div>
<div class="section" id="tutorial-3-adding-python-components">
<h2>Tutorial 3: Adding Python components<a class="headerlink" href="#tutorial-3-adding-python-components" title="Permalink to this headline">¶</a></h2>
<div class="section" id="adding-a-python-module">
<h3>3.1 Adding a Python module<a class="headerlink" href="#adding-a-python-module" title="Permalink to this headline">¶</a></h3>
<p>Just as one can add binary extension modules to a package, one can add python modules.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc add foo --py

<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">[</span> Adding python module foo.py to project ET-dot.
<span class="o">[</span>INFO<span class="o">]</span>               - python <span class="nb">source</span> <span class="k">in</span>    ET-doc/et_doc/foo.py.
<span class="o">[</span>INFO<span class="o">]</span>               - Python <span class="nb">test</span> code <span class="k">in</span> ET-doc/tests/test_foo.py.
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">]</span> <span class="k">done</span>.
</pre></div>
</div>
<p>This adds a Python sub-module to the package, and a test script for it. The documentation
for the sub-module is extracted from doc-strings of the functions and classes in
the sub-module.</p>
<p>As with <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">create</span></code> the default structure is that of a simple module, i.e.
<code class="file docutils literal notranslate"><span class="pre">ET-doc/et_doc/foo.py</span></code>. If you want a package you can add the <code class="docutils literal notranslate"><span class="pre">--package</span></code>
flag.</p>
<div class="section" id="testing-the-module">
<h4>Testing the module<a class="headerlink" href="#testing-the-module" title="Permalink to this headline">¶</a></h4>
<p>When adding a module <code class="xref py py-mod docutils literal notranslate"><span class="pre">foo</span></code>, <a class="reference external" href="https://micc.readthedocs.io">Micc</a> automacally adds a test script for the new module:
<code class="file docutils literal notranslate"><span class="pre">tests/test_foo,py</span></code>. In this file you add tests for module <code class="xref py py-mod docutils literal notranslate"><span class="pre">foo</span></code>.</p>
</div>
<div class="section" id="documenting-the-module">
<h4>Documenting the module<a class="headerlink" href="#documenting-the-module" title="Permalink to this headline">¶</a></h4>
<p>When adding a module <code class="xref py py-mod docutils literal notranslate"><span class="pre">foo</span></code>, <a class="reference external" href="https://micc.readthedocs.io">Micc</a> automatically adds documentation entries
in <code class="file docutils literal notranslate"><span class="pre">API.rst</span></code>. Calling <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">docs</span></code> will automatically extract documentation from
the doc-strings in your new module.</p>
</div>
</div>
<div class="section" id="adding-a-python-command-line-interface">
<h3>3.2 Adding a Python Command Line Interface<a class="headerlink" href="#adding-a-python-command-line-interface" title="Permalink to this headline">¶</a></h3>
<p><em>Command Line Interfaces</em> are Python scripts that you want to be installed as
executable programs when a user installs your package. E.g. <a class="reference external" href="https://micc.readthedocs.io">micc</a> is a CLI</p>
<p>As an example, assume that we need quite often to read two arrays from file and
compute their dot product, and that we want to execute this operation as:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; dot-files file1 file2
dot<span class="o">(</span>file1,file2<span class="o">)</span> <span class="o">=</span> <span class="m">123</span>.456
&gt;
</pre></div>
</div>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> supports two kinds of CLIs, both based on <a class="reference external" href="https://click.palletsprojects.com/en/7.x/">click</a>, a very practical tool for building
Python CLIs. The first one is for CLIs that execute a single task, the second one for
a command with sub-commands, like <a class="reference external" href="https://git-scm.com">git</a> or <a class="reference external" href="https://micc.readthedocs.io">micc</a> itself. The single task case is the
default, so we can create it like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc app dot-files
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">[</span> Adding CLI dot-files without sub-commands to project ET-dot.
<span class="o">[</span>INFO<span class="o">]</span>               - Python <span class="nb">source</span> file ET-dot/et_dot/cli_dot-files.py.
<span class="o">[</span>INFO<span class="o">]</span>               - Python <span class="nb">test</span> code   ET-dot/tests/test_cli_dot-files.py.
<span class="o">[</span>INFO<span class="o">]</span>           <span class="o">]</span> <span class="k">done</span>.
</pre></div>
</div>
<p>For a CLI with sub-commands one should add the flag <code class="docutils literal notranslate"><span class="pre">--sub-commands</span></code>.</p>
<p>The source code <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/cli_dot_files.py</span></code> should be modified as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Command line interface dot-files (no sub-commands).&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">et_dot.dotf</span> <span class="kn">import</span> <span class="n">dotf</span>

<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;file1&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;file2&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbosity&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span>
             <span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The verbosity of the CLI.&quot;</span>
             <span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span>
             <span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span><span class="n">file2</span><span class="p">,</span><span class="n">verbosity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Command line interface dot-files.</span>

<span class="sd">    A &#39;hello&#39; world CLI example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">dotf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dot-files(</span><span class="si">{</span><span class="n">file1</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">file2</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">ab</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>  <span class="c1"># pragma: no cover</span>
</pre></div>
</div>
<p>Here’s how to use it from the command line (without installing):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nb">source</span> .venv/bin/activate
<span class="o">(</span>.venv<span class="o">)</span> &gt; cat file1.txt
<span class="m">1</span>,2,3,4,5
&gt; cat file2.txt
<span class="m">2</span>,2,2,2,2
<span class="o">(</span>.venv<span class="o">)</span> &gt; python et_dot/cli_dot_files.py file1.txt file2.txt
<span class="m">30</span>.0
<span class="o">(</span>.venv<span class="o">)</span> &gt; python et_dot/cli_dot_files.py file1.txt file2.txt -vv
dot-files<span class="o">(</span>file1.txt,file2.txt<span class="o">)</span> <span class="o">=</span> <span class="m">30</span>.0
</pre></div>
</div>
<div class="section" id="testing-the-application">
<h4>Testing the application<a class="headerlink" href="#testing-the-application" title="Permalink to this headline">¶</a></h4>
<p>When you add an a application like <code class="docutils literal notranslate"><span class="pre">dot-files</span></code> <a class="reference external" href="https://micc.readthedocs.io">Micc</a> automatically adds a test script
<code class="file docutils literal notranslate"><span class="pre">tests/test_cli_dot_files.py</span></code> where you can add your tests.
Testing CLIs is a bit more complex than testing modules, but <a class="reference external" href="https://click.palletsprojects.com/en/7.x/">Click</a> provides some tools
for <a class="reference external" href="https://click.palletsprojects.com/en/7.x/testing/">Testing click applications</a>.
Here is the test code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">click.testing</span> <span class="kn">import</span> <span class="n">CliRunner</span>

<span class="kn">from</span> <span class="nn">et_dot.cli_dot_files</span> <span class="kn">import</span> <span class="n">main</span>

<span class="k">def</span> <span class="nf">test_main</span><span class="p">():</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">CliRunner</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span><span class="s1">&#39;file2.txt&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># ignore the line feed character</span>
    <span class="k">assert</span> <span class="n">ab</span><span class="o">==</span><span class="mf">30.0</span>
</pre></div>
</div>
<p>Finally, we run <a class="reference external" href="https://pytest.org/en/latest/">pytest</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; <span class="nv">pytest</span>
<span class="o">=================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=================================</span>
platform darwin -- Python <span class="m">3</span>.7.4, pytest-4.6.5, py-1.8.0, pluggy-0.13.0
rootdir: /Users/etijskens/software/dev/workspace/ET-dot
collected <span class="m">10</span> items

tests/test_cli_dot-files.py .                                                   <span class="o">[</span> <span class="m">10</span>%<span class="o">]</span>
tests/test_cpp_dotc.py .                                                        <span class="o">[</span> <span class="m">20</span>%<span class="o">]</span>
tests/test_et_dot.py .......                                                    <span class="o">[</span> <span class="m">90</span>%<span class="o">]</span>
tests/test_f90_dotf.py .                                                       <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==================================</span> <span class="m">10</span> passed <span class="k">in</span> <span class="m">0</span>.33 <span class="nv">seconds</span> <span class="o">==========================</span>
</pre></div>
</div>
</div>
<div class="section" id="documenting-an-application">
<h4>Documenting an application<a class="headerlink" href="#documenting-an-application" title="Permalink to this headline">¶</a></h4>
<p>When adding a CLI, <a class="reference external" href="https://micc.readthedocs.io">Micc</a> automatically adds documentation entries for it in <code class="file docutils literal notranslate"><span class="pre">APPS.rst</span></code>.
The documentation will be automatically extracted from the doc-strings of the command and
sub-commands and from the <code class="docutils literal notranslate"><span class="pre">help</span></code> parameters of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">click.option</span></code> decorators.</p>
</div>
</div>
</div>
<div class="section" id="tutorial-4-version-control-and-version-management">
<span id="tutorial-4"></span><h2>Tutorial 4: Version control and version management<a class="headerlink" href="#tutorial-4-version-control-and-version-management" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> support the use of <a class="reference external" href="https://git-scm.com">git</a> for version control. Check out <a class="reference external" href="https://git-scm.com">https://git-scm.com</a> for
documentation of git.</p>
<div class="section" id="git-support">
<span id="id8"></span><h3>4.1 Git support<a class="headerlink" href="#git-support" title="Permalink to this headline">¶</a></h3>
<p>When you create a new project, <a class="reference external" href="https://micc.readthedocs.io">Micc</a> immediately provides a local <a class="reference external" href="https://git-scm.com">git</a> repository for
you and commits the initial files <a class="reference external" href="https://micc.readthedocs.io">Micc</a> set up for you. If you have a <a class="reference external" href="https://github.com">github</a> account you
can register it in the preferences file <code class="file docutils literal notranslate"><span class="pre">~/.micc/micc.json</span></code>, using the
<code class="docutils literal notranslate"><span class="pre">github_username</span></code> entry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="o">...</span>
<span class="p">,</span> <span class="s2">&quot;github_username&quot;</span>  <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span><span class="s2">&quot;etijskens&quot;</span>
                       <span class="p">,</span><span class="s2">&quot;text&quot;</span>   <span class="p">:</span><span class="s2">&quot;your github username&quot;</span>
                       <span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> cannot create a remote <a class="reference external" href="https://github.com">github</a> repository for you,
but if you registered your <a class="reference external" href="https://github.com">github</a> username in the preferences file, it will add
a remote origin at <code class="docutils literal notranslate"><span class="pre">https://github.com/etijskens/&lt;your_project_name&gt;/</span></code>, and
try to push the files to the <a class="reference external" href="https://github.com">github</a> repo. If you have created the remote repository
before you create the project, the new project will be immediately pushed onto
the remote origin. Otherwise, you get a warning that the remote repository does not
yet exist. You can create the remote repository whenever you like and push your work
onto the remote repository using the <a class="reference external" href="https://git-scm.com">git</a> CLI.</p>
</div>
<div class="section" id="version-management">
<span id="id9"></span><h3>4.2 Version management<a class="headerlink" href="#version-management" title="Permalink to this headline">¶</a></h3>
<p>Version numbers are practical, even for a small software project used only by
yourself. For larger projects, certainly when other users start using them,
they become indispensable. When giving version numbers to a project, we highly
recommend to follow the guidelines <a class="reference external" href="https://semver.org">Semantic Versioning 2.0</a>.
Such a version number consists of <code class="docutils literal notranslate"><span class="pre">Major.minor.patch</span></code>. According to
semantic versioning you should increment the:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Major</span></code> version when you make incompatible API changes,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minor</span></code> version when you add functionality in a backwards compatible manner, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">patch</span></code> version when you make backwards compatible bug fixes.</p></li>
</ul>
<p><a class="reference external" href="https://micc.readthedocs.io">Micc</a> sets a version number of 0.0.0 when it creates a project, and you can bump the
version number at any time with the <code class="docutils literal notranslate"><span class="pre">micc</span> <span class="pre">version</span></code> command.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc info
Project ET-dot located at /Users/etijskens/software/dev/workspace/ET-dot
  package: et_dot
  version: <span class="m">0</span>.0.0
  structure: et_dot/__init__.py <span class="o">(</span>Python package<span class="o">)</span>
  contents:
    application cli_dot_files.py
    C++ module  cpp_dotc/dotc.cpp
    f90 module  f90_dotf/dotf.f90
</pre></div>
</div>
<p>To bump the patch component:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc version
Project <span class="o">(</span>ET-dot version <span class="o">(</span><span class="m">0</span>.0.0<span class="o">)</span>
&gt; micc version --patch
<span class="o">[</span>INFO<span class="o">]</span>           bumping version <span class="o">(</span><span class="m">0</span>.0.0<span class="o">)</span> -&gt; <span class="o">(</span><span class="m">0</span>.0.1<span class="o">)</span>
</pre></div>
</div>
<p>Again, with the short version of <code class="docutils literal notranslate"><span class="pre">--patch</span></code> and verbose this time, :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc -vv version -p
<span class="o">[</span>DEBUG<span class="o">]</span> <span class="nv">start</span> <span class="o">=</span> <span class="m">2019</span>-10-16 <span class="m">13</span>:18:16.995416
<span class="o">[</span>INFO<span class="o">]</span>           bumping version <span class="o">(</span><span class="m">0</span>.0.1<span class="o">)</span> -&gt; <span class="o">(</span><span class="m">0</span>.0.2<span class="o">)</span>
<span class="o">[</span>DEBUG<span class="o">]</span>          . Updated <span class="o">(</span>/Users/etijskens/software/dev/workspace/ET-dot/pyproject.toml<span class="o">)</span>
<span class="o">[</span>DEBUG<span class="o">]</span>          . Updated <span class="o">(</span>/Users/etijskens/software/dev/workspace/ET-dot/et_dot/__init__.py<span class="o">)</span>
<span class="o">[</span>DEBUG<span class="o">]</span> <span class="nv">stop</span>  <span class="o">=</span> <span class="m">2019</span>-10-16 <span class="m">13</span>:18:17.261962
<span class="o">[</span>DEBUG<span class="o">]</span> <span class="nv">spent</span> <span class="o">=</span> <span class="m">0</span>:00:00.266546
</pre></div>
</div>
<p>Here, you can see that <a class="reference external" href="https://micc.readthedocs.io">micc</a> updated the version number in <code class="file docutils literal notranslate"><span class="pre">ET-dot/pyproject.toml</span></code>
and <code class="file docutils literal notranslate"><span class="pre">ET-dot/et_dot/__init__.py</span></code>.</p>
<p>To bump the minor component use the <code class="docutils literal notranslate"><span class="pre">--minor</span></code> or <code class="docutils literal notranslate"><span class="pre">-m</span></code> flag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc version -m
<span class="o">[</span>INFO<span class="o">]</span>           bumping version <span class="o">(</span><span class="m">0</span>.0.2<span class="o">)</span> -&gt; <span class="o">(</span><span class="m">0</span>.1.0<span class="o">)</span>
</pre></div>
</div>
<p>As you can see the patch component is reset to 0.</p>
<p>To bump the major component use the <code class="docutils literal notranslate"><span class="pre">--major</span></code> or <code class="docutils literal notranslate"><span class="pre">-M</span></code> flag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc version -M
<span class="o">[</span>INFO<span class="o">]</span>           bumping version <span class="o">(</span><span class="m">0</span>.1.0<span class="o">)</span> -&gt; <span class="o">(</span><span class="m">1</span>.0.0<span class="o">)</span>
</pre></div>
</div>
<p>As you can see the minor component (as well as the patch component) is reset to 0.</p>
<p>The micc version command has a <code class="docutils literal notranslate"><span class="pre">--tag</span></code> flag that creates a <a class="reference external" href="https://git-scm.com">git</a> tag (see
<a class="reference external" href="https://git-scm.com/book/en/v2/Git-Basics-Tagging">https://git-scm.com/book/en/v2/Git-Basics-Tagging</a>) and trys</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc -vv version -p --tag
<span class="o">[</span>DEBUG<span class="o">]</span> <span class="nv">start</span> <span class="o">=</span> <span class="m">2019</span>-10-16 <span class="m">13</span>:37:25.026161
<span class="o">[</span>INFO<span class="o">]</span>           bumping version <span class="o">(</span><span class="m">1</span>.0.1<span class="o">)</span> -&gt; <span class="o">(</span><span class="m">1</span>.0.2<span class="o">)</span>
<span class="o">[</span>DEBUG<span class="o">]</span>          . Updated <span class="o">(</span>/Users/etijskens/software/dev/workspace/ET-dot/pyproject.toml<span class="o">)</span>
<span class="o">[</span>DEBUG<span class="o">]</span>          . Updated <span class="o">(</span>/Users/etijskens/software/dev/workspace/ET-dot/et_dot/__init__.py<span class="o">)</span>
<span class="o">[</span>INFO<span class="o">]</span>           Creating git tag v1.0.2 <span class="k">for</span> project ET-dot
<span class="o">[</span>DEBUG<span class="o">]</span>          Running <span class="s1">&#39;git tag -a v1.0.2 -m &quot;tag version 1.0.2&quot;&#39;</span>
<span class="o">[</span>DEBUG<span class="o">]</span>
<span class="o">[</span>DEBUG<span class="o">]</span>          Pushing tag v1.0.2 <span class="k">for</span> project ET-dot
<span class="o">[</span>DEBUG<span class="o">]</span>          Running <span class="s1">&#39;git push origin v1.0.2&#39;</span>
<span class="o">[</span>DEBUG<span class="o">]</span>          remote: Repository not found.
                   fatal: repository <span class="s1">&#39;https://github.com/etijskens/ET-dot/&#39;</span> not found
<span class="o">[</span>INFO<span class="o">]</span>           Done.
<span class="o">[</span>DEBUG<span class="o">]</span> <span class="nv">stop</span>  <span class="o">=</span> <span class="m">2019</span>-10-16 <span class="m">13</span>:37:26.101959
<span class="o">[</span>DEBUG<span class="o">]</span> <span class="nv">spent</span> <span class="o">=</span> <span class="m">0</span>:00:01.075798
</pre></div>
</div>
<p>If you created a remote <a class="reference external" href="https://github.com">github</a> repository for your project and registered
your <a class="reference external" href="https://github.com">github</a> username in the preferences file, the tag is pushed to the remote origin.</p>
</div>
</div>
<div class="section" id="tutorial-5-publishing-your-code">
<span id="tutorial-5"></span><h2>Tutorial 5 - Publishing your code<a class="headerlink" href="#tutorial-5-publishing-your-code" title="Permalink to this headline">¶</a></h2>
<p>Publishing your code is an easy way to make your code available to other users.</p>
<div class="section" id="publishing-to-the-python-package-index">
<h3>5.1 Publishing to the Python Package Index<a class="headerlink" href="#publishing-to-the-python-package-index" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://python-poetry.org/">Poetry</a> provides really easy interface to publishing your code to the Python Package
Index (<a class="reference external" href="https://pypi.org">PyPI</a>). If you do not have a <a class="reference external" href="https://pypi.org">PyPI</a>  account, create one and
run this command in a project directory, say <code class="file docutils literal notranslate"><span class="pre">et-foo</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">cd</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">et</span><span class="o">-</span><span class="n">foo</span>
<span class="o">&gt;</span> <span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">poetry</span> <span class="n">publish</span> <span class="o">--</span><span class="n">build</span>
<span class="n">Building</span> <span class="n">et</span><span class="o">-</span><span class="n">foo</span> <span class="p">(</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">Building</span> <span class="n">sdist</span>
 <span class="o">-</span> <span class="n">Built</span> <span class="n">et</span><span class="o">-</span><span class="n">foo</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="mf">0.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>

 <span class="o">-</span> <span class="n">Building</span> <span class="n">wheel</span>
 <span class="o">-</span> <span class="n">Built</span> <span class="n">et_foo</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span>

<span class="n">Publishing</span> <span class="n">et</span><span class="o">-</span><span class="n">foo</span> <span class="p">(</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">to</span> <span class="n">PyPI</span>
<span class="n">Username</span><span class="p">:</span> <span class="n">etijskens</span>
<span class="n">Password</span><span class="p">:</span>

 <span class="o">-</span> <span class="n">Uploading</span> <span class="n">et</span><span class="o">-</span><span class="n">foo</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="mf">0.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="mi">100</span><span class="o">%</span>
 <span class="o">-</span> <span class="n">Uploading</span> <span class="n">et_foo</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="mi">100</span><span class="o">%</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is crucial that your project name is not already taken. For this reason,
we recommend that</p>
<ol class="arabic simple">
<li><p>before you create a project that you might want to publish, you check wether
your project name is not already taken. This is easily done by adding the
<code class="docutils literal notranslate"><span class="pre">--publish</span></code> flag when creating a project. If the name is taken you get a
warning and the project is not created.</p></li>
<li><p>immediately after your project is created, you publish the empty, as to reserve
the name forever.</p></li>
</ol>
</div>
<p>After the project is published, everyone can install the package in his current Python
environment as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">et</span><span class="o">-</span><span class="n">foo</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="publishing-packages-with-binary-extension-modules">
<h3>5.2 Publishing packages with binary extension modules<a class="headerlink" href="#publishing-packages-with-binary-extension-modules" title="Permalink to this headline">¶</a></h3>
<p>Packages with binary extension modules are published in exactly the same way. That is,
perhaps surprisingly, as a Python-only project. When you <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> a <a class="reference external" href="https://micc.readthedocs.io">Micc</a> project
the package directory will end up in the <code class="file docutils literal notranslate"><span class="pre">site-packages</span></code> directory of the Python
environment in which you install. The source code directories of the binary extensions
modules are installed with the package, but without the binary extensions themselves.
These must be compiled locally. Fortunately that happens automatically, at least if the
binary extension were added to the package by <a class="reference external" href="https://micc.readthedocs.io">Micc</a>. When <a class="reference external" href="https://micc.readthedocs.io">Micc</a> adds a binary extension
to a project, two thing happen:</p>
<ul class="simple">
<li><p>a dependency on <a class="reference external" href="https://github.com/etijskens/et-micc-build">micc-build</a> is added to the project, and</p></li>
<li><p>in the top-level module <code class="xref py py-mod docutils literal notranslate"><span class="pre">&lt;package_name&gt;/__init__.py</span></code> a <code class="xref py py-obj docutils literal notranslate"><span class="pre">try-except</span></code>
block is added that tries to import the binary extension and in case of failure
(<code class="xref py py-exc docutils literal notranslate"><span class="pre">ModuleNotFoundError</span></code>) will attempt to build it using the machinery provided
by <a class="reference external" href="https://github.com/etijskens/et-micc-build">micc-build</a>. This will usually succeed, provided the necessary compilers are available
and there are no syntax errors.</p></li>
</ul>
<p>As an example, let us create a project <em>foo</em> with a binary extension module <em>bar</em> written
in C++</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; micc -p Foo create
&gt; <span class="nb">cd</span> auto-build
&gt; micc add bar --cpp
</pre></div>
</div>
<p>This creates this <code class="file docutils literal notranslate"><span class="pre">Foo/foo/__init__.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Package foo</span>
<span class="sd">===========</span>

<span class="sd">Top-level package for foo.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">.</span><span class="mi">0</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">foo.bar</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Try to build this binary extension:</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="kn">import</span> <span class="nn">click</span>
    <span class="kn">from</span> <span class="nn">et_micc_build.cli_micc_build</span> <span class="kn">import</span> <span class="n">auto_build_binary_extension</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">auto_build_binary_extension</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">foo.bar</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;bright_red&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If the first <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">foo.bar</span></code> fails, the <code class="docutils literal notranslate"><span class="pre">except</span></code> block imports the method
<code class="xref py py-meth docutils literal notranslate"><span class="pre">auto_build_binary_extension()</span></code> and executes it to build the binary extension
module <code class="xref py py-mod docutils literal notranslate"><span class="pre">bar</span></code>. If the build succeeds, the <code class="xref py py-obj docutils literal notranslate"><span class="pre">msg</span></code> string is empty and
<code class="xref py py-mod docutils literal notranslate"><span class="pre">foo.bar</span></code> is imported at last, otherwise the error message <code class="xref py py-obj docutils literal notranslate"><span class="pre">msg</span></code>
is printed.</p>
</div>
<div class="section" id="publishing-your-documentation-on-readthedocs-org">
<h3>5.4 Publishing your documentation on readthedocs.org<a class="headerlink" href="#publishing-your-documentation-on-readthedocs-org" title="Permalink to this headline">¶</a></h3>
<p>Publishing your documentation to <a class="reference external" href="https://readthedocs.org">Readthedocs</a> relieves the users of your
code from having to build documentation themselves. Making it happen is very easy. First, make sure
the git repository of your code is pushed on <a class="reference external" href="https://github.com">Github</a>. Second, create a <a class="reference external" href="https://readthedocs.org">Readthedocs</a> account if you
do not already have one. Then, go to your <a class="reference external" href="https://readthedocs.org">Readthedocs</a> page, go to <em>your projects</em> and hit import
project. Fill in the fields and every time you push commits to <a class="reference external" href="https://github.com">Github</a> its documentation will be
rebuild automatically and published.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sphinx must be able to import your project in order to extract the documentation.
If your codes depend on Python modules other than the standard library, this will fail and
the documentation will not be built. You can add the necessary dependencies to
<code class="file docutils literal notranslate"><span class="pre">&lt;your-project&gt;/docs/requirements.txt</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="tutorial-6-using-micc-projects-on-the-vsc-clusters">
<span id="tutorial-6"></span><h2>Tutorial 6 - Using micc projects on the VSC clusters<a class="headerlink" href="#tutorial-6-using-micc-projects-on-the-vsc-clusters" title="Permalink to this headline">¶</a></h2>
<p>This tutorial uses the Leibniz cluster of the University of Antwerp for the
examples. The principles pertain, however, to all VSC clusters, and most probably
also to other clusters using a module system for exposing its software stack.</p>
<p>Most differences between using your local machine or a cluster stem from these
facts:</p>
<blockquote>
<div><ul class="simple">
<li><p>a cluster is mainly a console based system accessed by the user on a login-node,</p></li>
<li><p>a <em>scheduler</em> determines when your compute jobs are executed on one or more
compute-nodes,</p></li>
<li><p>a <em>module</em> system is used for making software available, both on the login-nodes
and on the compute-nodes.</p></li>
</ul>
</div></blockquote>
<p>The cluster’s module system has the largest impact, so let us look at this first.</p>
<div class="section" id="accessing-the-cluster">
<h3>6.1 Accessing the cluster<a class="headerlink" href="#accessing-the-cluster" title="Permalink to this headline">¶</a></h3>
<p>Accessing a login-node of a <a class="reference external" href="https://vscentrum.be">VSC</a> cluster is detailed in the <a class="reference external" href="https://vscentrum.be">VSC</a> documentation
<a class="reference external" href="https://vlaams-supercomputing-centrum-vscdocumentation.readthedocs-hosted.com/en/latest/access/access_and_data_transfer.html#logging-in-to-a-cluster">Logging in to a cluster</a>.
By following the procedure, you get a console window (or a terminal, or a command prompt)
connected to one of the login-nodes of the cluster:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; ssh -i path/to/my_key my_vsc_userid@login1-leibniz.hpc.uantwerpen.be
Last login: Wed Jan 13 08:52:51 2021 from 91.179.29.29

--------------------------------------------------------------------

Welcome to LEIBNIZ !

Useful links:
  https://vscdocumentation.readthedocs.io
  https://vscdocumentation.readthedocs.io/en/latest/antwerp/tier2_hardware.html
  https://www.uantwerpen.be/hpc

Questions or problems? Do not hesitate and contact us:
  hpc@uantwerpen.be

Happy computing!
&gt;
</pre></div>
</div>
</div>
<div class="section" id="using-modules">
<h3>6.2 Using modules<a class="headerlink" href="#using-modules" title="Permalink to this headline">¶</a></h3>
<p>The module system of the <a class="reference external" href="https://vscentrum.be">VSC</a> clusters is explained in the VSC documentation
<a class="reference external" href="https://vlaams-supercomputing-centrum-vscdocumentation.readthedocs-hosted.com/en/latest/software/software_stack.html#using-the-module-system">Using the module system</a>.</p>
<p>HPC packages are installed as modules (yet another kind of module) and to make
them accessible, they must be loaded. Loading a module means that your operating system’s
environment is modified such that it can find the software’s executables, that is, the
directories containing its executables are added to the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> variable. In addition,
other environment variables adjusted or added to make everything work smoothly.</p>
<p>E.g., to use a recent version of <a class="reference external" href="https://git-scm.com">git</a> we <code class="docutils literal notranslate"><span class="pre">load</span></code> the git module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">load</span> <span class="n">git</span>
<span class="o">&gt;</span> <span class="n">which</span> <span class="n">git</span>
<span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">antwerpen</span><span class="o">/</span><span class="n">broadwell</span><span class="o">/</span><span class="n">centos7</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="mf">2.13</span><span class="o">.</span><span class="mi">3</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">git</span>
<span class="o">&gt;</span> <span class="n">git</span> <span class="o">--</span><span class="n">version</span>
<span class="n">git</span> <span class="n">version</span> <span class="mf">2.13</span><span class="o">.</span><span class="mi">3</span>
<span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">&lt;cmd&gt;</span></code> command prints the location of the first occurrence of <code class="docutils literal notranslate"><span class="pre">&lt;cmd&gt;</span></code> on
the system path. Typically, commands of the operating system are found in <code class="docutils literal notranslate"><span class="pre">/usr/bin</span></code>. Commands
provided by some cluster module are, typically, found in <code class="docutils literal notranslate"><span class="pre">/apps/&lt;vsc-site&gt;/...</span></code>.</p>
<p>By not specifying a version in the <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span></code> command, we get the default git
module, which is usually the most recent installed version, in this case version 2.13.3.</p>
<p>Note that the operating system of the login-node also exposes a git version. If we
run the last two commands without the git module loaded, this is the result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">unload</span> <span class="n">git</span>
<span class="o">&gt;</span> <span class="n">which</span> <span class="n">git</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">git</span>
<span class="o">&gt;</span> <span class="n">git</span> <span class="o">--</span><span class="n">version</span>
<span class="n">git</span> <span class="n">version</span> <span class="mf">1.8</span><span class="o">.</span><span class="mf">3.1</span>
<span class="o">&gt;</span>
</pre></div>
</div>
<p>This is a much older version. The login-node’s operating system exposes several tools
we might need, like git, but also compilers, like <code class="docutils literal notranslate"><span class="pre">g++</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">which</span> <span class="n">g</span><span class="o">++</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">g</span><span class="o">++</span>
<span class="o">&gt;</span> <span class="n">g</span><span class="o">++</span> <span class="o">--</span><span class="n">version</span>
<span class="n">g</span><span class="o">++</span> <span class="p">(</span><span class="n">GCC</span><span class="p">)</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">5</span> <span class="mi">20150623</span> <span class="p">(</span><span class="n">Red</span> <span class="n">Hat</span> <span class="mf">4.8</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="mi">39</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The operating system tools usually lag many versions behind their current latest version,
e.g. the current latest <code class="docutils literal notranslate"><span class="pre">g++</span></code> version is  10.2! Although the operating system <code class="docutils literal notranslate"><span class="pre">g++</span></code>
is very reliable for building operating system components, it is not suited for building
C++ programs and librariees that must squeeze the last bit of performance out of the
cluster’s hardware. Obviously, this old g++ can impossibly be aware of modern hardware,
and, consequentially, cannot generate code that exploit all the modern hardware features
introduced for improving the performance of scientific computations. So as a rule of thumb:</p>
<blockquote>
<div><p><strong>Never use the tools provided by the operating system for building HPC software.</strong></p>
</div></blockquote>
<p>The VSC Team has installed many software packages ready to be used for high performance
computing. In fact, they are built using the modern compilers and with optimal performance
in mind. Contrary to what you are used to on your personal computer where installed software
packages are immediately accessible, on the cluster an extra step must be taken to
make installed packages accessible.</p>
<p>You can search for modules containing e.g. the word <code class="docutils literal notranslate"><span class="pre">gcc</span></code> (case insensitive):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">spider</span> <span class="n">gcc</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If you know the package name, you can list the available versions with <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">av</span></code>. Here are
the available Python versions (the command is case insensitive):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">av</span> <span class="n">python</span><span class="o">/</span>
<span class="o">...</span>
</pre></div>
</div>
<p>You can <code class="docutils literal notranslate"><span class="pre">unload</span></code> a module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">unload</span> <span class="n">git</span>
<span class="o">&gt;</span> <span class="n">which</span> <span class="n">git</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">git</span>
</pre></div>
</div>
<p>The current <code class="docutils literal notranslate"><span class="pre">git</span></code> command is that of the OS again.</p>
<p>You can unload all modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">purge</span>
</pre></div>
</div>
</div>
<div class="section" id="using-micc-on-the-cluster">
<h3>6.2 Using Micc on the cluster<a class="headerlink" href="#using-micc-on-the-cluster" title="Permalink to this headline">¶</a></h3>
<p>The tools we need as micc users are, typically:</p>
<ul class="simple">
<li><p>a modern Python version, e.g. 3.7 or later.</p></li>
<li><p>common Python packages for computing, like Numpy, scipy, matplotlib, …</p></li>
<li><p>Poetry, for dependency resolution, publishing to <a class="reference external" href="https://pypi.org">PyPI</a> and virtual environment creation</p></li>
<li><p>compilers for C++ and/or Fortran, for compiling binary extensions.</p></li>
<li><p>CMake, as the build system for C++ binary extensions.</p></li>
<li><p>git, for version control, if we are developing code on the cluster.</p></li>
</ul>
<p>and, of course</p>
<ul class="simple">
<li><p>micc, and</p></li>
<li><p>micc-build</p></li>
</ul>
<div class="section" id="python-and-python-packages">
<h4>6.2.1 Python and Python packages<a class="headerlink" href="#python-and-python-packages" title="Permalink to this headline">¶</a></h4>
<p>On Leibniz, two different Python distributions are available, each in several versions.
There is the standard Python distribution from python.org:</p>
<ul class="simple">
<li><p>Python/2.7.13-intel-2017a</p></li>
<li><p>Python/2.7.14-intel-2018a</p></li>
<li><p>Python/2.7.15-intel-2018b</p></li>
<li><p>Python/2.7.16-intel-2019b</p></li>
<li><p>Python/3.6.1-intel-2017a</p></li>
<li><p>Python/3.6.4-intel-2018a</p></li>
<li><p>Python/3.6.6-intel-2018a</p></li>
<li><p>Python/3.6.8-intel-2018b</p></li>
<li><p>Python/3.7.0-intel-2018b</p></li>
<li><p>Python/3.7.1-intel-2018b</p></li>
<li><p>Python/3.7.4-intel-2019b</p></li>
<li><p>Python/3.8.3-intel-2020a</p></li>
</ul>
<p>Each module specifies the Python version, and the compiler suite used to compile it.
E.g. Python/3.8.3-intel-2020a is Python version 3.8.3 compiled with the Intel compiler
suite 2020a. There is also the Intel Python distribution which has been compiled by
Intel specialists.</p>
<ul class="simple">
<li><p>IntelPython2/2019b -&gt; Python 2.7.16</p></li>
<li><p>IntelPython3/2019b -&gt; Python 3.6.9</p></li>
<li><p>IntelPython3/2020a -&gt; Python 3.7.7</p></li>
</ul>
<p>In most cases these cluster modules come with a whole bunch of preinstalled Python
packages useful for HPC, e.g. Numpy, scipy, and many others. For some the Python
packages are in a separate module:</p>
<ul class="simple">
<li><p>IntelPython3-Packages/2019b</p></li>
<li><p>IntelPython3-Packages/2020a-intel-2020a</p></li>
</ul>
<p>So to use the most recent Intel Python available with the packages, we must load:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">load</span> <span class="n">IntelPython3</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
<span class="o">&gt;</span> <span class="n">module</span> <span class="n">load</span> <span class="n">IntelPython3</span><span class="o">-</span><span class="n">Packages</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="section" id="using-poetry">
<h4>6.2.2 Using Poetry<a class="headerlink" href="#using-poetry" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://python-poetry.org/">Poetry</a> is, sofar, not available as a cluster module. If you insist on having it, you have
to install it yourself. Poetry wants to install itself only in <code class="file docutils literal notranslate"><span class="pre">$HOME/.poetry/bin</span></code>
which is in the <code class="file docutils literal notranslate"><span class="pre">$VSC_USER</span></code> filesytem where the file quota are a bit restrictive for
such installations. (It consumes more than 50% of your allowed number of files).
A more serious problem is that we noticed problems with dependency resolution. Poetry tends to
reinstall Python modules that are already installed as system site packages. This is not only a
waste of disk space, it replaces modules that are carefully compiled for optimal performance on
the cluster hardware, e.g. <a class="reference external" href="https://numpy.org">Numpy</a>, with standard compilations causing performance losses.
This is unacceptable. As a consequence we strongly advise against the use of poetry on
the VSC clusters, as long as <a class="reference external" href="https://python-poetry.org/">Poetry</a> fails to use system site packages. The consequences
of refraining from <a class="reference external" href="https://python-poetry.org/">Poetry</a> are not to hard:</p>
<ul class="simple">
<li><p>we must create our virtual environments ourselves,</p></li>
<li><p>we must manually install required Python modules that are not available in the system
site packages,</p></li>
<li><p>and we cannot publish.</p></li>
</ul>
<p>Although the latter seems very restrictive, if you put your project on github, you can always
check out the project on a desktop or laptop to publish it with Poetry. For the other two issues
a simple workaround is presented below:</p>
</div>
<div class="section" id="id10">
<h4>6.2.3 Creating virtual environments<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>Since for this we cannot rely on poetry, we must do it manually. This command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">venv</span> <span class="o">.</span><span class="n">venv</span> <span class="o">--</span><span class="n">system</span><span class="o">-</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
</pre></div>
</div>
<p>creates a virtual environment <code class="file docutils literal notranslate"><span class="pre">.venv</span></code> in the current working directory (typically
a project directory). The <code class="docutils literal notranslate"><span class="pre">--system-site-packages</span></code> flag ensures that system site packages
will be found by the <code class="docutils literal notranslate"><span class="pre">python</span></code> command. Otherwise, you will not be able to import numpy,
e.g.. As usual the virtual environment is activated as:</p>
<blockquote>
<div><p>&gt; source .venv/bin/activate
(.venv) &gt;</p>
</div></blockquote>
<p>With the <code class="docutils literal notranslate"><span class="pre">IntelPython3</span></code> and associated packages loaded as above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">which</span> <span class="n">python</span>
<span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">antwerpen</span><span class="o">/</span><span class="mi">201</span><span class="o">/</span><span class="n">vsc20170</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">ET</span><span class="o">-</span><span class="n">dot</span><span class="o">/.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">python</span> <span class="o">--</span><span class="n">version</span>
<span class="n">Python</span> <span class="mf">3.7</span><span class="o">.</span><span class="mi">7</span> <span class="p">::</span> <span class="n">Intel</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="n">Corporation</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">python</span></code> executable <code class="docutils literal notranslate"><span class="pre">/data/antwerpen/201/vsc20170/workspace/ET-dot/.venv/bin/python</span></code>
is in fact a soft link to the python of the cluster module <code class="docutils literal notranslate"><span class="pre">IntelPython3/2020a</span></code>. By
using soft links the virtual environment takes up very little disk space and very little
time to be created.</p>
</div>
<div class="section" id="installing-dependencies">
<h4>6.2.4 Installing dependencies<a class="headerlink" href="#installing-dependencies" title="Permalink to this headline">¶</a></h4>
<p>Since we cannot rely on poetry to install the dependencies of our project, we must
do it ourselves. If you follow the recommended workflow and first develop your project
on your own machine (where you can use <a class="reference external" href="https://python-poetry.org/">poetry</a>), and then port it to the cluster,
things are really easy:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>develop your project on your own personal computer.</p></li>
<li><p>when everything works, push your code to the project’s remote github repo.</p></li>
<li><p>clone the github repo on the cluster in your <code class="file docutils literal notranslate"><span class="pre">$VSC_DATA</span></code> filesystem.</p></li>
<li><p>create a virtual environment as detailed above in your project directory on
the cluster, and activate it.</p></li>
<li><p>check the <code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file for the dependencies and development
dependencies and run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span></code> for each of them.</p></li>
</ol>
</div></blockquote>
<p>You are now ready to test your project on the cluster.</p>
<p>Starting the development of your project on the cluster is not recommended, because
you can easily forget to update <code class="file docutils literal notranslate"><span class="pre">pyproject.toml</span></code> when adding dependencies.
Porting the project to your own machine will then not have the correct dependencies.</p>
<p>Having a system-wide <code class="docutils literal notranslate"><span class="pre">micc</span></code> on the cluster is not very practical. We recommend to
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">micc-build</span></code> or at least <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">micc</span></code> (if you do not need to
build binary extension modules) in your project’s virtual environment. To use micc
then, you must, obviously, activate the virtual environment.</p>
</div>
<div class="section" id="access-to-compilers">
<h4>6.2.5 Access to compilers<a class="headerlink" href="#access-to-compilers" title="Permalink to this headline">¶</a></h4>
<p>For building binary extension modules from Fortran micc-build needs access to a Fortran
compiler and a C compiler as well. For C++ binary extension modules access to a C++
compiler is needed. The above loaded <code class="docutils literal notranslate"><span class="pre">IntelPython3/2020a</span></code> module was compiled with the
Intel 2020a compiler toolchain so we must load:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">module</span> <span class="n">load</span> <span class="n">intel</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">which</span> <span class="n">ifort</span>
<span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">antwerpen</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">centos7</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">psxe</span><span class="o">/</span><span class="mf">2020.04</span><span class="o">/</span><span class="n">compilers_and_libraries_2020</span><span class="o">.</span><span class="mf">4.304</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">intel64</span><span class="o">/</span><span class="n">ifort</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">which</span> <span class="n">icc</span>
<span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">antwerpen</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">centos7</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">psxe</span><span class="o">/</span><span class="mf">2020.04</span><span class="o">/</span><span class="n">compilers_and_libraries_2020</span><span class="o">.</span><span class="mf">4.304</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">intel64</span><span class="o">/</span><span class="n">icc</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">which</span> <span class="n">icpc</span>
<span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">antwerpen</span><span class="o">/</span><span class="n">x86_64</span><span class="o">/</span><span class="n">centos7</span><span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">psxe</span><span class="o">/</span><span class="mf">2020.04</span><span class="o">/</span><span class="n">compilers_and_libraries_2020</span><span class="o">.</span><span class="mf">4.304</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">intel64</span><span class="o">/</span><span class="n">icpc</span>
<span class="p">(</span><span class="o">.</span><span class="n">venv</span><span class="p">)</span> <span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h4>6.2.6 CMake<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>CMake is available as a cluster module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">load</span> <span class="n">CMake</span>
<span class="o">&gt;</span> <span class="n">module</span> <span class="nb">list</span>

<span class="n">Currently</span> <span class="n">Loaded</span> <span class="n">Modules</span><span class="p">:</span>
  <span class="mi">1</span><span class="p">)</span> <span class="n">leibniz</span><span class="o">/</span><span class="n">supported</span>
  <span class="mi">2</span><span class="p">)</span> <span class="n">GCCcore</span><span class="o">/</span><span class="mf">9.3</span><span class="o">.</span><span class="mi">0</span>
  <span class="mi">3</span><span class="p">)</span> <span class="n">binutils</span><span class="o">/</span><span class="mf">2.34</span><span class="o">-</span><span class="n">GCCcore</span><span class="o">-</span><span class="mf">9.3</span><span class="o">.</span><span class="mi">0</span>
  <span class="mi">4</span><span class="p">)</span> <span class="n">IntelPython3</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">5</span><span class="p">)</span> <span class="n">intel</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">6</span><span class="p">)</span> <span class="n">baselibs</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">GCCcore</span><span class="o">-</span><span class="mf">9.3</span><span class="o">.</span><span class="mi">0</span>
  <span class="mi">7</span><span class="p">)</span> <span class="n">Tcl</span><span class="o">/</span><span class="mf">8.6</span><span class="o">.</span><span class="mi">10</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">8</span><span class="p">)</span> <span class="n">SQLite</span><span class="o">/</span><span class="mf">3.31</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">9</span><span class="p">)</span> <span class="n">HDF5</span><span class="o">/</span><span class="mf">1.10</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">MPI</span>
  <span class="mi">10</span><span class="p">)</span> <span class="n">buildtools</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">11</span><span class="p">)</span> <span class="n">IntelPython3</span><span class="o">-</span><span class="n">Packages</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">12</span><span class="p">)</span> <span class="n">CMake</span><span class="o">/</span><span class="mf">3.11</span><span class="o">.</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h4>6.2.6 Git<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>As said, git too is available as a cluster module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">module</span> <span class="n">load</span> <span class="n">git</span>
<span class="o">&gt;</span> <span class="n">module</span> <span class="nb">list</span>

<span class="n">Currently</span> <span class="n">Loaded</span> <span class="n">Modules</span><span class="p">:</span>
  <span class="mi">1</span><span class="p">)</span> <span class="n">leibniz</span><span class="o">/</span><span class="n">supported</span>
  <span class="mi">2</span><span class="p">)</span> <span class="n">GCCcore</span><span class="o">/</span><span class="mf">9.3</span><span class="o">.</span><span class="mi">0</span>
  <span class="mi">3</span><span class="p">)</span> <span class="n">binutils</span><span class="o">/</span><span class="mf">2.34</span><span class="o">-</span><span class="n">GCCcore</span><span class="o">-</span><span class="mf">9.3</span><span class="o">.</span><span class="mi">0</span>
  <span class="mi">4</span><span class="p">)</span> <span class="n">IntelPython3</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">5</span><span class="p">)</span> <span class="n">intel</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">6</span><span class="p">)</span> <span class="n">baselibs</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">GCCcore</span><span class="o">-</span><span class="mf">9.3</span><span class="o">.</span><span class="mi">0</span>
  <span class="mi">7</span><span class="p">)</span> <span class="n">Tcl</span><span class="o">/</span><span class="mf">8.6</span><span class="o">.</span><span class="mi">10</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">8</span><span class="p">)</span> <span class="n">SQLite</span><span class="o">/</span><span class="mf">3.31</span><span class="o">.</span><span class="mi">1</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">9</span><span class="p">)</span> <span class="n">HDF5</span><span class="o">/</span><span class="mf">1.10</span><span class="o">.</span><span class="mi">6</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">MPI</span>
  <span class="mi">10</span><span class="p">)</span> <span class="n">buildtools</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">11</span><span class="p">)</span> <span class="n">IntelPython3</span><span class="o">-</span><span class="n">Packages</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
  <span class="mi">12</span><span class="p">)</span> <span class="n">CMake</span><span class="o">/</span><span class="mf">3.11</span><span class="o">.</span><span class="mi">1</span>
  <span class="mi">13</span><span class="p">)</span> <span class="n">git</span><span class="o">/</span><span class="mf">2.13</span><span class="o">.</span><span class="mi">3</span>
</pre></div>
</div>
</div>
<div class="section" id="a-remark-on-the-order-of-things">
<h4>6.2.7 a remark on the order of things<a class="headerlink" href="#a-remark-on-the-order-of-things" title="Permalink to this headline">¶</a></h4>
<p>The first step when starting a cluster session on a login-node should always be to
load all modules you need, followed by activating the virtual environment of your
project. It is easy to forget things, so we recommend to put a bash script in your
project directory that does this. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup.sh script</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">git</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">CMake</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">IntelPython3</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">IntelPython3</span><span class="o">-</span><span class="n">Packages</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span><span class="o">-</span><span class="n">intel</span><span class="o">-</span><span class="mi">2020</span><span class="n">a</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">intel</span><span class="o">/</span><span class="mi">2020</span><span class="n">a</span>
<span class="n">module</span> <span class="nb">list</span>
<span class="n">source</span> <span class="o">.</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
</pre></div>
</div>
<p>As the script must be sourced to activate the virtual environment, it is better
not to make it executable, so you cannot forget to source it.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="links.html" class="btn btn-neutral float-right" title="Interesting links on Python programming" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="faq.html" class="btn btn-neutral float-left" title="Frequently asked questions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Engelbert Tijskens

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>